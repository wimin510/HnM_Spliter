<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ”¶æ”¯åˆ†æ”¤è¨ˆç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .user-id-display {
            word-break: break-all;
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-6 text-center">
            å®¶åº­æ”¶æ”¯åˆ†æ”¤è¨ˆç®—å™¨ (HnM Splitter)
        </h1>
        
        <!-- é¡¯ç¤ºç”¨æˆ¶ ID å’Œé€£ç·šç‹€æ…‹ -->
        <div id="status-card" class="card bg-white p-4 rounded-xl mb-6 border-l-4 border-indigo-500">
            <p class="text-sm font-semibold text-gray-700">é€£ç·šç‹€æ…‹: <span id="auth-status" class="text-yellow-600">é€£ç·šä¸­...</span></p>
            <p class="text-sm font-semibold text-gray-700 mt-1 user-id-display">ç”¨æˆ¶ID: <span id="current-user-id" class="text-gray-500 font-mono text-xs">ç­‰å¾…é©—è­‰...</span></p>
            <p class="text-xs text-indigo-500 mt-2">æ­¤IDç”¨æ–¼å…±äº«è³‡æ–™ï¼Œè«‹è¨˜ä½æˆ–å‘ŠçŸ¥æ‚¨çš„å¤¥ä¼´ã€‚</p>
        </div>

        <!-- æ–°å¢è²»ç”¨è¡¨å–® -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢ä¸€ç­†è²»ç”¨</h2>
            <form id="expense-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="description" placeholder="è²»ç”¨èªªæ˜ (ä¾‹å¦‚: æ™šé¤å¤–é€)" required
                       class="col-span-1 md:col-span-3 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <input type="number" id="amount" placeholder="é‡‘é¡ (TWD)" required min="0.01" step="0.01"
                       class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <select id="paid-by" required
                        class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="" disabled selected>èª°æ”¯ä»˜çš„ï¼Ÿ</option>
                    <option value="user">æˆ‘ (ç•¶å‰ç”¨æˆ¶)</option>
                    <option value="partner">å¤¥ä¼´</option>
                </select>

                <select id="split-type" required
                        class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="equal">å‡æ”¤</option>
                    <option value="user_pays">æˆ‘è² æ“”</option>
                    <option value="partner_pays">å¤¥ä¼´è² æ“”</option>
                </select>
                
                <button type="submit" id="submit-button"
                        class="col-span-1 md:col-span-3 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold shadow-md disabled:bg-indigo-300">
                    æ–°å¢è²»ç”¨
                </button>
            </form>
        </div>

        <!-- è²»ç”¨åˆ—è¡¨èˆ‡ç¸½çµ -->
        <div class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">è²»ç”¨æ˜ç´°èˆ‡çµç®—</h2>

            <!-- ç¸½çµå€å¡Š -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm font-medium text-indigo-600">ç¸½æ”¯å‡º</p>
                    <p id="total-spent" class="text-2xl font-bold text-indigo-800 mt-1">0.00 TWD</p>
                </div>
                <div id="settlement-summary" class="p-4 rounded-lg text-center transition-colors">
                    <p class="text-sm font-medium text-gray-600" id="settlement-label">çµç®—çµæœ</p>
                    <p id="settlement-amount" class="text-2xl font-bold mt-1 text-gray-800">0.00 TWD</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èªªæ˜</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¯ä»˜è€…</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æˆ‘è² æ“”</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤¥ä¼´è² æ“”</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list" class="bg-white divide-y divide-gray-200">
                        <!-- è²»ç”¨è³‡æ–™å°‡æœƒè¢« JavaScript æ¸²æŸ“åœ¨é€™è£¡ -->
                        <tr>
                            <td colspan="6" class="p-4 text-center text-gray-500 italic" id="loading-message">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- éŒ¯èª¤/æˆåŠŸè¨Šæ¯å½ˆçª— -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-3">è¨Šæ¯</h3>
            <p id="modal-content" class="text-gray-700 mb-4"></p>
            <button id="modal-close" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
        </div>
    </div>

    <!-- Main Application Logic (All in one module script) -->
    <script type="module">
        // åŒ¯å…¥ Firebase æ¨¡çµ„
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let auth = null;
        let userId = 'loading';
        let authReady = false;

        // å…¨åŸŸ helper å‡½å¼ï¼šé¡¯ç¤ºè‡ªè¨‚è¨Šæ¯è¦–çª— (å–ä»£ alert/confirm)
        function showMessage(title, content) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            modal.classList.remove('hidden');

            document.getElementById('modal-close').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // å‡½å¼ï¼šè¨ˆç®—ä¸¦æ›´æ–°çµç®—ç¸½çµ (èˆ‡ä¹‹å‰ç›¸åŒ)
        function updateSettlement(expenses) {
            let userPaidTotal = 0;
            let partnerPaidTotal = 0;
            let userOwed = 0;
            let partnerOwed = 0;

            expenses.forEach(exp => {
                if (exp.paidBy === 'user') {
                    userPaidTotal += exp.amount;
                } else if (exp.paidBy === 'partner') {
                    partnerPaidTotal += exp.amount;
                }

                if (exp.splitType === 'equal') {
                    const half = exp.amount / 2;
                    userOwed += half;
                    partnerOwed += half;
                } else if (exp.splitType === 'user_pays') {
                    userOwed += exp.amount;
                } else if (exp.splitType === 'partner_pays') {
                    partnerOwed += exp.amount;
                }
            });

            const totalSpent = userPaidTotal + partnerPaidTotal;
            document.getElementById('total-spent').textContent = `${totalSpent.toFixed(2)} TWD`;

            const netBalance = userPaidTotal - userOwed;
            const summaryEl = document.getElementById('settlement-summary');
            const labelEl = document.getElementById('settlement-label');
            const amountEl = document.getElementById('settlement-amount');

            summaryEl.className = summaryEl.className.replace(/bg-\w+-100|bg-\w+-50|border-green-600|border-red-600|bg-gray-100/g, '');

            if (netBalance > 0.01) {
                labelEl.textContent = 'å¤¥ä¼´æ‡‰ä»˜æˆ‘ (å¤šä»˜äº†)';
                amountEl.textContent = `${Math.abs(netBalance).toFixed(2)} TWD`;
                summaryEl.classList.add('bg-green-100', 'border-l-4', 'border-green-600');
                amountEl.classList.add('text-green-800');
                amountEl.classList.remove('text-red-800', 'text-gray-800');
            } else if (netBalance < -0.01) {
                labelEl.textContent = 'æˆ‘æ‡‰ä»˜å¤¥ä¼´ (å°‘ä»˜äº†)';
                amountEl.textContent = `${Math.abs(netBalance).toFixed(2)} TWD`;
                summaryEl.classList.add('bg-red-100', 'border-l-4', 'border-red-600');
                amountEl.classList.add('text-red-800');
                amountEl.classList.remove('text-green-800', 'text-gray-800');
            } else {
                labelEl.textContent = 'çµç®—çµæœ';
                amountEl.textContent = 'å·²çµæ¸… (0.00 TWD)';
                summaryEl.classList.add('bg-gray-100');
                amountEl.classList.add('text-gray-800');
                amountEl.classList.remove('text-green-800', 'text-red-800');
            }
        }

        // å‡½å¼ï¼šåˆªé™¤è²»ç”¨
        async function deleteExpense(docId) {
            if (!authReady || !db) {
                showMessage("éŒ¯èª¤", "è³‡æ–™åº«é€£ç·šé›¢ç·šæˆ–å°šæœªæº–å‚™å¥½ã€‚");
                return;
            }
            try {
                const docRef = doc(db, 
                    `artifacts/${__app_id}/public/data/expenses`, docId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("åˆªé™¤è²»ç”¨å¤±æ•—: ", error);
                showMessage("éŒ¯èª¤", "åˆªé™¤è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚");
            }
        }


        // å‡½å¼ï¼šæ¸²æŸ“è²»ç”¨åˆ—è¡¨ (èˆ‡ä¹‹å‰ç›¸åŒ)
        function renderExpenseList(expenses) {
            const listEl = document.getElementById('expense-list');
            listEl.innerHTML = '';

            if (expenses.length === 0) {
                listEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">ç›®å‰æ²’æœ‰è²»ç”¨è¨˜éŒ„ã€‚</td></tr>`;
                return;
            }

            expenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                let userSplit = 0;
                let partnerSplit = 0;

                if (exp.splitType === 'equal') {
                    userSplit = exp.amount / 2;
                    partnerSplit = exp.amount / 2;
                } else if (exp.splitType === 'user_pays') {
                    userSplit = exp.amount;
                } else if (exp.splitType === 'partner_pays') {
                    partnerSplit = exp.amount;
                }
                
                tr.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${exp.description}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${exp.amount.toFixed(2)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                        ${exp.paidBy === 'user' ? 'æˆ‘' : 'å¤¥ä¼´'}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-700">
                        ${userSplit.toFixed(2)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-700">
                        ${partnerSplit.toFixed(2)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 transition duration-150 delete-btn" 
                                data-id="${exp.id}">
                            åˆªé™¤
                        </button>
                    </td>
                `;
                listEl.appendChild(tr);
            });

            listEl.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    deleteExpense(docId);
                });
            });
        }

        // å‡½å¼ï¼šè¨‚é–±ä¸¦å³æ™‚è¼‰å…¥è³‡æ–™
        function loadData() {
            if (!authReady || userId === 'loading' || !db) {
                document.getElementById('loading-message').textContent = 'ç­‰å¾…èº«ä»½é©—è­‰å®Œæˆ...';
                return;
            }

            document.getElementById('loading-message').classList.add('hidden');
            const authStatusEl = document.getElementById('auth-status');
            authStatusEl.textContent = 'é€£ç·šæˆåŠŸ (å³æ™‚)';
            authStatusEl.classList.remove('text-yellow-600', 'text-red-600', 'text-orange-500');
            authStatusEl.classList.add('text-green-600');
            
            const collectionPath = `artifacts/${__app_id}/public/data/expenses`;
            
            const unsubscribe = onSnapshot(
                collection(db, collectionPath),
                (snapshot) => {
                    const expenses = [];
                    snapshot.forEach(doc => {
                        expenses.push({ id: doc.id, ...doc.data() });
                    });
                    
                    expenses.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); 
                    
                    renderExpenseList(expenses);
                    updateSettlement(expenses);
                },
                (error) => {
                    console.error("Firestore å³æ™‚ç›£è½å¤±æ•— (éŒ¯èª¤å¯èƒ½ä¾†è‡ªæ¬Šé™): ", error);
                    authStatusEl.textContent = 'é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥æ§åˆ¶å°)';
                    authStatusEl.classList.remove('text-green-600');
                    authStatusEl.classList.add('text-red-600');
                    showMessage("é€£ç·šéŒ¯èª¤", "è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å° (Console) äº†è§£è©³ç´°éŒ¯èª¤ã€‚");
                }
            );

            return unsubscribe;
        }

        // å‡½å¼ï¼šæ–°å¢è²»ç”¨
        async function addExpense(e) {
            e.preventDefault();

            if (!authReady || !db) {
                showMessage("éŒ¯èª¤", "è³‡æ–™åº«é€£ç·šé›¢ç·šæˆ–å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
                return;
            }

            const form = e.target;
            const description = form.description.value.trim();
            const amount = parseFloat(form.amount.value);
            const paidBy = form['paid-by'].value;
            const splitType = form['split-type'].value;

            if (description === "" || isNaN(amount) || amount <= 0 || paidBy === "") {
                showMessage("è¼¸å…¥éŒ¯èª¤", "è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ã€‚");
                return;
            }

            const newExpense = {
                description,
                amount,
                paidBy,
                splitType,
                createdAt: Date.now(),
                createdBy: userId, 
            };

            try {
                const collectionPath = `artifacts/${__app_id}/public/data/expenses`;
                await addDoc(collection(db, collectionPath), newExpense);

                form.reset();
                form['paid-by'].value = "";
            } catch (error) {
                console.error("æ–°å¢è²»ç”¨å¤±æ•—: ", error);
                showMessage("éŒ¯èª¤", "æ–°å¢è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚");
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼çš„ä¸»å‡½å¼
        function initApp() {
            const authStatusEl = document.getElementById('auth-status');
            const currentUserIdEl = document.getElementById('current-user-id');
            const submitButton = document.getElementById('submit-button');
            const loadingMessageEl = document.getElementById('loading-message');
            
            // ğŸš¨ ä¿®æ­£ï¼šæª¢æŸ¥ Canvas ç’°å¢ƒè®Šæ•¸æ˜¯å¦å­˜åœ¨
            const hasCanvasEnvironment = typeof window.__firebase_config !== 'undefined' && typeof window.__app_id !== 'undefined';

            if (!hasCanvasEnvironment) {
                // å¤–éƒ¨ç’°å¢ƒ (ä¾‹å¦‚ GitHub Pages) æ¨¡å¼ï¼šç¦ç”¨ Firebase ç›¸é—œåŠŸèƒ½
                authStatusEl.textContent = 'å¤–éƒ¨ç’°å¢ƒæ¨¡å¼ (Firestore é›¢ç·š)';
                authStatusEl.classList.remove('text-yellow-600');
                authStatusEl.classList.add('text-orange-500');
                currentUserIdEl.textContent = 'N/A (è«‹åœ¨ Canvas ä¸­é è¦½)';
                loadingMessageEl.textContent = 'è³‡æ–™åº«åŠŸèƒ½å·²ç¦ç”¨ï¼Œè«‹å›åˆ° Canvas é è¦½ä¸­æ¸¬è©¦è³‡æ–™åº«é€£ç·šã€‚';
                submitButton.disabled = true;
                submitButton.textContent = 'æ–°å¢è²»ç”¨ (é›¢ç·š)';
                
                // ç«‹å³é¡¯ç¤ºè­¦å‘Š modalï¼Œåªæœ‰ç¬¬ä¸€æ¬¡
                setTimeout(() => {
                    if (document.getElementById('message-modal').classList.contains('hidden')) {
                        showMessage(
                            "é€£ç·šè­¦å‘Š - å¤–éƒ¨ç’°å¢ƒ",
                            "æ‚¨æ­£åœ¨ Canvas å¤–éƒ¨åŸ·è¡Œæ­¤æ‡‰ç”¨ç¨‹å¼ã€‚Firebase é€£ç·šé…ç½®éºå¤±ï¼Œå› æ­¤è³‡æ–™åº«åŠŸèƒ½å·²ç¦ç”¨ã€‚è«‹å›åˆ° Canvas é è¦½ä¸­æ¸¬è©¦é€£ç·šã€‚"
                        );
                    }
                }, 500);

                // é˜»æ­¢æ‡‰ç”¨ç¨‹å¼ç¹¼çºŒåˆå§‹åŒ– Firebase
                return;
            }


            // æ­£å¸¸çš„ Canvas ç’°å¢ƒåˆå§‹åŒ–æµç¨‹
            try {
                setLogLevel('debug'); 

                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authReady = true;
                        currentUserIdEl.textContent = userId;
                        loadData(); // ç™»å…¥æˆåŠŸå¾Œæ‰é–‹å§‹è¼‰å…¥è³‡æ–™

                    } else {
                        // åˆå§‹ç™»å…¥å˜—è©¦
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken)
                                .catch(error => {
                                    console.error("Custom Token ç™»å…¥å¤±æ•—, è½‰ç‚ºåŒ¿åç™»å…¥:", error);
                                    signInAnonymously(auth).catch(anonError => {
                                        console.error("åŒ¿åç™»å…¥ä¹Ÿå¤±æ•—:", anonError);
                                        authStatusEl.textContent = 'é€£ç·šå¤±æ•— (ç™»å…¥)';
                                        authStatusEl.classList.add('text-red-600');
                                    });
                                });
                        } else {
                             signInAnonymously(auth).catch(error => {
                                console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                                authStatusEl.textContent = 'é€£ç·šå¤±æ•— (åŒ¿åç™»å…¥)';
                                authStatusEl.classList.add('text-red-600');
                            });
                        }
                    }
                });

                document.getElementById('expense-form').addEventListener('submit', addExpense);

            } catch (error) {
                console.error("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:", error);
                authStatusEl.textContent = 'åˆå§‹åŒ–éŒ¯èª¤';
                authStatusEl.classList.remove('text-yellow-600');
                authStatusEl.classList.add('text-red-600');
                showMessage("åš´é‡éŒ¯èª¤", "æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯ã€‚");
            }
        }

        window.onload = initApp;

    </script>

</body>
</html>

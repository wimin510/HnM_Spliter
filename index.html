<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬ HnM Spliter</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981', // æˆåŠŸ/å„ªå‹¢
                        'danger': '#ef4444',    // åŠ£å‹¢/éŒ¯èª¤
                        'warning': '#f59e0b',   // é€£ç·šä¸­
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div id="app" class="max-w-xl mx-auto space-y-6">
        <h1 class="text-3xl font-extrabold text-center text-gray-800">ç„¡è³´å¸³æœ¬ ğŸ“</h1>
        
        <!-- é€£ç·šç‹€æ…‹ & User ID -->
        <div id="status-card" class="p-3 rounded-xl shadow-md transition-all duration-300 bg-gray-100 border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                    <p id="connection-status" class="text-sm font-semibold text-gray-600">åˆå§‹åŒ–ä¸­...</p>
                </div>
                <p class="text-xs text-gray-500 font-mono" id="user-info">UserID: è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        
        <!-- æ¬ æ¬¾ç‹€æ…‹é¡¯ç¤º (å›ºå®šä»¥ TWD é¡¯ç¤º) -->
        <div id="balance-card" class="p-6 rounded-xl shadow-lg transition-all duration-300 bg-gray-400 text-white">
            <h2 class="text-lg font-semibold mb-2" id="balance-status-text">è¼‰å…¥ä¸­...</h2>
            <p class="text-4xl font-extrabold" id="balance-amount">--</p>
            <p class="text-sm mt-1" id="balance-currency-info"></p>
        </div>

        <!-- åŒ¯ç‡é¡¯ç¤º -->
        <div id="rates-card" class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">å³æ™‚åŒ¯ç‡ (å…Œ TWD)</h2>
            <div id="rates-display" class="text-sm space-y-1">
                <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- åç¨±è¨­å®šå€å¡Š -->
        <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
            <button id="toggle-settings" class="w-full flex justify-between items-center text-left text-lg font-semibold text-gray-800 focus:outline-none py-1">
                <span>åç¨±è¨­å®š (H:æˆ‘ / M:å¤¥ä¼´)</span>
                <svg id="settings-chevron" class="w-5 h-5 transition-transform duration-300 transform" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="settings-content" class="mt-4 space-y-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="h-name-input" class="block text-sm font-medium text-gray-700">æˆ‘çš„åç¨± (H)</label>
                        <input type="text" id="h-name-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., John">
                    </div>
                    <div>
                        <label for="m-name-input" class="block text-sm font-medium text-gray-700">å¤¥ä¼´åç¨± (M)</label>
                        <input type="text" id="m-name-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., Mary">
                    </div>
                </div>
                <button id="save-names-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-secondary hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out">
                    å„²å­˜åç¨±è¨­å®š
                </button>
            </div>
        </div>
        
        <!-- è¨˜éŒ„è¡¨å–® -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æ–°å¢ç´€éŒ„</h2>
            <form id="expense-form" class="space-y-4">
                
                <!-- å¹£åˆ¥é¸æ“‡ -->
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700">å¹£åˆ¥</label>
                    <select id="currency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="TWD">æ–°å°å¹£ (TWD)</option>
                        <option value="JPY">æ—¥å¹£ (JPY)</option>
                        <option value="USD">ç¾å…ƒ (USD)</option>
                    </select>
                </div>

                <!-- ç¸½é‡‘é¡ & æ—¥æœŸ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="totalAmount" class="block text-sm font-medium text-gray-700">ç¸½é‡‘é¡</label>
                        <input type="number" id="totalAmount" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                    <div>
                        <label for="recordDate" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                </div>

                <!-- ä»˜æ¬¾äºº -->
                <div>
                    <label for="payer" class="block text-sm font-medium text-gray-700">ä»˜æ¬¾äºº</label>
                    <select id="payer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="H">æˆ‘ (Me)</option>
                        <option value="M">å¤¥ä¼´ (Partner)</option>
                    </select>
                </div>

                <!-- æè¿° -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">æè¿° (e.g., æ™šé¤)</label>
                    <input type="text" id="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., æ™šé¤">
                </div>

                <!-- åˆ†å¸³æ–¹å¼ -->
                <div>
                    <label for="splitType" class="block text-sm font-medium text-gray-700">åˆ†å¸³æ–¹å¼</label>
                    <select id="splitType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="equal">å‡åˆ† (Equal)</option>
                        <option value="custom">è‡ªè¨‚é‡‘é¡ (Custom)</option>
                    </select>
                </div>

                <!-- è‡ªè¨‚é‡‘é¡åˆ†é… (Custom Split) -->
                <div id="custom-split-fields" class="grid grid-cols-2 gap-4 hidden">
                    <div>
                        <label for="amountH" class="block text-sm font-medium text-gray-700">æˆ‘ (H) æ‡‰ä»˜é‡‘é¡</label>
                        <input type="number" id="amountH" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                    <div>
                        <label for="amountM" class="block text-sm font-medium text-gray-700">å¤¥ä¼´ (M) æ‡‰ä»˜é‡‘é¡</label>
                        <input type="number" id="amountM" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <button type="submit" id="submit-expense-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    å„²å­˜ç´€éŒ„
                </button>
            </form>
            <div id="error-message" class="text-danger text-sm mt-3 hidden p-2 bg-red-50 rounded-md"></div>
        </div>

        <!-- æœ€è¿‘äº”ç­†ç´€éŒ„ -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æœ€è¿‘ç´€éŒ„</h2>
            <ul id="recent-records" class="space-y-3">
                <li class="text-gray-500 text-center py-4" id="loading-records">é€£ç·šæˆåŠŸå¾Œè¼‰å…¥ç´€éŒ„...</li>
            </ul>
        </div>
    </div>

    <!-- æ¨¡çµ„åŒ–éŒ¯èª¤æç¤ºæ¡† (ç”¨æ–¼å–ä»£ alert()) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-full m-4">
            <h3 class="text-xl font-bold text-danger mb-3" id="modal-title">éŒ¯èª¤é€šçŸ¥</h3>
            <p id="modal-message" class="text-gray-700 text-sm"></p>
            <div class="mt-4 text-right">
                <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        // å°å…¥ Firebase æ¨¡çµ„
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            limit,
            serverTimestamp,
            getDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            // å·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„é…ç½®
            apiKey: "AIzaSyCRHx0i02nojkN5-y5HxS3P3i1jA5SEy8E", 
            authDomain: "hnm-spliter.firebaseapp.com",
            projectId: "hnm-spliter",
            storageBucket: "hnm-spliter.firebasestorage.app",
            messagingSenderId: "514297368344",
            appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d",
            measurementId: "G-4DY12810X8"
        };
        // ------------------------------------

        // --- åŒ¯ç‡ API é…ç½® ---
        const FRANKFURTER_API = 'https://api.frankfurter.dev/latest';
        const BASE_CURRENCY = 'TWD'; // çµ±ä¸€çš„è¨ˆç®—åŸºç¤å¹£åˆ¥
        const TARGET_CURRENCIES = ['JPY', 'USD']; // éœ€è¦ç²å–å° TWD åŒ¯ç‡çš„å¹£åˆ¥
        // ------------------------------------

        // --- å…¨åŸŸç‹€æ…‹èˆ‡è®Šæ•¸ ---
        let app, db, auth, userId = null;
        let isAuthReady = false;
        let EXCHANGE_RATES = null; // å„²å­˜ (1 TWD = X Foreign Currency) çš„åŒ¯ç‡
        let RATES_LOADING = false;
        
        // ä½¿ç”¨å›ºå®šçš„ APP_ID ç¢ºä¿è³‡æ–™å…±äº«
        const APP_ID = 'hnm-spliter-public-app'; 
        const USER_PARTY = 'H'; // å‡è¨­ç•¶å‰ä½¿ç”¨è€…æ˜¯ H (æˆ‘)
        const PARTNER_PARTY = 'M';
        let PARTY_NAMES = {
            'H': 'æˆ‘ (Me)', // é è¨­åç¨±
            'M': 'å¤¥ä¼´ (Partner)', // é è¨­åç¨±
        };
        
        // --- DOM å…ƒç´  ---
        const connectionStatusElement = document.getElementById('connection-status');
        const statusIndicator = document.getElementById('status-indicator');
        const userInfoElement = document.getElementById('user-info');
        const statusCard = document.getElementById('status-card');
        
        const totalAmountInput = document.getElementById('totalAmount');
        const amountHInput = document.getElementById('amountH');
        const amountMInput = document.getElementById('amountM');
        const splitTypeSelect = document.getElementById('splitType');
        const customSplitFields = document.getElementById('custom-split-fields');
        const expenseForm = document.getElementById('expense-form');
        const recentRecordsList = document.getElementById('recent-records');
        const balanceCard = document.getElementById('balance-card');
        const balanceStatusText = document.getElementById('balance-status-text');
        const balanceAmountElement = document.getElementById('balance-amount');
        const balanceCurrencyInfo = document.getElementById('balance-currency-info');
        const errorMessageElement = document.getElementById('error-message');
        const submitExpenseBtn = document.getElementById('submit-expense-btn');

        const ratesCard = document.getElementById('rates-card');
        const ratesDisplay = document.getElementById('rates-display');

        // åç¨±è¨­å®š DOM
        const hNameInput = document.getElementById('h-name-input');
        const mNameInput = document.getElementById('m-name-input');
        const saveNamesBtn = document.getElementById('save-names-btn');
        const toggleSettingsBtn = document.getElementById('toggle-settings');
        const settingsContent = document.getElementById('settings-content');
        const settingsChevron = document.getElementById('settings-chevron');
        const payerSelect = document.getElementById('payer');
        
        // è¨­ç½®é è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();


        // --- è¼”åŠ©å‡½å¼ ---
        
        // é¡¯ç¤ºæ¨¡çµ„åŒ–æç¤ºæ¡†
        const showModal = (message, title = 'éŒ¯èª¤æˆ–æç¤º') => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        };

        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        const setConnectionStatus = (status, message = '', uid = null) => {
            let bgColorClass = 'bg-gray-400';
            let textColorClass = 'text-gray-600';
            let statusText = message || 'æœªçŸ¥ç‹€æ…‹';
            
            // é‡ç½®æ¨£å¼
            statusIndicator.classList.remove('bg-gray-400', 'bg-secondary', 'bg-danger', 'bg-warning', 'animate-pulse');
            statusCard.classList.remove('bg-gray-100', 'bg-green-50', 'bg-red-50', 'border-gray-200', 'border-secondary', 'border-danger');

            switch (status) {
                case 'connecting':
                    statusText = 'é€£ç·šä¸­...';
                    bgColorClass = 'bg-warning';
                    textColorClass = 'text-warning';
                    statusIndicator.classList.add('animate-pulse');
                    statusCard.classList.add('bg-gray-100', 'border-warning');
                    submitExpenseBtn.disabled = true;
                    saveNamesBtn.disabled = true;
                    break;
                case 'connected':
                    statusText = 'å·²æˆåŠŸç™»å…¥ (åŒ¿å)';
                    bgColorClass = 'bg-secondary';
                    textColorClass = 'text-secondary';
                    statusCard.classList.add('bg-green-50', 'border-secondary');
                    // åªæœ‰åœ¨åŒ¯ç‡è¼‰å…¥å®Œæˆå¾Œæ‰å•Ÿç”¨æŒ‰éˆ•
                    submitExpenseBtn.disabled = RATES_LOADING || !EXCHANGE_RATES;
                    saveNamesBtn.disabled = false;
                    break;
                case 'error':
                    statusText = message || 'é€£ç·šæˆ–ç™»å…¥å¤±æ•—';
                    bgColorClass = 'bg-danger';
                    textColorClass = 'text-danger';
                    statusCard.classList.add('bg-red-50', 'border-danger');
                    submitExpenseBtn.disabled = true;
                    saveNamesBtn.disabled = true;
                    break;
                default:
                    statusText = 'åˆå§‹åŒ–ä¸­...';
                    submitExpenseBtn.disabled = true;
                    saveNamesBtn.disabled = true;
            }

            // æ›´æ–° UI
            statusIndicator.classList.add(bgColorClass);
            connectionStatusElement.textContent = statusText;
            connectionStatusElement.classList.remove('text-gray-600', 'text-secondary', 'text-danger', 'text-warning');
            connectionStatusElement.classList.add(textColorClass);
            
            if (uid) {
                userInfoElement.textContent = `UserID: ${uid.substring(0, 4)}...`;
            } else {
                userInfoElement.textContent = 'UserID: å°šæœªç™»å…¥';
            }
        };

        // è™•ç† Firebase éŒ¯èª¤
        const handleFirebaseError = (error, action = 'æ“ä½œ') => {
            console.error(`Firebase éŒ¯èª¤ [${action}]:`, error);
            const msg = `[${action}å¤±æ•—] éŒ¯èª¤ä»£ç¢¼: ${error.code || 'æœªçŸ¥'}. è«‹æª¢æŸ¥æ‚¨çš„ Firebase è¦å‰‡æˆ–ç¨å¾Œå†è©¦ã€‚`;
            showModal(msg);
        };

        // ç²å–è²¨å¹£ç¬¦è™Ÿ
        const getCurrencySymbol = (currency) => {
            switch (currency) {
                case 'TWD': return 'NT$';
                case 'JPY': return 'Â¥';
                case 'USD': return '$';
                default: return '';
            }
        };
        
        // --- è³‡æ–™åº«è·¯å¾‘ (ä¿®å¾©è·¯å¾‘ç‰‡æ®µæ•¸é‡éŒ¯èª¤) ---
        // ä½¿ç”¨ apps/{APP_ID}/transactions ä½œç‚º Collection (3 segments)
        const getExpensesCollectionRef = () => {
            return collection(db, `apps/${APP_ID}/transactions`);
        };

        // ä½¿ç”¨ apps/{APP_ID}/metadata/balance ä½œç‚º Document (4 segments)
        const getBalanceDocRef = () => {
            return doc(db, `apps/${APP_ID}/metadata/balance`);
        };
        
        // ä½¿ç”¨ apps/{APP_ID}/metadata/partyNames ä½œç‚º Document (4 segments, ä¿®æ­£äº†åŸæœ¬ 5 segments çš„éŒ¯èª¤)
        const getSettingsDocRef = () => {
            return doc(db, `apps/${APP_ID}/metadata/partyNames`);
        };


        // --- åŒ¯ç‡é‚è¼¯ ---

        // ç²å–è½‰æ›ç‡ (1 å–®ä½ Foreign Currency = X TWD)
        const getConversionRateToTWD = (currency) => {
            if (currency === BASE_CURRENCY) return 1;
            
            if (!EXCHANGE_RATES || !EXCHANGE_RATES[currency]) {
                // å¦‚æœåŒ¯ç‡æœªè¼‰å…¥æˆ–ç¼ºå°‘ï¼Œå‰‡ç„¡æ³•è¨ˆç®—è·¨å¹£åˆ¥äº¤æ˜“
                console.warn(`Missing exchange rate for ${currency}. Conversion will fail.`);
                return 0; 
            }
            
            // EXCHANGE_RATES å„²å­˜çš„æ˜¯ (1 TWD = X å¤–å¹£) çš„åŒ¯ç‡
            // æˆ‘å€‘éœ€è¦çš„æ˜¯ (1 å¤–å¹£ = 1/X TWD) çš„åŒ¯ç‡
            const rate = 1 / EXCHANGE_RATES[currency];
            return rate;
        };

        // ç²å–å³æ™‚åŒ¯ç‡
        const fetchExchangeRates = async (retries = 3) => {
            RATES_LOADING = true;
            ratesDisplay.innerHTML = '<p class="text-warning animate-pulse">é€£ç·šä¸­...</p>';
            
            // ç²å– TWD åˆ° JPY å’Œ USD çš„åŒ¯ç‡ (å³ 1 TWD = ? JPY, 1 TWD = ? USD)
            const url = `${FRANKFURTER_API}?from=${BASE_CURRENCY}&to=${TARGET_CURRENCIES.join(',')}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.rates) {
                    EXCHANGE_RATES = data.rates;
                    EXCHANGE_RATES[BASE_CURRENCY] = 1; // åŸºç¤å¹£åˆ¥ TWD çš„åŒ¯ç‡æ˜¯ 1
                    renderExchangeRates();
                    RATES_LOADING = false;
                    // åŒ¯ç‡è¼‰å…¥å®Œæˆå¾Œï¼Œå¦‚æœå·²ç™»å…¥ï¼Œå•Ÿç”¨æŒ‰éˆ•
                    if (auth.currentUser) submitExpenseBtn.disabled = false;
                } else {
                    throw new Error('API response missing rates data.');
                }

            } catch (error) {
                console.error('Fetch Rates Error:', error);
                
                if (retries > 0) {
                    console.log(`Retrying fetch rates... (${retries} attempts left)`);
                    // æŒ‡æ•¸é€€é¿ (Exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, (4 - retries) * 1000));
                    await fetchExchangeRates(retries - 1);
                } else {
                    RATES_LOADING = false;
                    ratesDisplay.innerHTML = `<p class="text-danger font-semibold">åŒ¯ç‡è¼‰å…¥å¤±æ•—ã€‚è·¨å¹£åˆ¥äº¤æ˜“å°‡ä¸è¢«è¨ˆç®—ã€‚</p>`;
                    // è¨­å®šé è¨­ rates ç‚º nullï¼Œè§¸ç™¼è¡¨å–®æäº¤çš„éŒ¯èª¤æç¤º
                    EXCHANGE_RATES = null; 
                    if (auth.currentUser) submitExpenseBtn.disabled = true;
                    showModal('ç„¡æ³•ç²å–æœ€æ–°åŒ¯ç‡ã€‚æ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•åŸ·è¡Œè·¨å¹£åˆ¥è¨ˆç®—ã€‚è«‹ç¨å¾Œé‡è©¦ã€‚', 'åŒ¯ç‡éŒ¯èª¤');
                }
            }
        };

        // æ¸²æŸ“åŒ¯ç‡é¡¯ç¤º
        const renderExchangeRates = () => {
            if (!EXCHANGE_RATES) return;
            
            // é¡¯ç¤ºçš„æ˜¯ 1 å–®ä½å¤–å¹£ å…Œæ›å¤šå°‘ TWD (å³æˆ‘å€‘è¨ˆç®—æ‰€éœ€çš„åå‘åŒ¯ç‡)
            let html = '';
            
            // é¿å…é™¤ä»¥é›¶æˆ–åŒ¯ç‡ä¸å­˜åœ¨
            const rateToTWD_JPY = EXCHANGE_RATES.JPY ? (1 / EXCHANGE_RATES.JPY).toFixed(4) : 'N/A';
            const rateToTWD_USD = EXCHANGE_RATES.USD ? (1 / EXCHANGE_RATES.USD).toFixed(4) : 'N/A';

            html += `<p class="text-gray-700 font-medium">1 JPY = ${rateToTWD_JPY} TWD</p>`;
            html += `<p class="text-gray-700 font-medium">1 USD = ${rateToTWD_USD} TWD</p>`;
            html += `<p class="text-xs text-gray-400 mt-2">è³‡æ–™ä¾†æº: Frankfurter API (åŸºç¤å¹£ TWD)</p>`;
            
            ratesDisplay.innerHTML = html;
        };


        // --- Firebase èªè­‰é‚è¼¯ ---
        
        const attemptAnonymousSignIn = async (authInstance) => {
            setConnectionStatus('connecting', 'å˜—è©¦åŒ¿åç™»å…¥...');
            try {
                // åŸ·è¡ŒåŒ¿åç™»å…¥
                await signInAnonymously(authInstance);
            } catch (error) {
                // åŒ¿åç™»å…¥å¤±æ•—
                const msg = `åŒ¿åç™»å…¥å¤±æ•—ï¼è«‹ç¢ºèª Firebase å°ˆæ¡ˆä¸­å·²å•Ÿç”¨ "åŒ¿å" ç™»å…¥æ–¹å¼ã€‚éŒ¯èª¤ä»£ç¢¼: ${error.code}`;
                handleFirebaseError(error, 'åŒ¿åç™»å…¥');
                setConnectionStatus('error', 'åŒ¿åç™»å…¥å¤±æ•—');
            }
        };


        const initFirebase = async () => {
            try {
                // 1. åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error'); // åƒ…è¨˜éŒ„éŒ¯èª¤ï¼Œä¿æŒæ§åˆ¶å°æ•´æ½”
                
                // å•Ÿå‹•åŒ¯ç‡ç²å– (ä¸éœ€ç­‰å¾…èº«ä»½é©—è­‰)
                await fetchExchangeRates();

                setConnectionStatus('connecting'); 

                // 2. è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½å™¨
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        setConnectionStatus('connected', null, user.uid);
                        // èº«ä»½é©—è­‰å®Œæˆå¾Œï¼Œå•Ÿå‹•è³‡æ–™ç›£è½
                        setupDataListeners();
                        // ç¢ºä¿åŒ¯ç‡è¼‰å…¥å®Œæˆå¾ŒæŒ‰éˆ•å•Ÿç”¨
                        if (!RATES_LOADING && EXCHANGE_RATES) submitExpenseBtn.disabled = false;
                    } else {
                        isAuthReady = false;
                        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œå˜—è©¦ç™»å…¥
                        if (!auth.currentUser) {
                             attemptAnonymousSignIn(auth);
                        } else {
                            setConnectionStatus('error', 'å·²ç™»å‡ºæˆ–æœƒè©±éæœŸ');
                        }
                    }
                });

            } catch (error) {
                // åˆå§‹åŒ–å¤±æ•—
                handleFirebaseError(error, 'åˆå§‹åŒ–');
                setConnectionStatus('error', 'åˆå§‹åŒ–éŒ¯èª¤');
            }
        };


        // --- è³‡æ–™åº«æ“ä½œèˆ‡ç›£è½ ---

        // è¨­ç½®å³æ™‚è³‡æ–™ç›£è½å™¨
        const setupDataListeners = () => {
            if (!isAuthReady || !db) return;

            // 1. ç›£è½åç¨±è¨­å®š
            setupNamesListener();

            // 2. ç›£è½æœ€è¿‘äº”ç­†ç´€éŒ„ (æŒ‰æ™‚é–“é™åºæ’åº)
            const qRecords = query(getExpensesCollectionRef(), limit(10));
            onSnapshot(qRecords, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data(), 
                        // å°‡ Firestore Timestamp è½‰æ›ç‚ºæ—¥æœŸå­—ä¸²
                        recordTimestamp: doc.data().recordTimestamp?.toDate().toISOString().split('T')[0] || 'N/A' 
                    });
                });
                
                // å®¢æˆ¶ç«¯æ’åºï¼šæŒ‰æ—¥æœŸæ™‚é–“æˆ³é™åº
                records.sort((a, b) => {
                    // ä½¿ç”¨ recordDate ä½œç‚ºæ’åºä¾æ“š
                    const dateA = new Date(a.recordDate).getTime();
                    const dateB = new Date(b.recordDate).getTime();
                    
                    // æ¬¡è¦æ’åºï¼šä½¿ç”¨ recordTimestamp (å¦‚æœå­˜åœ¨ï¼Œä½†æˆ‘å€‘ä¸ä¸€å®šèƒ½ç²å–åˆ°ï¼Œæ‰€ä»¥ä¸»è¦ä¾é  dateB - dateA)
                    return dateB - dateA; 
                });
                
                renderRecentRecords(records); 
            }, (error) => handleFirebaseError(error, 'ç›£è½ç´€éŒ„'));

            // 3. ç›£è½ç¸½æ¬ æ¬¾ç‹€æ…‹
            onSnapshot(getBalanceDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const balanceData = docSnapshot.data();
                    // ç¸½æ¬ æ¬¾ balance å·²ç¶“å›ºå®šç‚º TWD å–®ä½
                    const balance = balanceData.balance || 0;
                    const currency = balanceData.currency || BASE_CURRENCY;
                    renderBalance(balance, currency);
                } else {
                    renderBalance(0, BASE_CURRENCY);
                }
            }, (error) => handleFirebaseError(error, 'ç›£è½æ¬ æ¬¾'));
        };

        // ç›£è½åç¨±è¨­å®š
        const setupNamesListener = () => {
            onSnapshot(getSettingsDocRef(), (docSnapshot) => {
                let changed = false;
                if (docSnapshot.exists()) {
                    const names = docSnapshot.data();
                    if (names.HName && PARTY_NAMES['H'] !== names.HName) {
                        PARTY_NAMES['H'] = names.HName;
                        changed = true;
                    }
                    if (names.MName && PARTY_NAMES['M'] !== names.MName) {
                        PARTY_NAMES['M'] = names.MName;
                        changed = true;
                    }
                }
                
                // ç„¡è«–æ˜¯å¦æ”¹è®Šï¼Œéƒ½è¦ç¢ºä¿ UI åæ˜ æœ€æ–°ç‹€æ…‹æˆ–é è¨­å€¼
                updatePartyNamesUI();
                
            }, (error) => console.error('ç›£è½åç¨±è¨­å®šå¤±æ•—:', error));
        };

        // --- UI æ¸²æŸ“åŠŸèƒ½ ---
        
        // æ›´æ–°æ‰€æœ‰ä½¿ç”¨ H/M åç¨±çš„ UI å…ƒç´ 
        const updatePartyNamesUI = () => {
            // 1. æ›´æ–°åç¨±è¨­å®šè¼¸å…¥æ¡† (å¦‚æœä¸æ˜¯ç•¶å‰ç·¨è¼¯ç‹€æ…‹)
            if (document.activeElement !== hNameInput) hNameInput.value = PARTY_NAMES['H'];
            if (document.activeElement !== mNameInput) mNameInput.value = PARTY_NAMES['M'];

            // 2. æ›´æ–°ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®
            if (payerSelect.options[0]) payerSelect.options[0].textContent = PARTY_NAMES['H'];
            if (payerSelect.options[1]) payerSelect.options[1].textContent = PARTY_NAMES['M'];
            
            // 3. æ›´æ–°è‡ªè¨‚é‡‘é¡çš„æ¨™ç±¤
            document.querySelector('label[for="amountH"]').textContent = `${PARTY_NAMES['H']} (H) æ‡‰ä»˜é‡‘é¡`;
            document.querySelector('label[for="amountM"]').textContent = `${PARTY_NAMES['M']} (M) æ‡‰ä»˜é‡‘é¡`;
            
            // 4. å¼·åˆ¶é‡æ–°æ¸²æŸ“æ¬ æ¬¾ç‹€æ…‹ä»¥æ›´æ–°åç¨±
            // ç”±æ–¼ balance çš„ onSnapshot ä¸ä¸€å®šæœƒç«‹å³è§¸ç™¼ï¼Œæˆ‘å€‘æ‰‹å‹•æ›´æ–°ä¸€æ¬¡
            const balanceAmount = parseFloat(balanceAmountElement.textContent.replace(/[^\d.-]/g, '')) || 0;
            // balance ä¸€å®šæ˜¯ BASE_CURRENCY (TWD)
            renderBalance(balanceAmount * (balanceStatusText.textContent.includes('æ¬ ') ? -1 : 1), BASE_CURRENCY);
        };


        // æ¸²æŸ“æ¬ æ¬¾ç‹€æ…‹
        const renderBalance = (balance, currency) => {
            // ç¸½æ¬ æ¬¾å›ºå®šç‚º TWD 
            const fixedCurrency = BASE_CURRENCY; 
            const isOwed = balance > 0;
            const isDebt = balance < 0;
            // ç¸½æ¬ æ¬¾å››æ¨äº”å…¥åˆ°å°æ•¸é»ç¬¬äºŒä½
            const absBalance = Math.abs(balance).toFixed(2); 
            const currencySymbol = getCurrencySymbol(fixedCurrency);
            
            balanceCard.classList.remove('bg-secondary', 'bg-danger', 'bg-gray-400');

            if (isOwed) {
                // M æ¬  H (æˆ‘æ–¹å„ªå‹¢)
                balanceCard.classList.add('bg-secondary'); 
                balanceStatusText.textContent = `${PARTY_NAMES[PARTNER_PARTY]} æ¬  ${PARTY_NAMES[USER_PARTY]} (æˆ‘æ–¹å„ªå‹¢)`;
            } else if (isDebt) {
                // H æ¬  M (æˆ‘æ–¹åŠ£å‹¢)
                balanceCard.classList.add('bg-danger'); 
                balanceStatusText.textContent = `${PARTY_NAMES[USER_PARTY]} æ¬  ${PARTY_NAMES[PARTNER_PARTY]} (æˆ‘æ–¹åŠ£å‹¢)`;
            } else {
                // çµæ¸…
                balanceCard.classList.add('bg-gray-400');
                balanceStatusText.textContent = `ç›®å‰å·²çµæ¸…`;
            }

            balanceAmountElement.textContent = `${currencySymbol} ${absBalance}`;
            balanceCurrencyInfo.textContent = `å¹£åˆ¥: ${fixedCurrency} (çµ±ä¸€è¨ˆç®—å¹£åˆ¥)`;
        };

        // æ¸²æŸ“æœ€è¿‘ç´€éŒ„
        const renderRecentRecords = (records) => {
            recentRecordsList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            if (records.length === 0) {
                recentRecordsList.innerHTML = '<li class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</li>';
                return;
            }

            records.forEach(record => {
                const currencySymbol = getCurrencySymbol(record.currency);
                
                let amountText = '';
                
                if (record.splitType === 'equal') {
                    const splitAmount = (record.totalAmount / 2).toFixed(2);
                    amountText = `ç¸½é¡: ${currencySymbol} ${record.totalAmount.toFixed(2)} | å‡æ”¤: ${currencySymbol} ${splitAmount}`;
                } else {
                    const H_Paid = record.amountH || 0;
                    const M_Paid = record.amountM || 0;
                    amountText = `${PARTY_NAMES[USER_PARTY]}æ‡‰ä»˜: ${currencySymbol} ${H_Paid.toFixed(2)}, ${PARTY_NAMES[PARTNER_PARTY]}æ‡‰ä»˜: ${currencySymbol} ${M_Paid.toFixed(2)}`;
                }

                // æ–°å¢åŒ¯ç‡è³‡è¨Š
                let conversionInfo = '';
                if (record.currency !== BASE_CURRENCY && record.conversionRate && record.netDebtChangeTWD !== undefined) {
                    // è½‰æ›ç‡æ˜¯ 1 å–®ä½å¤–å¹£ å…Œæ›å¤šå°‘ TWD
                    conversionInfo = `
                        <p class="text-xs text-warning mt-1">åŒ¯ç‡: 1 ${record.currency} = ${record.conversionRate.toFixed(4)} TWD</p>
                        <p class="text-xs text-gray-400">TWD æ·¨æ¬ æ¬¾è®Šå‹•: NT$ ${record.netDebtChangeTWD.toFixed(2)}</p>
                    `;
                }


                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150';
                listItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm font-semibold">${record.description}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date(record.recordDate).toLocaleDateString()} / ä»˜æ¬¾äºº: ${PARTY_NAMES[record.payer]} (${record.currency})</p>
                        ${conversionInfo}
                    </div>
                    <div class="text-right ml-4">
                        <p class="text-sm font-medium text-gray-800">${amountText}</p>
                        <p class="text-xs text-gray-400 mt-1">${record.splitType === 'equal' ? 'å‡åˆ†' : 'è‡ªè¨‚'}</p>
                    </div>
                `;
                recentRecordsList.appendChild(listItem);
            });
        };

        // --- äº‹ä»¶ç›£è½å™¨ ---

        // åç¨±è¨­å®šå„²å­˜
        saveNamesBtn.addEventListener('click', async () => {
            const HName = hNameInput.value.trim();
            const MName = mNameInput.value.trim();

            if (!HName || !MName) {
                showModal('è«‹è¼¸å…¥é›™æ–¹çš„åç¨±ã€‚');
                return;
            }
            if (!isAuthReady) {
                 showModal('è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            try {
                // setDoc ä½¿ç”¨ getSettingsDocRef()ï¼Œç¾å·²ä¿®å¾©ç‚º 4 å€‹è·¯å¾‘ç‰‡æ®µ
                await setDoc(getSettingsDocRef(), {
                    HName: HName,
                    MName: MName,
                    lastUpdated: serverTimestamp(),
                }, { merge: true });
                
                // onSnapshot æœƒè‡ªå‹•æ›´æ–° PARTY_NAMES å’Œ UIï¼Œä½†æˆ‘å€‘æ‰‹å‹•æ”¶èµ·é¢æ¿
                showModal('åç¨±å·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥ï¼', 'å„²å­˜æˆåŠŸ');
                
                settingsContent.classList.add('hidden');
                settingsChevron.classList.remove('rotate-180');
                
            } catch (error) {
                handleFirebaseError(error, 'å„²å­˜åç¨±');
            }
        });

        // å±•é–‹/æ”¶åˆè¨­å®šå€å¡Š
        toggleSettingsBtn.addEventListener('click', () => {
            settingsContent.classList.toggle('hidden');
            settingsChevron.classList.toggle('rotate-180');
        });


        // å‡åˆ†/è‡ªè¨‚ åˆ‡æ›é‚è¼¯
        splitTypeSelect.addEventListener('change', () => {
            if (splitTypeSelect.value === 'custom') {
                customSplitFields.classList.remove('hidden');
                updateCustomSplit(totalAmountInput); 
            } else {
                customSplitFields.classList.add('hidden');
                amountHInput.value = '';
                amountMInput.value = '';
            }
        });

        // è‡ªè¨‚é‡‘é¡è‡ªå‹•è¨ˆç®—é‚è¼¯
        totalAmountInput.addEventListener('input', () => updateCustomSplit(totalAmountInput));
        amountHInput.addEventListener('input', () => updateCustomSplit(amountHInput));
        amountMInput.addEventListener('input', () => updateCustomSplit(amountMInput));

        function updateCustomSplit(changedInput) {
            if (splitTypeSelect.value !== 'custom') return;

            const total = parseFloat(totalAmountInput.value) || 0;
            
            if (changedInput === amountHInput) {
                const amountH = parseFloat(amountHInput.value) || 0;
                const remaining = total - amountH;
                amountMInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            } else if (changedInput === amountMInput) {
                const amountM = parseFloat(amountMInput.value) || 0;
                const remaining = total - amountM;
                amountHInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            } else if (changedInput === totalAmountInput) {
                 // ç¸½é‡‘é¡è®Šæ›´æ™‚ï¼Œè‡ªå‹•æ›´æ–°Mçš„é‡‘é¡ä»¥è£œè¶³å·®é¡ (ä¿æŒHä¸è®Š)
                 const amountH = parseFloat(amountHInput.value) || 0;
                 const remaining = total - amountH;
                 amountMInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            }
        }
        
        // æäº¤è¡¨å–®è™•ç†
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageElement.classList.add('hidden');
            errorMessageElement.textContent = '';

            if (!isAuthReady) {
                showModal('è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            const totalAmount = parseFloat(totalAmountInput.value);
            const currency = document.getElementById('currency').value;
            const payer = document.getElementById('payer').value;
            const description = document.getElementById('description').value.trim();
            const splitType = splitTypeSelect.value;
            const recordDateString = document.getElementById('recordDate').value;
            const recordDate = recordDateString ? new Date(recordDateString).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];

            let amountH = 0;
            let amountM = 0;
            
            if (isNaN(totalAmount) || totalAmount <= 0 || !description) {
                errorMessageElement.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆç¸½é‡‘é¡å’Œæè¿°ã€‚';
                errorMessageElement.classList.remove('hidden');
                return;
            }

            if (splitType === 'equal') {
                amountH = totalAmount / 2;
                amountM = totalAmount / 2;
            } else {
                amountH = parseFloat(amountHInput.value) || 0;
                amountM = parseFloat(amountMInput.value) || 0;
                
                // æª¢æŸ¥è‡ªè¨‚é‡‘é¡æ˜¯å¦èˆ‡ç¸½é‡‘é¡åŒ¹é…
                if (Math.abs((amountH + amountM) - totalAmount) > 0.01) {
                    errorMessageElement.textContent = `è‡ªè¨‚é‡‘é¡ç¸½å’Œ (${(amountH + amountM).toFixed(2)}) èˆ‡ç¸½é‡‘é¡ (${totalAmount.toFixed(2)}) ä¸ç¬¦ï¼è«‹æª¢æŸ¥ã€‚`;
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
            }

            // 1. è¨ˆç®—è©²äº¤æ˜“çš„æ·¨æ¬ æ¬¾è®Šå‹• (ä½¿ç”¨åŸå¹£åˆ¥)
            let netDebtChange = 0; // æ·¨æ¬ æ¬¾è®Šå‹• (M æ¬  H çš„é‡‘é¡è®ŠåŒ–)

            if (payer === 'H') {
                // H ä»˜æ¬¾, M æ‡‰ä»˜ amountMï¼Œå› æ­¤ M æ¬  H å¢åŠ äº† amountM
                netDebtChange = amountM; 
            } else { // payer === 'M'
                // M ä»˜æ¬¾, H æ‡‰ä»˜ amountHï¼Œå› æ­¤ H æ¬  M å¢åŠ äº† amountHï¼Œå³ M æ¬  H æ¸›å°‘äº† amountH (è² æ•¸)
                netDebtChange = -amountH;
            }
            
            // 2. åŒ¯ç‡è½‰æ›
            let netDebtChangeTWD = netDebtChange;
            let conversionRate = 1;
            
            if (currency !== BASE_CURRENCY) {
                if (RATES_LOADING || !EXCHANGE_RATES) {
                    errorMessageElement.textContent = `åŒ¯ç‡ä»åœ¨è¼‰å…¥ä¸­ï¼Œæˆ–è¼‰å…¥å¤±æ•—ã€‚è«‹ç¨å€™å†è©¦ï¼Œæˆ–ä½¿ç”¨æ–°å°å¹£ (TWD) é€²è¡Œè·¨å¹£åˆ¥äº¤æ˜“ã€‚`;
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
                
                // ç²å–è½‰æ›ç‡ä¸¦è¨ˆç®— TWD æ·¨æ¬ æ¬¾è®Šå‹•
                conversionRate = getConversionRateToTWD(currency);
                
                if (conversionRate === 0) {
                     errorMessageElement.textContent = `ç„¡æ³•å–å¾— ${currency} å…Œ ${BASE_CURRENCY} çš„åŒ¯ç‡ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`;
                     errorMessageElement.classList.remove('hidden');
                     return;
                }

                netDebtChangeTWD = netDebtChange * conversionRate;
            }

            try {
                // 1. å¯«å…¥æ–°ç´€éŒ„
                await addDoc(getExpensesCollectionRef(), {
                    totalAmount: totalAmount,
                    currency: currency,
                    payer: payer, 
                    description: description,
                    splitType: splitType,
                    amountH: amountH, 
                    amountM: amountM, 
                    netDebtChange: netDebtChange,        // åŸå¹£åˆ¥çš„æ·¨æ¬ æ¬¾è®Šå‹•
                    netDebtChangeTWD: netDebtChangeTWD,  // TWD ç­‰å€¼æ·¨è®Šå‹•
                    conversionRate: conversionRate,      // TWD è½‰æ›ç‡ (1 Foreign = X TWD)
                    recordDate: recordDate, 
                    recordTimestamp: serverTimestamp(), 
                    recordedBy: userId,
                });
                
                // 2. æ›´æ–°ç¸½æ¬ æ¬¾ (è®€å– -> è¨ˆç®— -> å¯«å…¥)
                const balanceDocRef = getBalanceDocRef();
                
                const balanceDocSnapshot = await getDoc(balanceDocRef);
                let currentBalance = 0;

                if (balanceDocSnapshot.exists()) {
                    // ç¸½æ¬ æ¬¾ balance å·²ç¶“å›ºå®šç‚º TWD å–®ä½
                    currentBalance = balanceDocSnapshot.data().balance || 0;
                }
                
                // ç¸½æ¬ æ¬¾ç›´æ¥åŠ ä¸Š TWD ç­‰å€¼çš„æ·¨è®Šå‹•
                const newBalance = currentBalance + netDebtChangeTWD; 

                // ç¸½æ¬ æ¬¾çš„å¹£åˆ¥æ‡‰å›ºå®šç‚º BASE_CURRENCY (TWD)
                await setDoc(balanceDocRef, {
                    balance: newBalance,
                    currency: BASE_CURRENCY, // å›ºå®šç‚º TWD
                    lastUpdated: serverTimestamp(),
                }, { merge: true });

                // é‡è¨­è¡¨å–®
                expenseForm.reset();
                document.getElementById('recordDate').valueAsDate = new Date();
                splitTypeSelect.value = 'equal';
                customSplitFields.classList.add('hidden');
                totalAmountInput.focus();

            } catch (error) {
                handleFirebaseError(error, 'å„²å­˜ç´€éŒ„èˆ‡æ›´æ–°æ¬ æ¬¾');
            }
        });
        
        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        window.onload = initFirebase;
        
    </script>
</body>
</html>

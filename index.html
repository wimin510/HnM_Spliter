<!DOCTYPE html>
<html lang="zh-Hant" class="bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬ HnM Spliter v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .soft-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 6px -2px rgba(0, 0, 0, 0.02); }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' },
                        primary: { DEFAULT: '#475569', dark: '#334155' },
                        accent: { teal: '#2dd4bf', rose: '#fb7185', blue: '#93c5fd', orange: '#fdba74' }
                    },
                    boxShadow: { 'soft-xl': '0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.02)' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex justify-center items-start text-slate-700 overflow-x-hidden">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ (v1.1) -->
    <div id="main-app" class="w-full max-w-[500px] space-y-6 my-4 p-4 sm:p-6 transition-opacity duration-500">
        
        <!-- æ¨™é¡Œèˆ‡ç™»å‡º -->
        <div class="flex justify-between items-center px-2">
            <div>
                 <h1 class="text-2xl font-black text-slate-800 tracking-tight flex items-center">
                    <span id="display-room-id" class="mr-2">demo å¸³æœ¬</span>
                </h1>
                <p class="text-[10px] text-slate-400 font-medium flex items-center gap-1">
                    <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                    <span id="connection-status">é€£ç·šä¸­...</span>
                </p>
            </div>
            <!-- v1.1 ä¸æ”¯æ´ç™»å‡ºï¼Œä¿ç•™é¡¯ç¤º -->
        </div>

        <!-- ç¸½æ¬ æ¬¾å¡ç‰‡ -->
        <div id="balance-card" class="relative overflow-hidden bg-slate-850 rounded-[2rem] shadow-soft-xl p-8 text-white transition-all duration-500 group">
            <div id="balance-indicator-bar" class="absolute left-0 top-0 bottom-0 w-2 bg-slate-700 transition-colors duration-500"></div>
            <div class="relative z-10 pl-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-sm font-medium text-slate-400 mb-1 tracking-wider uppercase">Current Status</p>
                        <h2 id="balance-status-text" class="text-xl font-bold flex items-center">
                            <span id="status-icon" class="mr-2 text-2xl">âš–ï¸</span>
                            <span>è¼‰å…¥ä¸­...</span>
                        </h2>
                    </div>
                    <div class="text-right bg-slate-800/50 p-2 rounded-xl backdrop-blur-sm border border-slate-700/50 text-xs text-slate-300">
                         <div id="rates-display" class="space-y-0.5 font-mono opacity-80">
                            <!-- ä¿®æ­£ï¼šå°‡ä»Šæ—¥åŒ¯ç‡æ–‡å­—åŠ å…¥ï¼Œä¸¦é è¨­é¡¯ç¤ºè¼‰å…¥ä¸­ -->
                            <div class="font-bold text-slate-400 mb-1">ä»Šæ—¥åŒ¯ç‡</div>
                            <div id="rate-usd">è¼‰å…¥ä¸­...</div>
                            <div id="rate-jpy">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-baseline mt-6">
                    <span class="text-5xl font-black tracking-tighter tabular-nums" id="balance-amount">---</span>
                    <span class="text-lg font-bold ml-2 text-slate-400">TWD</span>
                </div>
                <button id="clear-balance-btn" class="absolute bottom-6 right-8 text-white bg-slate-600 hover:bg-slate-700 font-bold py-2 px-4 rounded-full text-sm transition-all shadow-md disabled:opacity-0 disabled:pointer-events-none transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100" disabled>
                    ğŸ¤ ä¸€éµçµæ¸…
                </button>
            </div>
            <div id="balance-glow" class="absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-slate-700/20 rounded-full blur-3xl pointer-events-none transition-colors duration-500"></div>
        </div>

        <!-- è¨­å®šèˆ‡åŠŸèƒ½å€å¡Š -->
        <div class="bg-white rounded-2xl soft-shadow border border-slate-100 overflow-hidden">
            <button id="toggle-settings" class="w-full flex justify-between items-center p-4 px-6 hover:bg-slate-50 transition-colors group">
                <span class="font-bold text-slate-700 flex items-center text-sm">
                    âš™ï¸ æˆå“¡åç¨±è¨­å®š
                </span>
                <svg id="settings-icon" class="w-4 h-4 text-slate-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="settings-panel" class="hidden p-6 pt-2 space-y-4 border-t border-slate-100 bg-slate-50/50">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">æˆå“¡ H</label>
                        <input type="text" id="h-name-input" class="block w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm" placeholder="è¼¸å…¥åç¨±...">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">æˆå“¡ M</label>
                        <input type="text" id="m-name-input" class="block w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm" placeholder="è¼¸å…¥åç¨±...">
                    </div>
                </div>
                <button id="save-names-btn" class="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded-lg">æ›´æ–°åç¨±</button>
            </div>
        </div>

        <!-- æ–°å¢/ç·¨è¼¯ç´€éŒ„è¡¨å–® -->
        <div id="form-container" class="bg-white rounded-[2rem] soft-shadow border border-slate-100 p-6 relative overflow-hidden scroll-mt-4">
            <div id="form-mode-indicator" class="hidden absolute top-0 left-0 right-0 h-1.5 bg-amber-400 animate-pulse"></div>
            
            <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center justify-between relative z-10">
                <span class="flex items-center">
                    <span id="form-icon" class="bg-slate-800 text-white rounded-lg w-6 h-6 flex items-center justify-center text-sm mr-2 shadow-sm">ğŸ“</span>
                    <span id="form-title">è¨˜ä¸Šä¸€ç­†</span>
                </span>
                <button id="cancel-edit-btn" class="hidden text-xs font-bold text-slate-400 hover:text-slate-600 px-2 py-1 rounded bg-slate-100 transition-colors">å–æ¶ˆ</button>
            </h3>
            
            <form id="expense-form" class="space-y-6 relative z-10">
                <div class="grid grid-cols-2 gap-3">
                    <label class="relative cursor-pointer group">
                        <input type="radio" name="payer" value="H" class="peer sr-only" checked>
                        <div class="flex items-center justify-center p-3 rounded-xl border border-slate-200 bg-slate-50 peer-checked:bg-accent-blue peer-checked:text-white peer-checked:border-accent-blue transition-all">
                            <span id="payer-h-label" class="font-bold text-sm">æˆå“¡ H</span>
                        </div>
                    </label>
                    <label class="relative cursor-pointer group">
                        <input type="radio" name="payer" value="M" class="peer sr-only">
                        <div class="flex items-center justify-center p-3 rounded-xl border border-slate-200 bg-slate-50 peer-checked:bg-accent-orange peer-checked:text-white peer-checked:border-accent-orange transition-all">
                            <span id="payer-m-label" class="font-bold text-sm">æˆå“¡ M</span>
                        </div>
                    </label>
                </div>

                <div class="relative rounded-xl shadow-sm ring-1 ring-slate-200 focus-within:ring-2 focus-within:ring-primary transition-shadow">
                    <input type="number" id="totalAmount" step="0.01" min="0" required class="block w-full p-4 pl-4 pr-24 text-2xl font-black text-slate-800 bg-white border-0 rounded-xl focus:ring-0 placeholder:text-slate-300" placeholder="0.00">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                         <select id="currency" class="h-full py-0 pl-2 pr-7 border-0 bg-transparent text-slate-500 font-bold text-sm focus:ring-0 cursor-pointer text-right">
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2">
                        <input type="text" id="description" required class="block w-full p-3 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:outline-none" placeholder="ç”¨é€” (å¦‚: æ™šé¤)">
                    </div>
                     <div>
                        <input type="date" id="recordDate" required class="block w-full p-3 bg-white border border-slate-200 rounded-xl text-sm text-center focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                </div>

                <div>
                    <select id="splitType" class="w-full p-2 bg-slate-50 border-0 rounded-lg text-xs font-bold text-slate-500 focus:ring-0 cursor-pointer mb-2">
                        <option value="equal">âš–ï¸ å¹³å‡åˆ†æ”¤</option>
                        <option value="custom">âœï¸ è‡ªè¨‚é‡‘é¡</option>
                    </select>
                    <div id="custom-split-area" class="hidden grid grid-cols-2 gap-3 mt-2">
                        <div class="flex items-center bg-slate-50 rounded-lg px-2 border border-slate-200">
                            <span class="text-xs font-bold text-slate-400 mr-2">H</span>
                            <input type="number" id="amountH" step="0.01" class="w-full p-2 bg-transparent text-sm font-bold text-right focus:outline-none" placeholder="0">
                        </div>
                        <div class="flex items-center bg-slate-50 rounded-lg px-2 border border-slate-200">
                            <span class="text-xs font-bold text-slate-400 mr-2">M</span>
                            <input type="number" id="amountM" step="0.01" class="w-full p-2 bg-transparent text-sm font-bold text-right focus:outline-none" placeholder="0">
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-md hover:bg-primary-dark transition-all active:scale-[0.98] disabled:opacity-50">
                    ç¢ºèªå„²å­˜
                </button>
            </form>
        </div>

        <!-- æ­·å²ç´€éŒ„ -->
        <div>
            <h3 class="text-sm font-bold text-slate-400 mb-3 px-2 uppercase tracking-wider">æ­·å²ç´€éŒ„</h3>
            <div id="records-list" class="space-y-3">
                <div class="text-center text-slate-400 py-8 text-xs bg-white rounded-2xl border border-dashed border-slate-200">è¼‰å…¥ä¸­...</div>
            </div>
            <button id="load-more-btn" class="w-full mt-4 py-2 text-xs font-bold text-slate-400 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors hidden">
                æŸ¥çœ‹æ›´å¤šç´€éŒ„
            </button>
        </div>

    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-[2rem] shadow-2xl w-80 max-w-full mx-4">
            <div id="modal-icon" class="text-3xl mb-2 text-center">ğŸ¤”</div>
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-2 text-center">æç¤º</h3>
            <p id="modal-msg" class="text-sm text-slate-600 mb-6 text-center leading-relaxed">è¨Šæ¯å…§å®¹</p>
            <div id="modal-buttons" class="flex space-x-3">
                <!-- å–®ç´”é—œé–‰æŒ‰éˆ•ï¼Œæ–‡å­—ç‚ºã€Œç¢ºèªã€ -->
                <button id="modal-close-btn" class="flex-1 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold">ç¢ºèª</button>
                <button id="modal-action-btn" class="flex-1 py-2 bg-accent-teal text-white rounded-lg text-sm font-bold hidden">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, deleteDoc, getDoc, collection, query, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Config ---
        let firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCRHx0i02nojkN5-y5HxS3P3i1jA5SEy8E",
            authDomain: "hnm-spliter.firebaseapp.com",
            projectId: "hnm-spliter",
            storageBucket: "hnm-spliter.firebasestorage.app",
            messagingSenderId: "514297368344",
            appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d",
            measurementId: "G-4DY12810X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ç‹€æ…‹
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const currentRoomId = 'demo'; 
        
        let currentUser = null;
        let exchangeRates = { TWD: 1, USD: 32, JPY: 0.21 }; // Fallback rates for calculation (USD/JPY to TWD)
        let currentBalanceTWD = 0;
        let partyNames = { H: 'æˆå“¡ H', M: 'æˆå“¡ M' };
        let editingId = null; 
        let editingNetChange = 0;
        let expensesLimit = 5; 

        // --- 2. DOM ---
        const els = {
            mainApp: document.getElementById('main-app'),
            displayRoomId: document.getElementById('display-room-id'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('connection-status'),
            balanceAmount: document.getElementById('balance-amount'),
            balanceText: document.getElementById('balance-status-text'),
            balanceCard: document.getElementById('balance-card'),
            balanceIndicator: document.getElementById('balance-indicator-bar'),
            balanceGlow: document.getElementById('balance-glow'),
            statusIcon: document.getElementById('status-icon'),
            ratesDisplay: document.getElementById('rates-display'),
            rateUsd: document.getElementById('rate-usd'), // æ–°å¢ DOM å…ƒç´ 
            rateJpy: document.getElementById('rate-jpy'), // æ–°å¢ DOM å…ƒç´ 
            clearBalanceBtn: document.getElementById('clear-balance-btn'),
            list: document.getElementById('records-list'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            form: document.getElementById('expense-form'),
            date: document.getElementById('recordDate'),
            currency: document.getElementById('currency'),
            totalAmount: document.getElementById('totalAmount'),
            desc: document.getElementById('description'),
            splitType: document.getElementById('splitType'),
            customSplitArea: document.getElementById('custom-split-area'),
            amountH: document.getElementById('amountH'),
            amountM: document.getElementById('amountM'),
            submitBtn: document.getElementById('submit-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            formTitle: document.getElementById('form-title'),
            formIcon: document.getElementById('form-icon'),
            formModeIndicator: document.getElementById('form-mode-indicator'),
            toggleSettings: document.getElementById('toggle-settings'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsIcon: document.getElementById('settings-icon'),
            hNameInput: document.getElementById('h-name-input'),
            mNameInput: document.getElementById('m-name-input'),
            saveNamesBtn: document.getElementById('save-names-btn'),
            payerHLabel: document.getElementById('payer-h-label'),
            payerMLabel: document.getElementById('payer-m-label'),
            modal: document.getElementById('modal'),
            modalIcon: document.getElementById('modal-icon'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-msg'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalActionBtn: document.getElementById('modal-action-btn')
        };

        // --- 3. è³‡æ–™åº«è·¯å¾‘ ---
        const getBasePath = () => `artifacts/${appId}/public/data/rooms/${currentRoomId}`;
        const getExpensesRef = () => collection(db, `${getBasePath()}/expenses`);
        const getBalanceRef = () => doc(db, `${getBasePath()}/ledger/balance`);
        const getSettingsRef = () => doc(db, `${getBasePath()}/ledger/settings`);


        // --- 4. æ ¸å¿ƒåŠŸèƒ½ ---

        const subscribeExpenses = () => {
            els.loadMoreBtn.textContent = 'è¼‰å…¥ä¸­...';
            els.loadMoreBtn.disabled = true;
            
            // Note: Cannot use orderBy('createdAt', 'desc') without an index, so we sort in client if needed.
            const q = query(getExpensesRef(), limit(expensesLimit));
            
            onSnapshot(q, (snapshot) => {
                const docs = snapshot.docs;
                if (docs.length >= expensesLimit) {
                    els.loadMoreBtn.classList.remove('hidden');
                    els.loadMoreBtn.textContent = 'æŸ¥çœ‹æ›´å¤šç´€éŒ„';
                    els.loadMoreBtn.disabled = false;
                } else {
                    els.loadMoreBtn.classList.add('hidden');
                }
                
                // å¿…é ˆåœ¨å®¢æˆ¶ç«¯æ’åºï¼Œä»¥é¿å… Firestore ç´¢å¼•å•é¡Œ
                docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                renderList(docs);
            }, (e) => {
                console.error("Expenses listener error", e);
            });
        };
        
        const initRoomListeners = () => {
            // 1. é¤˜é¡ç›£è½
            onSnapshot(getBalanceRef(), (doc) => {
                renderBalance(doc.exists() ? doc.data().amount : 0);
            });

            // 2. è¨­å®šç›£è½
            onSnapshot(getSettingsRef(), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    partyNames.H = data.H || 'æˆå“¡ H';
                    partyNames.M = data.M || 'æˆå“¡ M';
                    updateNamesUI();
                }
            });

            // 3. äº¤æ˜“åˆ—è¡¨ç›£è½
            subscribeExpenses();
        };


        // --- 5. å…±ç”¨ UI é‚è¼¯ ---
        window.closeModal = () => {
            els.modal.classList.add('hidden');
            els.modal.classList.remove('flex');
            els.modalActionBtn.classList.add('hidden');
            // å°‡é è¨­é—œé–‰æŒ‰éˆ•æ–‡å­—è¨­å®šç‚ºã€Œç¢ºèªã€ï¼Œä¸¦ä½¿ç”¨ä¸»è‰²æ¨£å¼
            els.modalCloseBtn.className = 'w-full py-2 bg-slate-800 text-white rounded-lg font-bold';
            els.modalCloseBtn.textContent = 'ç¢ºèª'; 
        };
        const showModal = (title, msg) => {
            els.modalIcon.textContent = title.includes('éŒ¯èª¤') ? 'âŒ' : (title.includes('æˆåŠŸ') ? 'âœ…' : 'ğŸ¤”');
            els.modalTitle.textContent = title;
            els.modalMsg.innerHTML = msg;
            els.modal.classList.remove('hidden');
            els.modal.classList.add('flex');
            els.modalCloseBtn.onclick = closeModal;
            // ç¢ºä¿å–®ç´”æç¤ºæ™‚ï¼Œé—œé–‰æŒ‰éˆ•æ˜¯ä¸»æŒ‰éˆ•æ¨£å¼
            els.modalCloseBtn.className = 'w-full py-2 bg-slate-800 text-white rounded-lg text-sm font-bold';
            els.modalCloseBtn.textContent = 'ç¢ºèª';
        };
        const showConfirm = (title, msg, actionText, callback) => {
            showModal(title, msg);
            els.modalActionBtn.classList.remove('hidden');
            els.modalActionBtn.textContent = actionText;
            els.modalActionBtn.onclick = () => { closeModal(); callback(); };
            // è¦†è“‹æ¨£å¼ä»¥é¡¯ç¤ºå…©å€‹æŒ‰éˆ•
            els.modalCloseBtn.className = 'flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold';
            els.modalCloseBtn.textContent = 'å–æ¶ˆ'; // ç¢ºèªæ“ä½œæ™‚ï¼Œå–æ¶ˆæŒ‰éˆ•æ–‡å­—ä»ç‚ºã€Œå–æ¶ˆã€
            els.modalActionBtn.className = 'flex-1 py-2 bg-accent-teal text-white rounded-lg font-bold';
        };
        const updateNamesUI = () => {
            els.payerHLabel.textContent = partyNames.H;
            els.payerMLabel.textContent = partyNames.M;
            if(!els.hNameInput.value) els.hNameInput.placeholder = partyNames.H;
            if(!els.mNameInput.value) els.mNameInput.placeholder = partyNames.M;
            renderBalance(currentBalanceTWD);
        };
        const renderBalance = (balance) => {
            currentBalanceTWD = balance;
            const val = Math.abs(balance);
            els.balanceAmount.textContent = val.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            els.balanceCard.className = "relative overflow-hidden rounded-[2rem] shadow-soft-xl p-8 text-white transition-all duration-500 group bg-gradient-to-br";
            if (balance > 5) {
                els.balanceCard.classList.add('from-emerald-600', 'to-teal-800');
                els.balanceText.innerHTML = `<span class="mr-2 text-2xl">ğŸ‰</span><span>${partyNames.M} æ¬  ${partyNames.H}</span>`;
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-accent-teal";
            } else if (balance < -5) {
                els.balanceCard.classList.add('from-rose-600', 'to-red-800');
                els.balanceText.innerHTML = `<span class="mr-2 text-2xl">ğŸ’¸</span><span>${partyNames.H} æ¬  ${partyNames.M}</span>`;
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-accent-rose";
            } else {
                els.balanceCard.classList.add('from-gray-600', 'to-gray-800');
                els.balanceText.innerHTML = `<span class="mr-2 text-2xl">âš–ï¸</span><span>ç›®å‰å…©æ¸…</span>`;
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-slate-600";
            }
            els.clearBalanceBtn.disabled = Math.abs(balance) < 5;
            els.clearBalanceBtn.className = `absolute bottom-6 right-8 text-white bg-slate-600 hover:bg-slate-700 font-bold py-2 px-4 rounded-full text-sm transition-all shadow-md transform ${Math.abs(balance) > 5 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2 pointer-events-none'}`;
        };

        const renderList = (docs) => {
            if (docs.length === 0) {
                els.list.innerHTML = '<div class="text-center text-slate-400 py-8 text-xs bg-white rounded-2xl border border-dashed border-slate-200">æ­¤å¸³æœ¬å°šç„¡ç´€éŒ„</div>';
                return;
            }
            els.list.innerHTML = docs.map(doc => {
                const data = doc.data();
                const date = new Date(data.date).toLocaleDateString(undefined, {month:'numeric', day:'numeric'});
                const isPayerH = data.payer === 'H';
                const payerName = isPayerH ? partyNames.H : partyNames.M;
                let iconBg = isPayerH ? 'bg-accent-blue/10 text-accent-blue' : 'bg-accent-orange/10 text-accent-orange';
                let desc = data.description;
                if(desc === 'çµæ¸…æ¬ æ¬¾') iconBg = 'bg-slate-200 text-slate-600';
                
                // --- ä¿®æ­£èˆ‡å„ªåŒ–: å¤–å¹£æ›ç®—å°å¹£é¡¯ç¤ºé‚è¼¯ ---
                let twdDisplay = '';
                let effectiveTWD = data.totalTWD; // å„ªå…ˆä½¿ç”¨å„²å­˜åœ¨è³‡æ–™åº«çš„ totalTWD
                let rateToUse = data.rate;

                // æª¢æŸ¥æ˜¯å¦ç‚ºå¤–å¹£ä¸”ç¼ºå°‘ totalTWD / rate (èˆŠè³‡æ–™å•é¡Œ)
                if (data.currency !== 'TWD' && (!effectiveTWD || !rateToUse)) {
                    // 1. ä½¿ç”¨ Fallback Rate é€²è¡Œå³æ™‚ä¼°ç®—
                    rateToUse = exchangeRates[data.currency] || 1; // ä½¿ç”¨è¼‰å…¥çš„åŒ¯ç‡ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨ TWD=1
                    effectiveTWD = data.originalAmount * rateToUse;

                    // 2. é¡¯ç¤ºä¿®æ­£æç¤ºå’Œä¼°ç®—å€¼
                    const formattedTWD = effectiveTWD.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
                    
                    // é¡¯ç¤ºä¼°ç®—å€¼å’Œé»æ“Šä¿®æ­£æŒ‰éˆ•
                    twdDisplay = `
                        <button onclick="window.fixRecord('${doc.id}', ${data.originalAmount}, '${data.currency}')" class="text-xs text-rose-500 font-semibold hover:text-rose-700 focus:outline-none focus:ring-1 focus:ring-rose-500/50 rounded-md -mt-1 py-0.5 px-1 bg-rose-50/50 border border-rose-200">
                           ç´„ ${formattedTWD} TWD (ä¼°è¨ˆ/é»æ­¤ä¿®æ­£)
                        </button>
                    `;
                } else if (data.currency !== 'TWD' && effectiveTWD) {
                    // å¦‚æœæœ‰ totalTWD (æ–°è³‡æ–™æˆ–å·²ä¿®æ­£)ï¼Œå‰‡æ­£å¸¸é¡¯ç¤º
                    const formattedTWD = effectiveTWD.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
                    twdDisplay = `<div class="text-[10px] text-slate-400 mt-0.5">ç´„ ${formattedTWD} TWD</div>`;
                }
                // ------------------------------------

                const jsonData = JSON.stringify({id: doc.id, ...data}).replace(/"/g, '&quot;');
                return `
                <div class="group flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 soft-shadow hover:-translate-y-0.5 hover:shadow-md transition-all">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <div class="flex-shrink-0 flex flex-col items-center justify-center w-10 h-10 rounded-xl ${iconBg} font-black text-sm">
                            ${data.payer}
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-slate-800 text-sm truncate">${desc}</div>
                            <div class="text-[10px] font-medium text-slate-400 mt-0.5 flex items-center">
                                <span class="${isPayerH ? 'text-accent-blue' : 'text-accent-orange'} mr-1">${payerName}</span>
                                <span class="font-mono">${date}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 pl-2">
                        <div class="text-right">
                            <div class="font-black text-slate-800 text-base tabular-nums">${data.originalAmount.toLocaleString()} <span class="text-[10px] text-slate-400">${data.currency}</span></div>
                            ${twdDisplay}
                        </div>
                        <div class="flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editEx('${jsonData}')" class="p-1 bg-slate-100 text-slate-400 hover:text-slate-600 rounded"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="window.delEx('${doc.id}', ${data.netChangeForM}, '${desc}')" class="p-1 bg-red-50 text-red-400 hover:text-red-600 rounded"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };

        // äº‹ä»¶ï¼šä¿®æ­£èˆŠè³‡æ–™ (v0.8 æ–°å¢)
        window.fixRecord = (id, originalAmount, currency) => {
             // å–å¾—ç›®å‰çš„å³æ™‚åŒ¯ç‡
            const rate = exchangeRates[currency];
            const twdAmount = originalAmount * rate;
            
            showConfirm(
                'ä¿®æ­£å¤–å¹£ç´€éŒ„', 
                `ã€Œ${currency} ${originalAmount.toLocaleString()}ã€æ›ç®—ç‚ºå°å¹£çš„æ¬„ä½éºå¤±ã€‚<br>å°‡ä½¿ç”¨ç›®å‰çš„å³æ™‚åŒ¯ç‡ (1 ${currency} â‰‰ ${rate.toFixed(2)} TWD) ä¿®æ­£ç‚º **TWD ${twdAmount.toFixed(0)}**ã€‚`, 
                'ç¢ºèªä¿®æ­£', 
                async () => {
                    try {
                         // 1. è¨ˆç®— netChangeForM
                        const expenseDoc = await getDoc(doc(db, getExpensesRef().path, id));
                        if (!expenseDoc.exists()) throw new Error("ç´€éŒ„ä¸å­˜åœ¨");

                        const data = expenseDoc.data();
                        
                        // ç¢ºä¿ netChangeForM æ˜¯æ ¹æ“š *æ–°çš„ totalTWD* è¨ˆç®—
                        let netChangeForM;
                        // é€™è£¡å‡è¨­èˆŠè³‡æ–™çš„ splitType é»˜èªç‚º equal (å› ç‚ºèˆŠè³‡æ–™æ²’æœ‰å„²å­˜ custom details)
                        const amountToM = twdAmount / 2; // Mæ‡‰åˆ†æ”¤çš„ TWD æˆæœ¬
                        const amountToH = twdAmount / 2; // Hæ‡‰åˆ†æ”¤çš„ TWD æˆæœ¬

                        if (data.payer === 'H') {
                            netChangeForM = amountToM; 
                        } else { // Payer is M
                            netChangeForM = -amountToH; 
                        }
                        
                        // 2. æ›´æ–° Firestore ç´€éŒ„ï¼Œè£œä¸Š totalTWD å’Œ rateï¼Œä¸¦ä¿®æ­£ netChangeForM
                        await setDoc(doc(db, getExpensesRef().path, id), {
                            rate: parseFloat(rate.toFixed(4)),
                            totalTWD: parseFloat(twdAmount.toFixed(2)),
                            // ç”±æ–¼ netChangeForM æ˜¯æ ¹æ“š TWD ç¸½é¡é‡æ–°è¨ˆç®—çš„ï¼Œæ‰€ä»¥éœ€è¦æ›´æ–°
                            netChangeForM: parseFloat(netChangeForM.toFixed(2)),
                            lastFixedAt: serverTimestamp() // æ¨™è¨˜ç‚ºå·²ä¿®æ­£
                        }, {merge:true});

                        // 3. æ›´æ–° Balance (é€™æ˜¯æœ€è¤‡é›œçš„ä¸€æ­¥ï¼Œéœ€è¦å…ˆå›æ»¾èˆŠçš„ netChange)
                        const oldNetChange = data.netChangeForM || (data.payer === 'H' ? data.originalAmount / 2 : -data.originalAmount / 2); // ä¼°è¨ˆèˆŠçš„ netChange
                        
                        const bRef = getBalanceRef();
                        const snap = await getDoc(bRef);
                        const currentBal = snap.exists() ? snap.data().amount : 0;

                        // New Balance = Current Balance - Old Net Change + New Net Change
                        const newBal = currentBal - oldNetChange + netChangeForM;
                        await setDoc(bRef, {amount: newBal, lastUpdated: serverTimestamp()});

                        showModal('ä¿®æ­£å®Œæˆ', `å·²ä½¿ç”¨ ${currency} â‰‰ ${rate.toFixed(2)} TWD ä¿®æ­£ç´€éŒ„ä¸¦æ›´æ–°ç¸½é¤˜é¡ï¼`);
                    } catch(e) {
                        console.error(e); 
                        showModal('éŒ¯èª¤', 'ä¿®æ­£å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°è¼‰å…¥ã€‚');
                    }
                }
            );
        };

        // Events
        els.loadMoreBtn.addEventListener('click', () => {
            expensesLimit += 10;
            subscribeExpenses();
        });

        // ç•¶ç¸½é‡‘é¡è®Šå‹•æ™‚ï¼Œè‡ªå‹•è¨ˆç®— M çš„é‡‘é¡ (å‡è¨­ H æ˜¯ç„¦é»)
        els.totalAmount.addEventListener('input', () => { 
            if(els.splitType.value==='custom'){ 
                const t = parseFloat(els.totalAmount.value)||0; 
                // M = ç¸½é‡‘é¡ - H çš„é‡‘é¡
                els.amountM.value=(t-(parseFloat(els.amountH.value)||0)).toFixed(2); 
            }
        });
        
        // ç•¶ H é‡‘é¡è®Šå‹•æ™‚ï¼Œè‡ªå‹•è¨ˆç®— M çš„é‡‘é¡
        els.amountH.addEventListener('input', () => { 
            if(els.splitType.value==='custom'){ 
                const t = parseFloat(els.totalAmount.value)||0; 
                // M = ç¸½é‡‘é¡ - H çš„é‡‘é¡
                els.amountM.value=(t-(parseFloat(els.amountH.value)||0)).toFixed(2); 
            }
        });
        
        // ç•¶ M é‡‘é¡è®Šå‹•æ™‚ï¼Œè‡ªå‹•è¨ˆç®— H çš„é‡‘é¡
        els.amountM.addEventListener('input', () => { 
            if(els.splitType.value==='custom'){ 
                const total = parseFloat(els.totalAmount.value)||0; 
                const amountM = parseFloat(els.amountM.value)||0;
                // H = ç¸½é‡‘é¡ - M çš„é‡‘é¡
                els.amountH.value = (total - amountM).toFixed(2); 
            }
        });
        
        window.editEx = (json) => {
            const data = JSON.parse(json.replace(/&quot;/g, '"'));
            editingId = data.id; editingNetChange = data.netChangeForM;
            els.formTitle.textContent = 'ç·¨è¼¯ä¸­'; els.formIcon.textContent = 'âœï¸';
            els.submitBtn.textContent = 'æ›´æ–°ç´€éŒ„'; els.submitBtn.classList.add('bg-amber-500');
            els.cancelEditBtn.classList.remove('hidden');
            els.formModeIndicator.classList.remove('hidden');
            
            els.date.value = data.date; els.currency.value = data.currency;
            els.totalAmount.value = data.originalAmount; els.desc.value = data.description;
            document.querySelector(`input[name="payer"][value="${data.payer}"]`).checked = true;
            els.splitType.value = data.splitType;
            if(data.splitType === 'custom') {
                els.customSplitArea.classList.remove('hidden');
                // Note: v0.9: é€™è£¡ä½¿ç”¨å„²å­˜çš„ custom amount
                els.amountH.value = data.customAmountH ? data.customAmountH.toFixed(2) : (data.originalAmount/2).toFixed(2); 
                els.amountM.value = data.customAmountM ? data.customAmountM.toFixed(2) : (data.originalAmount/2).toFixed(2);
            } else els.customSplitArea.classList.add('hidden');
            els.form.scrollIntoView({behavior:'smooth'});
        };
        
        window.delEx = (id, netChange, desc) => {
            showConfirm('åˆªé™¤', `ç¢ºå®šåˆªé™¤ã€Œ${desc}ã€ï¼Ÿ<br>é¤˜é¡å°‡è‡ªå‹•å›æ»¾ã€‚`, 'åˆªé™¤', async () => {
                try {
                    await deleteDoc(doc(db, getExpensesRef().path, id));
                    const bRef = getBalanceRef();
                    const snap = await getDoc(bRef);
                    const cur = snap.exists() ? snap.data().amount : 0;
                    // v0.9 logic: subtract the original netChange
                    await setDoc(bRef, {amount: cur - netChange, lastUpdated: serverTimestamp()}); 
                    showModal('å·²åˆªé™¤', 'ç´€éŒ„å·²ç§»é™¤');
                } catch(e) { console.error(e); showModal('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—'); }
            });
        };

        els.cancelEditBtn.onclick = (e) => {
            e.preventDefault();
            editingId = null; editingNetChange = 0;
            els.form.reset(); els.date.valueAsDate = new Date();
            els.formTitle.textContent = 'è¨˜ä¸Šä¸€ç­†'; els.formIcon.textContent = 'ğŸ“';
            els.submitBtn.textContent = 'ç¢ºèªå„²å­˜'; els.submitBtn.classList.remove('bg-amber-500');
            els.cancelEditBtn.classList.add('hidden'); els.formModeIndicator.classList.add('hidden');
            els.customSplitArea.classList.add('hidden');
        };

        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = {
                date: els.date.value, currency: els.currency.value,
                total: parseFloat(els.totalAmount.value), payer: document.querySelector('input[name="payer"]:checked').value,
                desc: els.desc.value.trim(), split: els.splitType.value
            };
            if(!fd.date || isNaN(fd.total) || !fd.desc) return showModal('éŒ¯èª¤', 'è³‡æ–™ä¸å®Œæ•´');
            
            let rate = 1;
            if(fd.currency !== 'TWD') {
                if(!exchangeRates || !exchangeRates[fd.currency]) return showModal('éŒ¯èª¤', 'åŒ¯ç‡æœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                rate = exchangeRates[fd.currency];
            }
            // totalTWD: ç”¨æ–¼å„²å­˜åˆ°è³‡æ–™åº«ä¸¦åœ¨åˆ—è¡¨é¡¯ç¤º (ä»¥ TWD ç‚ºå–®ä½çš„ç¸½é¡)
            const totalTWD = fd.total * rate; 
            
            let amtM = 0, amtH = 0; // amtM/amtH æ˜¯æ›ç®—æˆ TWD å¾Œï¼ŒM/H æ‡‰åˆ†æ”¤çš„æˆæœ¬
            let customAmountH = 0, customAmountM = 0; // åŸå§‹å¹£åˆ¥çš„ custom amount (v0.9 ç¢ºä¿å„²å­˜)

            if(fd.split === 'equal') { 
                amtM = amtH = totalTWD / 2; 
            }
            else {
                customAmountH = parseFloat(els.amountH.value)||0; 
                customAmountM = parseFloat(els.amountM.value)||0;
                // æª¢æŸ¥è‡ªè¨‚é‡‘é¡æ˜¯å¦åˆç† (å…è¨± 1 å…ƒå·¦å³çš„èª¤å·®)
                if(Math.abs((customAmountH+customAmountM)-fd.total) > 1) return showModal('éŒ¯èª¤', 'è‡ªè¨‚é‡‘é¡ç¸½å’Œèˆ‡ç¸½é‡‘é¡å·®ç•°éå¤§');
                amtH = customAmountH * rate; 
                amtM = customAmountM * rate;
            }

            const amountToM = amtM; // Mæ‡‰åˆ†æ”¤çš„ TWD æˆæœ¬
            const amountToH = amtH; // Hæ‡‰åˆ†æ”¤çš„ TWD æˆæœ¬
            
            // netChangeForM: Må° H çš„æ·¨æ¬ æ¬¾è®ŠåŒ– (æ­£å€¼: Må¤šæ¬  H; è² å€¼: Hå¤šæ¬  M)
            let netChangeForM;
            if (fd.payer === 'H') {
                // Hæ”¯ä»˜ç¸½é¡ã€‚Hä»£å¢Šäº† M çš„ä»½é¡ (amountToM)ã€‚
                netChangeForM = amountToM; 
            } else { // Payer is M
                // Mæ”¯ä»˜ç¸½é¡ã€‚Mä»£å¢Šäº† H çš„ä»½é¡ (amountToH)ã€‚
                netChangeForM = -amountToH; 
            }

            els.submitBtn.disabled = true;
            try {
                const docData = {
                    date: fd.date, description: fd.desc, currency: fd.currency,
                    originalAmount: fd.total, 
                    rate: parseFloat(rate.toFixed(4)), // ç¢ºä¿å„²å­˜ rate
                    totalTWD: parseFloat(totalTWD.toFixed(2)), // ç¢ºä¿å„²å­˜ totalTWD
                    payer: fd.payer, splitType: fd.split, 
                    netChangeForM: parseFloat(netChangeForM.toFixed(2)), 
                    // V0.9: å„²å­˜åŸå§‹å¹£åˆ¥çš„ custom amounts
                    ...(fd.split === 'custom' && { customAmountH: parseFloat(customAmountH.toFixed(2)), customAmountM: parseFloat(customAmountM.toFixed(2)) }), 
                    createdAt: serverTimestamp()
                };
                
                const bRef = getBalanceRef();
                const snap = await getDoc(bRef);
                let bal = snap.exists() ? snap.data().amount : 0;

                if(editingId) {
                    bal = bal - editingNetChange + docData.netChangeForM; // å…ˆå›æ»¾å†å¥—ç”¨æ–°è®Šæ›´
                    await setDoc(doc(db, getExpensesRef().path, editingId), docData, {merge:true});
                    await setDoc(bRef, {amount: bal, lastUpdated: serverTimestamp()});
                    els.cancelEditBtn.click();
                    showModal('æ›´æ–°æˆåŠŸ', 'ç´€éŒ„å·²æ›´æ–°');
                } else {
                    bal += docData.netChangeForM;
                    await addDoc(getExpensesRef(), docData);
                    await setDoc(bRef, {amount: bal, lastUpdated: serverTimestamp()});
                    els.form.reset(); els.date.valueAsDate = new Date(); els.currency.value = 'TWD';
                    els.customSplitArea.classList.add('hidden');
                    showModal('æˆåŠŸ', 'ç´€éŒ„å·²å„²å­˜');
                }
            } catch(e) { console.error(e); showModal('éŒ¯èª¤', 'æ“ä½œå¤±æ•—'); }
            els.submitBtn.disabled = false;
        });

        els.saveNamesBtn.onclick = async () => {
            const h = els.hNameInput.value.trim(); const m = els.mNameInput.value.trim();
            if(!h && !m) return;
            await setDoc(getSettingsRef(), { ...(h && {H:h}), ...(m && {M:m}) }, {merge:true});
            els.toggleSettings.click();
            els.hNameInput.value=''; els.mNameInput.value='';
        };

        els.clearBalanceBtn.onclick = () => {
            const amt = Math.abs(currentBalanceTWD);
            if(amt < 5) return;
            const payer = currentBalanceTWD > 0 ? 'M' : 'H';
            showConfirm('çµæ¸…', `ç”± ${payer === 'H' ? partyNames.H : partyNames.M} æ”¯ä»˜ $${amt.toFixed(0)} TWD çµæ¸…ï¼Ÿ`, 'ç¢ºèª', async () => {
                
                const finalNetChangeForM = -currentBalanceTWD; 
                
                await addDoc(getExpensesRef(), {
                    date: new Date().toISOString().slice(0,10), description: 'çµæ¸…æ¬ æ¬¾',
                    currency: 'TWD', originalAmount: amt, rate: 1, totalTWD: amt,
                    payer, splitType: 'equal', 
                    netChangeForM: finalNetChangeForM, 
                    createdAt: serverTimestamp()
                });
                await setDoc(getBalanceRef(), {amount: 0, lastUpdated: serverTimestamp()});
                showModal('å®Œæˆ', 'å¸³å‹™å·²æ­¸é›¶');
            });
        };

        // UI Event Handlers
        els.toggleSettings.onclick = () => { els.settingsPanel.classList.toggle('hidden'); els.settingsIcon.classList.toggle('rotate-180'); };
        els.splitType.onchange = (e) => e.target.value === 'custom' ? els.customSplitArea.classList.remove('hidden') : els.customSplitArea.classList.add('hidden');

        els.date.valueAsDate = new Date();
        
        // --- 6. åˆå§‹åŒ– ---
        
        // 1. èªè­‰
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                els.statusText.textContent = 'å·²é€£ç·š';
                els.statusDot.className = 'w-1.5 h-1.5 rounded-full bg-accent-teal';
                // 2. å•Ÿå‹•ç›£è½ (åœ¨èªè­‰æˆåŠŸå¾Œ)
                initRoomListeners();
            } else {
                // å˜—è©¦åŒ¿åç™»å…¥
                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) await signInWithCustomToken(auth, token);
                    else await signInAnonymously(auth);
                } catch(e) {
                    els.statusText.textContent = 'é€£ç·šå¤±æ•—';
                    els.statusDot.className = 'w-1.5 h-1.5 rounded-full bg-rose-500';
                }
            }
        });

        // 3. åŒ¯ç‡
        const fetchRates = async () => {
            // è¨­å®šåˆç†çš„ Fallback rates (1 å¤–å¹£ = X TWD)
            exchangeRates = { TWD: 1, USD: 32, JPY: 0.21 }; 
            els.rateUsd.innerHTML = 'ğŸ‡ºğŸ‡¸ 1 USD = 32.0 TWD'; // Fallback Display
            els.rateJpy.innerHTML = 'ğŸ‡¯ğŸ‡µ 1 JPY = 0.21 TWD'; // Fallback Display
            
            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                // æç¤ºè©ï¼šè¦æ±‚å›å‚³ 1 TWD å…Œæ› USD å’Œ JPY çš„æ•¸å€¼
                const prompt = "Please provide the latest exchange rates for TWD to USD and TWD to JPY. Format: 1 TWD = X USD, 1 TWD = Y JPY. Answer only the numbers, comma separated. Example: 0.032, 4.8";
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: "You are a professional currency provider, output only the numbers, comma separated. Example: 0.032, 4.8" }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
                
                const [twdToUsdStr, twdToJpyStr] = text.split(',').map(s => s.trim());
                const twdToUsd = parseFloat(twdToUsdStr);
                const twdToJpy = parseFloat(twdToJpyStr);

                if (isNaN(twdToUsd) || isNaN(twdToJpy) || twdToUsd === 0 || twdToJpy === 0) {
                     throw new Error('Invalid rates from API');
                }

                // è¨ˆç®— 1 å–®ä½å¤–å¹£ç­‰æ–¼å¤šå°‘ TWD (USD/JPY to TWD)
                const usdToTwd = 1 / twdToUsd;
                const jpyToTwd = 1 / twdToJpy;

                exchangeRates = {
                    TWD: 1, 
                    USD: parseFloat(usdToTwd.toFixed(4)), // 1 USD = X TWD
                    JPY: parseFloat(jpyToTwd.toFixed(4))  // 1 JPY = X TWD
                };
                
                // é¡¯ç¤ºï¼š1 USD = XX TWD, 1 JPY = XX TWD
                els.rateUsd.innerHTML = `ğŸ‡ºğŸ‡¸ 1 USD = ${usdToTwd.toFixed(2)} TWD`;
                els.rateJpy.innerHTML = `ğŸ‡¯ğŸ‡µ 1 JPY = ${jpyToTwd.toFixed(2)} TWD`;

            } catch(e) { 
                console.error("åŒ¯ç‡ç²å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:", exchangeRates);
                // ä½¿ç”¨ Fallback Displayï¼Œå› ç‚ºåœ¨ try å¡Šé ‚éƒ¨å·²è¨­å®š
            }
        };
        fetchRates();

    </script>
</body>
</html>

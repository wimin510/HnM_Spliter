<!DOCTYPE html>
<html lang="zh-Hant" class="bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬ HnM Spliter v0.4</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ï¼šæ”¹ç”¨åœ“é«” (Zen Maru Gothic) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap');
        body {
            /* ä½¿ç”¨åœ“é«”ï¼Œè‹¥è¼‰å…¥å¤±æ•—å‰‡å›é€€åˆ°ç³»çµ±ç„¡è¥¯ç·šé«” */
            font-family: 'Zen Maru Gothic', 'Helvetica Neue', sans-serif;
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* è‡ªå®šç¾©æŸ”å’Œé™°å½± */
        .soft-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 6px -2px rgba(0, 0, 0, 0.02);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ä½é£½å’Œåº¦é…è‰²æ–¹æ¡ˆ
                        slate: {
                            850: '#1e293b', // æ›´æ·±çš„èƒŒæ™¯è‰²
                        },
                        primary: {
                            DEFAULT: '#475569', // Slate-600 (ä¸»æŒ‰éˆ•)
                            dark: '#334155',    // Slate-700 (Hover)
                        },
                        accent: {
                            teal: '#2dd4bf',    // æŸ”å’Œé’ç¶  (å„ªå‹¢)
                            rose: '#fb7185',    // æŸ”å’Œç«ç‘°ç´… (åŠ£å‹¢)
                            blue: '#93c5fd',    // æŸ”å’Œè— (H)
                            orange: '#fdba74',  // æŸ”å’Œæ©˜ (M)
                        }
                    },
                    boxShadow: {
                        'soft-xl': '0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.02)',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen flex justify-center items-start text-slate-700">

    <div class="w-full max-w-[500px] space-y-6 my-4">
        
        <!-- æ¨™é¡Œèˆ‡é€£ç·šç‹€æ…‹ -->
        <div class="flex justify-between items-end px-2">
            <div>
                 <h1 class="text-3xl font-black text-slate-800 tracking-tight flex items-center">
                    ç„¡è³´å¸³æœ¬ <span class="text-xl ml-2 opacity-50">v0.4</span>
                </h1>
                <p class="text-xs text-slate-400 font-medium mt-1">åœ“é«”ä¸­æ€§ç‰ˆ</p>
            </div>
           
            <div class="text-right flex flex-col items-end">
                <div class="inline-flex items-center bg-white py-1 px-2 rounded-full shadow-sm border border-slate-100">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse mr-2"></div>
                    <span id="connection-status" class="text-xs font-bold text-slate-500">é€£ç·šä¸­...</span>
                </div>
                <div id="user-id" class="text-[10px] text-slate-400 font-mono mt-1 mr-1">ID: ---</div>
            </div>
        </div>

        <!-- ç¸½æ¬ æ¬¾å¡ç‰‡ (åŠ å…¥çµæ¸…æŒ‰éˆ•) -->
        <div id="balance-card" class="relative overflow-hidden bg-slate-850 rounded-[2rem] shadow-soft-xl p-8 text-white transition-all duration-500 group">
            <!-- ç‹€æ…‹æŒ‡ç¤ºç‡ˆæ¢ (å·¦å´) -->
            <div id="balance-indicator-bar" class="absolute left-0 top-0 bottom-0 w-2 bg-slate-700 transition-colors duration-500"></div>
            
            <div class="relative z-10 pl-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-400 mb-1 tracking-wider uppercase">Current Status</p>
                        <h2 id="balance-status-text" class="text-xl font-bold flex items-center">
                            <span id="status-icon" class="mr-2 text-2xl">âš–ï¸</span>
                            <span>è¼‰å…¥ä¸­...</span>
                        </h2>
                    </div>
                    <!-- åŒ¯ç‡å°å·¥å…· -->
                    <div class="text-right bg-slate-800/50 p-2 rounded-xl backdrop-blur-sm border border-slate-700/50 text-xs text-slate-300">
                         <div id="rates-display" class="space-y-0.5 font-mono opacity-80">
                            <div class="flex items-center gap-1"><span class="text-slate-500">ğŸ‡ºğŸ‡¸</span> <span>---</span></div>
                            <div class="flex items-center gap-1"><span class="text-slate-500">ğŸ‡¯ğŸ‡µ</span> <span>---</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline mt-6">
                    <span class="text-5xl font-black tracking-tighter tabular-nums" id="balance-amount">---</span>
                    <span class="text-lg font-bold ml-2 text-slate-400">TWD</span>
                </div>
                 <p class="text-[10px] mt-6 text-slate-500 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1 inline opacity-70"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 002 0v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    å¤–å¹£å·²ä¾å³æ™‚åŒ¯ç‡æ›ç®—ç‚ºæ–°å°å¹£
                </p>

                <!-- çµæ¸…æŒ‰éˆ• (æ–°å¢) -->
                <button id="clear-balance-btn" class="absolute bottom-6 right-8 text-white bg-slate-600 hover:bg-slate-700 font-bold py-2 px-4 rounded-full text-sm transition-all shadow-md disabled:opacity-30 disabled:cursor-not-allowed transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100" disabled>
                    ğŸ¤ ä¸€éµçµæ¸…
                </button>
            </div>
            <!-- èƒŒæ™¯è£é£¾ (æ›´æŸ”å’Œ) -->
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-48 h-48 bg-gradient-to-br from-white/5 to-transparent rounded-full blur-3xl pointer-events-none"></div>
            <div id="balance-glow" class="absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-slate-700/20 rounded-full blur-3xl pointer-events-none transition-colors duration-500"></div>
        </div>


        <!-- è¨­å®šå€å¡Š -->
        <div class="bg-white rounded-2xl soft-shadow border border-slate-100 overflow-hidden">
            <button id="toggle-settings" class="w-full flex justify-between items-center p-4 px-6 hover:bg-slate-50 transition-colors group">
                <span class="font-bold text-slate-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-slate-400 group-hover:text-slate-600 transition-colors"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zM10 7a3 3 0 100 6 3 3 0 000-6zM15.657 5.404a.75.75 0 10-1.06-1.06l-1.061 1.06a.75.75 0 001.06 1.06l1.06-1.06zM6.464 14.596a.75.75 0 10-1.06-1.06l-1.06 1.06a.75.75 0 001.06 1.06l1.06-1.06zM15.657 14.596a.75.75 0 01-1.06 1.06l-1.061-1.06a.75.75 0 011.06-1.06l1.06 1.06zM6.464 5.404a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 011.06-1.06l1.06 1.06zM18 10a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0118 10zM5 10a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 015 10z" /></svg>
                    æˆå“¡åç¨±è¨­å®š
                </span>
                <svg id="settings-icon" class="w-5 h-5 text-slate-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="settings-panel" class="hidden p-6 pt-2 space-y-6 border-t border-slate-100 bg-slate-50/50">
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">æˆå“¡ H (åç¨±)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-accent-blue/80 font-bold">H</span>
                            </div>
                            <input type="text" id="h-name-input" class="block w-full pl-8 pr-3 py-3 bg-white border-0 rounded-xl shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-accent-blue sm:text-sm transition-shadow" placeholder="è¼¸å…¥åç¨±...">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">æˆå“¡ M (åç¨±)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-accent-orange/80 font-bold">M</span>
                            </div>
                            <input type="text" id="m-name-input" class="block w-full pl-8 pr-3 py-3 bg-white border-0 rounded-xl shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-accent-orange sm:text-sm transition-shadow" placeholder="è¼¸å…¥åç¨±...">
                        </div>
                    </div>
                </div>
                <button id="save-names-btn" class="w-full py-3 bg-slate-800 text-white text-sm font-bold rounded-xl shadow-md hover:bg-slate-900 hover:shadow-lg transition-all active:scale-[0.98]">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <!-- æ–°å¢ç´€éŒ„è¡¨å–® (ä¸»è¦æ“ä½œå€) -->
        <div class="bg-white rounded-[2rem] soft-shadow border border-slate-100 p-6 sm:p-8 relative overflow-hidden">
            <!-- è£é£¾èƒŒæ™¯ -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-slate-50 rounded-full -mr-32 -mt-32 pointer-events-none opacity-50"></div>

            <h3 class="text-xl font-black text-slate-800 mb-8 flex items-center relative z-10">
                <span class="bg-slate-800 text-white rounded-xl w-8 h-8 flex items-center justify-center text-lg mr-3 shadow-sm">ğŸ“</span>
                è¨˜ä¸Šä¸€ç­†
            </h3>
            
            <form id="expense-form" class="space-y-8 relative z-10">
                
                <!-- 1. èª°ä»˜çš„ (é ­åƒå¼é¸æ“‡å™¨ - é‡é»ä¿®æ”¹) -->
                <div class="space-y-3">
                    <label class="block text-sm font-bold text-slate-700">èª°å…ˆä»˜çš„éŒ¢ï¼Ÿ</label>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- H é¸é … -->
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="payer" value="H" class="peer sr-only" checked>
                            <div class="flex flex-col items-center p-4 rounded-2xl border-2 border-slate-100 bg-white transition-all duration-300 group-hover:border-accent-blue/30 peer-checked:border-accent-blue peer-checked:bg-accent-blue/10 peer-checked:shadow-md">
                                <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-2xl font-black text-slate-400 mb-3 transition-colors peer-checked:bg-accent-blue peer-checked:text-white ring-4 ring-white peer-checked:ring-accent-blue/20">
                                    H
                                </div>
                                <span id="payer-h-label" class="font-bold text-slate-600 peer-checked:text-slate-800">æˆå“¡ H</span>
                            </div>
                            <!-- é¸ä¸­æ¨™è¨˜ -->
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity text-accent-blue bg-white rounded-full p-0.5 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                            </div>
                        </label>

                        <!-- M é¸é … -->
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="payer" value="M" class="peer sr-only">
                            <div class="flex flex-col items-center p-4 rounded-2xl border-2 border-slate-100 bg-white transition-all duration-300 group-hover:border-accent-orange/30 peer-checked:border-accent-orange peer-checked:bg-accent-orange/10 peer-checked:shadow-md">
                                <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-2xl font-black text-slate-400 mb-3 transition-colors peer-checked:bg-accent-orange peer-checked:text-white ring-4 ring-white peer-checked:ring-accent-orange/20">
                                    M
                                </div>
                                <span id="payer-m-label" class="font-bold text-slate-600 peer-checked:text-slate-800">æˆå“¡ M</span>
                            </div>
                             <!-- é¸ä¸­æ¨™è¨˜ -->
                             <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity text-accent-orange bg-white rounded-full p-0.5 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 2. ç¸½é‡‘é¡ (æ›´é†’ç›®) -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ç¸½é‡‘é¡</label>
                    <div class="relative rounded-2xl shadow-sm overflow-hidden ring-1 ring-slate-200 focus-within:ring-2 focus-within:ring-primary transition-shadow">
                        <input type="number" id="totalAmount" step="0.01" min="0" required class="block w-full p-4 pl-6 text-3xl font-black tracking-tight text-slate-800 bg-white border-0 focus:ring-0 placeholder:text-slate-300" placeholder="0.00">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                             <select id="currency" class="h-full py-0 pl-3 pr-8 border-0 bg-slate-50 text-slate-700 font-bold rounded-xl focus:ring-0 cursor-pointer hover:bg-slate-100 transition-colors sm:text-sm ml-2">
                                <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                            </select>
                        </div>
                         <div class="absolute inset-y-0 right-[6.5rem] flex items-center pointer-events-none">
                             <span id="currency-label" class="text-slate-400 font-bold text-sm">TWD</span>
                         </div>
                    </div>
                </div>

                <!-- 3. ç”¨é€”èˆ‡æ—¥æœŸ -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2 space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">ç”¨é€” / æè¿°</label>
                        <input type="text" id="description" required class="block w-full p-3 bg-white border-0 rounded-xl shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-primary sm:text-sm transition-shadow" placeholder="ä¾‹å¦‚: æ™šé¤ã€è¶…å¸‚æ¡è³¼">
                    </div>
                     <div class="space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required class="block w-full p-3 bg-white border-0 rounded-xl shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-primary sm:text-sm transition-shadow text-center">
                    </div>
                </div>

                <!-- 4. åˆ†å¸³æ–¹å¼ -->
                <div class="pt-2">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-bold text-slate-700">åˆ†å¸³æ–¹å¼</label>
                        <select id="splitType" class="p-2 pl-3 pr-8 bg-slate-50 border-0 rounded-lg text-sm font-bold text-slate-600 focus:ring-2 focus:ring-primary cursor-pointer hover:bg-slate-100 transition-colors">
                            <option value="equal">âš–ï¸ å¹³å‡åˆ†æ”¤</option>
                            <option value="custom">âœï¸ è‡ªè¨‚é‡‘é¡</option>
                        </select>
                    </div>
                    
                    <!-- è‡ªè¨‚é‡‘é¡è¼¸å…¥å€ -->
                    <div id="custom-split-area" class="hidden bg-slate-50/80 p-4 rounded-2xl border border-slate-200/50 space-y-3 mt-3 backdrop-blur-sm">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full bg-accent-blue/20 flex items-center justify-center text-accent-blue font-bold text-sm">H</div>
                            <label class="w-1/3 text-sm font-bold text-slate-600 truncate" id="split-h-label">H æ‡‰ä»˜</label>
                            <input type="number" id="amountH" step="0.01" class="flex-1 p-2 border-0 ring-1 ring-slate-200 rounded-lg text-right font-bold text-slate-700 focus:ring-2 focus:ring-accent-blue" placeholder="0.00">
                        </div>
                        <div class="flex items-center space-x-3">
                             <div class="w-8 h-8 rounded-full bg-accent-orange/20 flex items-center justify-center text-accent-orange font-bold text-sm">M</div>
                            <label class="w-1/3 text-sm font-bold text-slate-600 truncate" id="split-m-label">M æ‡‰ä»˜</label>
                            <input type="number" id="amountM" step="0.01" class="flex-1 p-2 border-0 ring-1 ring-slate-200 rounded-lg text-right font-bold text-slate-700 focus:ring-2 focus:ring-accent-orange" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full py-4 bg-primary text-white font-black text-lg rounded-2xl shadow-lg shadow-slate-300/50 hover:bg-primary-dark hover:shadow-xl hover:-translate-y-0.5 transform active:scale-[0.98] active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-lg">
                    ç¢ºèªå„²å­˜ç´€éŒ„
                </button>
            </form>
        </div>

        <!-- æœ€è¿‘ç´€éŒ„ (æ¨£å¼å„ªåŒ–) -->
        <div class="pt-4">
            <h3 class="text-lg font-black text-slate-700 mb-4 px-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 opacity-60"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                æœ€è¿‘ 5 ç­†ç´€éŒ„
            </h3>
            <div id="records-list" class="space-y-3 pb-10">
                <!-- ç´€éŒ„é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                <div class="text-center text-slate-400 py-8 text-sm font-medium bg-white rounded-2xl border border-dashed border-slate-200">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

    </div>

    <!-- æç¤ºæ¡† Modal (æ¨£å¼çµ±ä¸€ï¼Œæ–°å¢ action æŒ‰éˆ•) -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white p-6 rounded-[2rem] shadow-2xl w-80 max-w-full mx-4 transform transition-all scale-100 border border-slate-100">
            <div id="modal-icon" class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-2xl mb-4 mx-auto">ğŸ¤”</div>
            <h3 id="modal-title" class="text-xl font-black text-slate-800 mb-2 text-center">æç¤º</h3>
            <p id="modal-msg" class="text-sm text-slate-600 mb-6 text-center leading-relaxed">è¨Šæ¯å…§å®¹</p>
            <div id="modal-buttons" class="flex space-x-3">
                <button id="modal-close-btn" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-colors">å–æ¶ˆ</button>
                <button id="modal-action-btn" class="flex-1 py-3 bg-accent-teal text-white rounded-xl font-bold hover:bg-accent-teal/80 transition-colors">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, query, limit, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. è¨­å®šèˆ‡åˆå§‹åŒ– ---
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyCRHx0i02nojkN5-y5HxS3P3i1jA5SEy8E",
                authDomain: "hnm-spliter.firebaseapp.com",
                projectId: "hnm-spliter",
                storageBucket: "hnm-spliter.firebasestorage.app",
                messagingSenderId: "514297368344",
                appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d",
                measurementId: "G-4DY12810X8"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const SHARED_LEDGER_ID = 'hnm_shared_ledger_v1';
        
        let currentUser = null;
        let exchangeRates = null;
        let currentBalanceTWD = 0; // æ–°å¢ï¼šè¿½è¹¤ç›®å‰é¤˜é¡
        // æ›´æ–°é è¨­åç¨±ç‚ºä¸­æ€§ç”¨èª
        let partyNames = { H: 'æˆå“¡ H', M: 'æˆå“¡ M' };
        
        // DOM å…ƒç´  (ä¿æŒä¸è®Š)
        const els = {
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('connection-status'),
            userId: document.getElementById('user-id'),
            // Balance Card Elements
            balanceCard: document.getElementById('balance-card'),
            balanceIndicator: document.getElementById('balance-indicator-bar'),
            balanceGlow: document.getElementById('balance-glow'),
            balanceText: document.getElementById('balance-status-text'),
            balanceAmount: document.getElementById('balance-amount'),
            statusIcon: document.getElementById('status-icon'),
            ratesDisplay: document.getElementById('rates-display'),
            clearBalanceBtn: document.getElementById('clear-balance-btn'), // æ–°å¢
            // Settings
            toggleSettings: document.getElementById('toggle-settings'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsIcon: document.getElementById('settings-icon'),
            hNameInput: document.getElementById('h-name-input'),
            mNameInput: document.getElementById('m-name-input'),
            saveNamesBtn: document.getElementById('save-names-btn'),
            // Form
            form: document.getElementById('expense-form'),
            date: document.getElementById('recordDate'),
            currency: document.getElementById('currency'),
            currencyLabel: document.getElementById('currency-label'),
            totalAmount: document.getElementById('totalAmount'),
            desc: document.getElementById('description'),
            splitType: document.getElementById('splitType'),
            customSplitArea: document.getElementById('custom-split-area'),
            amountH: document.getElementById('amountH'),
            amountM: document.getElementById('amountM'),
            submitBtn: document.getElementById('submit-btn'),
            // Labels
            payerHLabel: document.getElementById('payer-h-label'),
            payerMLabel: document.getElementById('payer-m-label'),
            splitHLabel: document.getElementById('split-h-label'),
            splitMLabel: document.getElementById('split-m-label'),
            // List & Modal
            list: document.getElementById('records-list'),
            modal: document.getElementById('modal'),
            modalIcon: document.getElementById('modal-icon'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-msg'),
            modalCloseBtn: document.getElementById('modal-close-btn'), // æ–°å¢
            modalActionBtn: document.getElementById('modal-action-btn') // æ–°å¢
        };

        // --- 2. è¼”åŠ©å‡½å¼ ---

        // å½ˆå‡ºå¼è¦–çª—ï¼šå–æ¶ˆ/é—œé–‰å‹•ä½œ
        window.closeModal = () => {
            els.modal.classList.add('hidden');
            els.modal.classList.remove('flex');
            // æ¸…é™¤ action ç›£è½å™¨
            els.modalActionBtn.onclick = null; 
            els.modalActionBtn.classList.add('hidden');
            els.modalCloseBtn.textContent = 'çŸ¥é“äº†';
            els.modalCloseBtn.classList.remove('flex-1');
            els.modalCloseBtn.classList.add('w-full');
            els.modalActionBtn.classList.remove('flex-1');
            els.modalCloseBtn.classList.remove('bg-slate-200');
            els.modalCloseBtn.classList.add('bg-slate-800');
            els.modalCloseBtn.classList.add('text-white');
        };

        // å½ˆå‡ºå¼è¦–çª—ï¼šç´”æç¤º
        const showModal = (title, msg, icon = 'ğŸ¤”') => {
            els.modalIcon.textContent = icon;
            els.modalTitle.textContent = title;
            els.modalMsg.textContent = msg;
            els.modal.classList.remove('hidden');
            els.modal.classList.add('flex');
            els.modalCloseBtn.onclick = closeModal;
            els.modalActionBtn.classList.add('hidden');
            els.modalCloseBtn.textContent = 'çŸ¥é“äº†';
            els.modalCloseBtn.classList.remove('flex-1');
            els.modalCloseBtn.classList.add('w-full');
            els.modalCloseBtn.classList.remove('bg-slate-800');
            els.modalCloseBtn.classList.remove('text-white');
            els.modalCloseBtn.classList.add('bg-slate-200');
            els.modalCloseBtn.classList.add('text-slate-700');
        };

        // å½ˆå‡ºå¼è¦–çª—ï¼šç¢ºèªå‹•ä½œ
        const showConfirmModal = (title, msg, actionText, callback) => {
            els.modalIcon.textContent = 'âš ï¸';
            els.modalTitle.textContent = title;
            els.modalMsg.textContent = msg;
            els.modalActionBtn.textContent = actionText;

            els.modal.classList.remove('hidden');
            els.modal.classList.add('flex');
            
            els.modalCloseBtn.onclick = closeModal;
            els.modalActionBtn.onclick = () => {
                closeModal();
                callback();
            };

            // èª¿æ•´æŒ‰éˆ•æ¨£å¼ä»¥é¡¯ç¤ºå…©å€‹æŒ‰éˆ•
            els.modalActionBtn.classList.remove('hidden');
            els.modalActionBtn.classList.add('flex-1');
            els.modalCloseBtn.classList.add('flex-1');
            els.modalCloseBtn.classList.remove('w-full');
            els.modalCloseBtn.textContent = 'å–æ¶ˆ';
            els.modalCloseBtn.classList.add('bg-slate-200');
            els.modalCloseBtn.classList.remove('bg-slate-800');
            els.modalCloseBtn.classList.remove('text-white');
            els.modalCloseBtn.classList.add('text-slate-700');

        };
        
        // æ›´æ–°é€£ç·šç‹€æ…‹ UI (é…è‰²èª¿æ•´)
        const updateStatus = (status) => {
            if (status === 'connected') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-accent-teal';
                els.statusText.textContent = 'å·²é€£ç·š';
                els.statusText.className = 'text-xs font-bold text-accent-teal';
                els.submitBtn.disabled = false;
                els.submitBtn.textContent = 'ç¢ºèªå„²å­˜ç´€éŒ„';
                els.clearBalanceBtn.disabled = Math.abs(currentBalanceTWD) < 0.5; // é€£ç·šå¾Œæª¢æŸ¥æ¬ æ¬¾
            } else if (status === 'error') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-accent-rose';
                els.statusText.textContent = 'é€£ç·šéŒ¯èª¤';
                els.statusText.className = 'text-xs font-bold text-accent-rose';
                els.submitBtn.disabled = true;
                els.submitBtn.textContent = 'ç„¡æ³•é€£ç·š';
                els.clearBalanceBtn.disabled = true;
            } else {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-slate-300 animate-pulse';
                els.statusText.textContent = 'é€£ç·šä¸­...';
                els.statusText.className = 'text-xs font-bold text-slate-400';
                els.submitBtn.disabled = true;
                els.clearBalanceBtn.disabled = true;
            }
        };

        // --- 3. è³‡æ–™åº«è·¯å¾‘å®šç¾© (ä¸è®Š) ---
        const getExpensesRef = () => {
            if (typeof __app_id !== 'undefined') {
                return collection(db, `artifacts/${__app_id}/public/data/hnm_expenses`);
            }
            return collection(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/expenses`);
        };

        const getBalanceRef = () => {
            if (typeof __app_id !== 'undefined') {
                return doc(db, `artifacts/${__app_id}/public/data/hnm_shared/balance`);
            }
            return doc(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/shared/balance`);
        };

        const getSettingsRef = () => {
            if (typeof __app_id !== 'undefined') {
                return doc(db, `artifacts/${__app_id}/public/data/hnm_shared/settings`);
            }
            return doc(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/shared/settings`);
        };

        // --- 4. åŒ¯ç‡ API (UI æ›´æ–° - ä¸è®Š) ---
        const fetchRates = async () => {
            try {
                // ... (åŒ¯ç‡ç²å–é‚è¼¯ä¸è®Š) ...
                const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                if (!res.ok) throw new Error('Rate API Error');
                const data = await res.json();
                exchangeRates = {
                    TWD: 1,
                    USD: 1 / data.rates.USD,
                    JPY: 1 / data.rates.JPY
                };
                
                // æ›´æ–°åŒ¯ç‡é¡¯ç¤º UI
                els.ratesDisplay.innerHTML = `
                    <div class="flex items-center gap-1"><span class="text-base">ğŸ‡ºğŸ‡¸</span> <span>${exchangeRates.USD.toFixed(2)}</span></div>
                    <div class="flex items-center gap-1"><span class="text-base">ğŸ‡¯ğŸ‡µ</span> <span>${exchangeRates.JPY.toFixed(2)}</span></div>
                `;
            } catch (e) {
                console.error("åŒ¯ç‡ç²å–å¤±æ•—", e);
                els.ratesDisplay.innerHTML = `<span class="text-accent-rose flex items-center"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>åŒ¯ç‡éŒ¯èª¤</span>`;
            }
        };

        // --- 5. é‚è¼¯èˆ‡äº’å‹• (UI æ›´æ–°) ---

        const updateNamesUI = () => {
            els.payerHLabel.textContent = partyNames.H;
            els.payerMLabel.textContent = partyNames.M;
            els.splitHLabel.textContent = `${partyNames.H} æ‡‰ä»˜`;
            els.splitMLabel.textContent = `${partyNames.M} æ‡‰ä»˜`;
            // Update placeholders only if empty to avoid overwriting user input
            if (!els.hNameInput.value) els.hNameInput.placeholder = partyNames.H;
             if (!els.mNameInput.value) els.mNameInput.placeholder = partyNames.M;
             
             // ç¢ºä¿åœ¨åç¨±æ›´æ–°æ™‚ï¼Œé¤˜é¡é¡¯ç¤ºä¹Ÿæ›´æ–°
             renderBalance(currentBalanceTWD);
        };

        // æ¸²æŸ“æ¬ æ¬¾å¡ç‰‡ (ä½é£½å’Œåº¦é¢¨æ ¼)
        const renderBalance = (balance) => {
            currentBalanceTWD = balance; // æ›´æ–°å…¨å±€è®Šæ•¸
            const val = Math.abs(balance);
            els.balanceAmount.textContent = val.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            
            // é‡ç½®åŸºæœ¬æ¨£å¼
            els.balanceText.className = "text-xl font-bold flex items-center text-white";
            els.statusIcon.className = "mr-2 text-2xl";

            if (balance > 5) { // M æ¬  H (å„ªå‹¢ - æŸ”å’Œé’ç¶ )
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-accent-teal transition-colors duration-500";
                els.balanceGlow.className = "absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-accent-teal/20 rounded-full blur-3xl pointer-events-none transition-colors duration-500";
                els.statusIcon.textContent = "ğŸ‰";
                els.balanceText.innerHTML = `<span class="mr-2 text-2xl">ğŸ‰</span><span>${partyNames.M} æ¬  ${partyNames.H}</span>`;
            } else if (balance < -5) { // H æ¬  M (åŠ£å‹¢ - æŸ”å’Œç«ç‘°ç´…)
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-accent-rose transition-colors duration-500";
                els.balanceGlow.className = "absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-accent-rose/20 rounded-full blur-3xl pointer-events-none transition-colors duration-500";
                 els.statusIcon.textContent = "ğŸ’¸";
                 els.balanceText.innerHTML = `<span class="mr-2 text-2xl">ğŸ’¸</span><span>${partyNames.H} æ¬  ${partyNames.M}</span>`;
            } else { // å…©æ¸… (ä¸­æ€§ - å²©ç°)
                els.balanceIndicator.className = "absolute left-0 top-0 bottom-0 w-2 bg-slate-600 transition-colors duration-500";
                els.balanceGlow.className = "absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-slate-700/20 rounded-full blur-3xl pointer-events-none transition-colors duration-500";
                els.statusIcon.textContent = "âš–ï¸";
                els.balanceText.innerHTML = `<span class="mr-2 text-2xl">âš–ï¸</span><span>ç›®å‰å…©æ¸…</span>`;
            }

            // çµæ¸…æŒ‰éˆ•å•Ÿç”¨é‚è¼¯ï¼šæ¬ æ¬¾çµ•å°å€¼è¶…é 5 å…ƒæ‰å•Ÿç”¨
            const isOwed = Math.abs(currentBalanceTWD) > 5;
            els.clearBalanceBtn.disabled = !isOwed;
            
            // UI å‹•ç•«
            if (isOwed) {
                els.clearBalanceBtn.classList.remove('opacity-0', 'translate-y-2');
                els.clearBalanceBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                 els.clearBalanceBtn.classList.remove('opacity-100', 'translate-y-0');
                 els.clearBalanceBtn.classList.add('opacity-0', 'translate-y-2');
            }
        };

        // æ¸²æŸ“åˆ—è¡¨ (ä½é£½å’Œåº¦é¢¨æ ¼ - ä¸è®Š)
        const renderList = (docs) => {
            if (docs.length === 0) {
                els.list.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm font-medium bg-white rounded-2xl border border-dashed border-slate-200">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»è¨˜ä¸€ç­†å§ï¼</div>';
                return;
            }
            
            els.list.innerHTML = docs.map((doc, index) => {
                const data = doc.data();
                const date = new Date(data.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const isPayerH = data.payer === 'H';
                const payerName = isPayerH ? partyNames.H : partyNames.M;
                
                // ä½¿ç”¨ä½é£½å’Œåº¦çš„é¡è‰²é¡åˆ¥
                let iconBg = isPayerH ? 'bg-accent-blue/10 text-accent-blue' : 'bg-accent-orange/10 text-accent-orange';
                let description = data.description;

                let detailText = '';
                if (data.splitType === 'equal') {
                    detailText = `<span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full uppercase tracking-wider">å‡åˆ†</span>`;
                } else {
                    detailText = `<span class="text-[10px] font-bold bg-amber-50 text-amber-600 px-2 py-1 rounded-full uppercase tracking-wider border border-amber-100">è‡ªè¨‚</span>`;
                }

                // ç‰¹åˆ¥è™•ç†çµæ¸…ç´€éŒ„
                if (data.description === 'çµæ¸…æ¬ æ¬¾') {
                    iconBg = 'bg-slate-200 text-slate-700';
                    detailText = `<span class="text-[10px] font-black bg-accent-teal/10 text-accent-teal px-2 py-1 rounded-full uppercase tracking-wider">å…©æ¸…</span>`;
                    description = data.description;
                }

                let rateTag = '';
                if (data.currency !== 'TWD') {
                    rateTag = `<div class="text-[10px] text-slate-400 mt-0.5 font-mono bg-slate-50 inline-block px-1 rounded ml-2">åŒ¯ç‡ ${data.rate.toFixed(2)}</div>`;
                }

                // å¢åŠ ä¸€é»å‡ºç¾å‹•ç•«å»¶é²
                const delay = index * 50;

                return `
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 soft-shadow transition-all hover:-translate-y-0.5 hover:shadow-md" style="animation: slideIn 0.3s ease-out ${delay}ms backwards;">
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-center justify-center w-12 h-12 rounded-xl ${iconBg} font-black text-lg">
                            ${data.payer}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800 text-base flex items-center">
                                ${description}
                                <span class="text-xs font-medium text-slate-400 ml-2 font-mono">${date}</span>
                            </div>
                            <div class="text-xs font-medium text-slate-500 mt-1 flex items-center">
                                <span class="font-bold ${isPayerH ? 'text-accent-blue' : 'text-accent-orange'}">${payerName}</span>
                                <span class="mx-1">å…ˆä»˜</span>
                                ${rateTag}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-slate-800 text-lg tabular-nums">${data.originalAmount.toLocaleString()} <span class="text-xs font-bold text-slate-500 ml-0.5">${data.currency}</span></div>
                        <div class="mt-1 flex justify-end">${detailText}</div>
                    </div>
                </div>
                `;
            }).join('');
        };

        const autoCalculate = (source) => {
            if (els.splitType.value !== 'custom') return;
            const total = parseFloat(els.totalAmount.value);
            if (isNaN(total)) return;

            if (source === 'H') {
                const valH = parseFloat(els.amountH.value) || 0;
                els.amountM.value = (total - valH).toFixed(2);
            } else { 
                const valM = parseFloat(els.amountM.value) || 0;
                els.amountH.value = (total - valM).toFixed(2);
            }
        };

        // --- 6. æ ¸å¿ƒåŠŸèƒ½ï¼šä¸€éµçµæ¸…é‚è¼¯ ---
        const handleClearBalance = () => {
            if (!currentUser) {
                showModal('éŒ¯èª¤', 'å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•åŸ·è¡Œçµæ¸…ã€‚');
                return;
            }

            const balance = currentBalanceTWD;
            if (Math.abs(balance) < 5) {
                showModal('æç¤º', 'æ¬ æ¬¾é‡‘é¡å°‘æ–¼ $5 TWDï¼Œå»ºè­°å…ˆä¸çµæ¸…');
                return;
            }

            // æ¬ éŒ¢çš„äºº (Payer) å’Œè¢«æ¬ éŒ¢çš„äºº (Recipient)
            const payerId = balance > 0 ? 'M' : 'H'; // M owes H if B > 0
            const recipientId = balance > 0 ? 'H' : 'M'; // H owes M if B < 0
            const amount = Math.abs(balance);
            
            const payerName = payerId === 'H' ? partyNames.H : partyNames.M;
            const recipientName = recipientId === 'H' ? partyNames.H : partyNames.M;

            const msg = `${payerName} å°‡æ”¯ä»˜ $${amount.toFixed(0)} TWD çµ¦ ${recipientName}ï¼Œä»¥çµæ¸…æ‰€æœ‰æ¬ æ¬¾ã€‚`
                      + `<br><br>ç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿä¸€ç­†ã€Œçµæ¸…æ¬ æ¬¾ã€çš„ç´€éŒ„ã€‚ç¢ºèªåŸ·è¡Œå—ï¼Ÿ`;

            showConfirmModal('ç¢ºèªçµæ¸…æ¬ æ¬¾', msg, `ç¢ºèªæ”¯ä»˜ $${amount.toFixed(0)} TWD`, async () => {
                
                els.clearBalanceBtn.disabled = true;
                els.clearBalanceBtn.textContent = 'è™•ç†ä¸­...';

                try {
                    // 1. ç”¢ç”Ÿçµæ¸…äº¤æ˜“ç´€éŒ„ (ä½¿ç”¨ TWD)
                    const newExpense = {
                        date: new Date().toISOString().slice(0, 10), // ç•¶å‰æ—¥æœŸ
                        description: 'çµæ¸…æ¬ æ¬¾',
                        currency: 'TWD',
                        originalAmount: amount, // æ”¯ä»˜é‡‘é¡
                        rate: 1, 
                        totalTWD: amount,
                        payer: payerId, // çµå¸³äººæ˜¯é‚„éŒ¢çš„äºº
                        splitType: 'custom',
                        createdAt: serverTimestamp()
                    };

                    // çµæ¸…é‚è¼¯ï¼šé€™ç­†äº¤æ˜“ (amount) 100% æ‡‰è©²ç”± Recipient æ‰¿æ“”ï¼Œ
                    // è®“ Payer æ”¯ä»˜çš„é‡‘é¡å®Œå…¨æµå‘ Recipientã€‚
                    // H æ‡‰ä»˜å¤šå°‘ï¼Ÿ M æ‡‰ä»˜å¤šå°‘ï¼Ÿ
                    let netChangeForM = 0;
                    if (payerId === 'H') {
                        // H ä»˜äº† amountï¼Œä½† M æ‡‰è©²å…¨é¡æ‰¿æ“” (M æ‡‰ä»˜ amount)ã€‚
                        // H æ‡‰ä»˜ 0ï¼ŒM æ‡‰ä»˜ amountã€‚
                        // netChangeForM = amountMTWD - amountHTWD = amount - 0 = amount (æ­£æ•¸)
                        // B < 0, netChangeForM æ‡‰ç‚º -B (æ­£æ•¸). amount = |B| = -B. => netChangeForM = amount. (æ­£ç¢º)
                        netChangeForM = amount;
                    } else { // payerId === 'M'
                        // M ä»˜äº† amountï¼Œä½† H æ‡‰è©²å…¨é¡æ‰¿æ“” (H æ‡‰ä»˜ amount)ã€‚
                        // H æ‡‰ä»˜ amountï¼ŒM æ‡‰ä»˜ 0ã€‚
                        // netChangeForM = amountMTWD - amountHTWD = 0 - amount = -amount (è² æ•¸)
                        // B > 0, netChangeForM æ‡‰ç‚º -B (è² æ•¸). amount = B. => netChangeForM = -amount. (æ­£ç¢º)
                        netChangeForM = -amount;
                    }
                    
                    newExpense.netChangeForM = netChangeForM;
                    
                    await addDoc(getExpensesRef(), newExpense);

                    // 2. å°‡é¤˜é¡ç›´æ¥è¨­ç‚º 0
                    const balanceRef = getBalanceRef();
                    await setDoc(balanceRef, { 
                        amount: 0, // ç›´æ¥è¨­ç‚º 0
                        lastUpdated: serverTimestamp()
                    });

                    els.clearBalanceBtn.disabled = false;
                    els.clearBalanceBtn.textContent = 'ğŸ¤ å·²çµæ¸…ï¼';
                    els.clearBalanceBtn.classList.add('bg-accent-teal', 'hover:bg-accent-teal/80');
                    els.clearBalanceBtn.classList.remove('bg-slate-600', 'hover:bg-slate-700');

                    showModal('çµæ¸…æˆåŠŸ', `ç¸½æ¬ æ¬¾å·²æ­¸é›¶ã€‚å·²æ–°å¢ä¸€ç­†çµæ¸…ç´€éŒ„ã€‚`, 'âœ…');
                    
                    setTimeout(() => {
                         els.clearBalanceBtn.textContent = 'ğŸ¤ ä¸€éµçµæ¸…';
                         els.clearBalanceBtn.classList.remove('bg-accent-teal', 'hover:bg-accent-teal/80');
                         els.clearBalanceBtn.classList.add('bg-slate-600', 'hover:bg-slate-700');
                    }, 2000);


                } catch (e) {
                    console.error("çµæ¸…å¤±æ•—", e);
                    showModal('éŒ¯èª¤', 'çµæ¸…å¤±æ•—: ' + e.message, 'âŒ');
                    els.clearBalanceBtn.disabled = false;
                    els.clearBalanceBtn.textContent = 'ğŸ¤ ä¸€éµçµæ¸…';
                }
            });
        };

        // --- 7. äº‹ä»¶ç›£è½ (æ–°å¢çµæ¸…æŒ‰éˆ•ç›£è½) ---

        els.clearBalanceBtn.addEventListener('click', handleClearBalance);

        els.toggleSettings.addEventListener('click', () => {
            els.settingsPanel.classList.toggle('hidden');
            els.settingsIcon.classList.toggle('rotate-180');
        });

        els.saveNamesBtn.addEventListener('click', async () => {
            const newH = els.hNameInput.value.trim();
            const newM = els.mNameInput.value.trim();
            // Only save if at least one is provided to avoid saving empty strings over defaults immediately
            if (!newH && !newM) {
                 showModal('æç¤º', 'è«‹è¼¸å…¥è¦ä¿®æ”¹çš„åç¨±');
                 return;
            }

            const updates = {};
            if (newH) updates.H = newH;
            if (newM) updates.M = newM;

            try {
                await setDoc(getSettingsRef(), updates, { merge: true });
                els.settingsPanel.classList.add('hidden');
                els.settingsIcon.classList.remove('rotate-180');
                // Clear inputs after save
                els.hNameInput.value = '';
                els.mNameInput.value = '';
                showModal('æˆåŠŸ', 'åç¨±å·²æ›´æ–°ï¼', 'ğŸ‘');
            } catch (e) {
                console.error(e);
                showModal('éŒ¯èª¤', 'åç¨±å„²å­˜å¤±æ•—: ' + e.message, 'âŒ');
            }
        });

        els.currency.addEventListener('change', (e) => {
            els.currencyLabel.textContent = e.target.value;
        });

        els.splitType.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                els.customSplitArea.classList.remove('hidden');
                const total = parseFloat(els.totalAmount.value) || 0;
                els.amountH.value = (total / 2).toFixed(2);
                els.amountM.value = (total / 2).toFixed(2);
            } else {
                els.customSplitArea.classList.add('hidden');
            }
        });

        els.totalAmount.addEventListener('input', () => autoCalculate('Total'));
        els.amountH.addEventListener('input', () => autoCalculate('H'));
        els.amountM.addEventListener('input', () => autoCalculate('M'));

        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showModal('éŒ¯èª¤', 'å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•å„²å­˜ã€‚');
                return;
            }

            const date = els.date.value;
            const currency = els.currency.value;
            const totalOriginal = parseFloat(els.totalAmount.value);
            const payer = document.querySelector('input[name="payer"]:checked').value;
            const desc = els.desc.value.trim();
            const splitType = els.splitType.value;

            if (!date || isNaN(totalOriginal) || !desc) {
                showModal('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
                return;
            }

            let rate = 1;
            if (currency !== 'TWD') {
                if (!exchangeRates) {
                    showModal('éŒ¯èª¤', 'åŒ¯ç‡å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™æˆ–ä½¿ç”¨ TWD');
                    return;
                }
                rate = exchangeRates[currency];
            }

            const totalTWD = totalOriginal * rate;
            let netChangeForM = 0;
            let amountMTWD = 0;
            let amountHTWD = 0;

            if (splitType === 'equal') {
                amountMTWD = totalTWD / 2;
                amountHTWD = totalTWD / 2;
            } else {
                const valH = parseFloat(els.amountH.value) || 0;
                const valM = parseFloat(els.amountM.value) || 0;
                // å…è¨±å°æ–¼ä¸€å…ƒçš„èª¤å·®
                if (Math.abs((valH + valM) - totalOriginal) > 0.99) {
                    showModal('éŒ¯èª¤', 'è‡ªè¨‚åˆ†å¸³é‡‘é¡ç¸½å’Œèˆ‡ç¸½é‡‘é¡ç›¸å·®éå¤§ï¼Œè«‹æª¢æŸ¥ã€‚');
                    return;
                }
                amountMTWD = valM * rate;
                amountHTWD = valH * rate;
            }

            if (payer === 'H') {
                // H ä»˜éŒ¢ï¼ŒH æ‡‰å¾— amountHTWDï¼ŒM æ‡‰å¾— amountMTWD
                netChangeForM = amountMTWD - amountHTWD; // M æ‡‰ä»˜ - H æ‡‰ä»˜ (M çš„è§’åº¦)
            } else { // Payer === 'M'
                // M ä»˜éŒ¢ï¼ŒH æ‡‰å¾— amountHTWDï¼ŒM æ‡‰å¾— amountMTWD
                netChangeForM = amountMTWD - amountHTWD; // M æ‡‰ä»˜ - H æ‡‰ä»˜ (M çš„è§’åº¦)
            }
            
            // ç”±æ–¼ payer æ˜¯å…ˆä»˜éŒ¢çš„äººï¼Œæ‰€ä»¥ payer æ‡‰è©²å¾—åˆ° full amountï¼Œ
            // å¦ä¸€å€‹äººæ‰¿æ“”ä»–çš„ä»½é¡ã€‚
            // M æ¬  H: netChangeForM > 0
            // H æ¬  M: netChangeForM < 0
            
            // ä¿®æ­£é‚è¼¯ï¼š
            // H ä»˜æ¬¾ï¼ŒM æ‡‰ä»˜ amountMTWDã€‚H å¢Šä»˜äº† amountMTWDã€‚
            //   M æ¬  H: +amountMTWD
            // M ä»˜æ¬¾ï¼ŒH æ‡‰ä»˜ amountHTWDã€‚M å¢Šä»˜äº† amountHTWDã€‚
            //   M æ¬  H: -amountHTWD (H æ¬  M)

            // netChangeForM = (M æ‡‰ä»˜çš„é‡‘é¡) - (H æ‡‰ä»˜çš„é‡‘é¡)
            // (M çš„é¤˜é¡è®ŠåŒ–ï¼Œæ­£æ•¸ä»£è¡¨ M æ¬  H æ›´å¤š)

            // Payer: H
            // M æ‡‰ä»˜: amountMTWD
            // H æ‡‰ä»˜: amountHTWD
            // H æ”¯ä»˜ TotalTWD
            // M æ¬  H çš„é‡‘é¡å¢åŠ  (M çš„æ·¨è®ŠåŒ–) = amountMTWD 
            // H æ¬  M çš„é‡‘é¡å¢åŠ  (M çš„æ·¨è®ŠåŒ–) = -amountHTWD
            // M çš„æœ€çµ‚æ·¨è®ŠåŒ– (Hä»˜å¸³) = amountMTWD - amountHTWD

            // Payer: M
            // M æ‡‰ä»˜: amountMTWD
            // H æ‡‰ä»˜: amountHTWD
            // M æ”¯ä»˜ TotalTWD
            // M å¢Šä»˜ H çš„é‡‘é¡ (M çš„æ·¨è®ŠåŒ–) = -amountHTWD
            // M å¢Šä»˜ M çš„é‡‘é¡ (M çš„æ·¨è®ŠåŒ–) = amountMTWD
            // M çš„æœ€çµ‚æ·¨è®ŠåŒ– (Mä»˜å¸³) = -amountHTWD + amountMTWD
            
            // çµè«–ï¼š netChangeForM æ†ç­‰æ–¼ amountMTWD - amountHTWD
            netChangeForM = amountMTWD - amountHTWD;

            els.submitBtn.disabled = true;
            els.submitBtn.textContent = 'è™•ç†ä¸­...';

            try {
                await addDoc(getExpensesRef(), {
                    date,
                    description: desc,
                    currency,
                    originalAmount: totalOriginal,
                    rate, 
                    totalTWD,
                    payer,
                    splitType,
                    netChangeForM, // ç´€éŒ„ M ç›¸å°æ–¼ H çš„æ·¨è®ŠåŒ– (M > 0 æ¬  H; M < 0 H æ¬  M)
                    createdAt: serverTimestamp()
                });

                // é€™è£¡æˆ‘å€‘ä¾ç„¶ä½¿ç”¨è®€å–-å¯«å…¥çš„æ–¹å¼ä¾†æ›´æ–°é¤˜é¡
                const balanceRef = getBalanceRef();
                const balanceSnap = await getDoc(balanceRef);
                let currentBalance = 0;
                if (balanceSnap.exists()) {
                    currentBalance = balanceSnap.data().amount || 0;
                }
                // H ä»˜éŒ¢: currentBalance + netChangeForM
                // M ä»˜éŒ¢: currentBalance - netChangeForM
                
                // é€™è£¡çš„ netChangeForM å·²ç¶“æ˜¯ M æ¬  H çš„æ·¨è®ŠåŒ–ï¼Œ
                // ä¸ç®¡èª°ä»˜éŒ¢ï¼Œæ–°çš„æ¬ æ¬¾å°±æ˜¯èˆŠæ¬ æ¬¾åŠ ä¸Šé€™ç­†äº¤æ˜“å° M çš„æ·¨å½±éŸ¿ã€‚
                // äº¤æ˜“é‚è¼¯å·²èª¿æ•´ï¼Œ netChangeForM > 0 è¡¨ç¤º M æ¬  Hï¼Œ< 0 è¡¨ç¤º H æ¬  M
                
                const newBalance = currentBalance + netChangeForM;
                
                await setDoc(balanceRef, { 
                    amount: newBalance,
                    lastUpdated: serverTimestamp()
                });

                els.form.reset();
                els.date.valueAsDate = new Date();
                // Reset currency label visually
                els.currency.value = 'TWD';
                els.currencyLabel.textContent = 'TWD';
                els.customSplitArea.classList.add('hidden');
                els.submitBtn.disabled = false;
                
                // ç°¡å–®çš„æˆåŠŸå›é¥‹å‹•ç•« (å¯é¸)
                els.submitBtn.classList.add('bg-accent-teal');
                els.submitBtn.textContent = 'å·²å„²å­˜ï¼';
                setTimeout(() => {
                     els.submitBtn.classList.remove('bg-accent-teal');
                     els.submitBtn.textContent = 'ç¢ºèªå„²å­˜ç´€éŒ„';
                }, 1500);


            } catch (e) {
                console.error(e);
                showModal('éŒ¯èª¤', 'å„²å­˜å¤±æ•—: ' + e.message, 'âŒ');
                els.submitBtn.disabled = false;
                els.submitBtn.textContent = 'ç¢ºèªå„²å­˜ç´€éŒ„';
            }
        });

        // --- 8. å•Ÿå‹•ç¨‹åº (ä¸è®Š) ---

        els.date.valueAsDate = new Date();
        updateStatus('loading');
        els.modalCloseBtn.onclick = closeModal;
        els.modalActionBtn.onclick = closeModal; // ç¢ºä¿æœ‰é»˜èªè¡Œç‚º

        // æ·»åŠ åˆ—è¡¨å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);


        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                els.userId.textContent = `ID: ${user.uid.slice(0, 6)}`;
                updateStatus('connected');
                
                onSnapshot(getBalanceRef(), (doc) => {
                    if (doc.exists()) renderBalance(doc.data().amount || 0);
                    else renderBalance(0);
                });
                
                onSnapshot(getSettingsRef(), (doc) => {
                    if (doc.exists()) {
                        Object.assign(partyNames, { H: 'æˆå“¡ H', M: 'æˆå“¡ M' }, doc.data());
                        updateNamesUI();
                        // ç¢ºä¿åœ¨åç¨±æ›´æ–°æ™‚ï¼Œé¤˜é¡é¡¯ç¤ºä¹Ÿæ›´æ–°
                        getDoc(getBalanceRef()).then(snap => {
                            if(snap.exists()) renderBalance(snap.data().amount || 0);
                        });
                    }
                });

                onSnapshot(query(getExpensesRef(), limit(10)), (snapshot) => {
                    const docs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().createdAt?.toMillis() || 0;
                        const timeB = b.data().createdAt?.toMillis() || 0;
                        return timeB - timeA; // é™åº
                    });
                    renderList(docs.slice(0, 5));
                });

            } else {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    signInWithCustomToken(auth, token).catch(e => {
                        console.error("Custom Token ç™»å…¥å¤±æ•—", e);
                        updateStatus('error');
                        signInAnonymously(auth).catch(err => console.error("åŒ¿åå¾Œå‚™å¤±æ•—", err));
                    });
                } else {
                    signInAnonymously(auth).catch(e => {
                        console.error("åŒ¿åç™»å…¥å¤±æ•—", e);
                        updateStatus('error');
                    });
                }
            }
        });

        fetchRates();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HnM Split | 無賴帳本</title>
    <!-- React, ReactDOM, Babel for running JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; overflow-x: hidden; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Basic animations for transitions */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- Icons Components (Lucide) ---
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/><path d="M3 3v9h9"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 12"/><path d="M21 3v9h-9"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 12"/><path d="M3 21v-9h9"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Split: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>,
            Coins: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m7.1 10.28 1.4-1.428m-1.428 0 1.428 1.428"/></svg>
        };

        // --- Utils ---
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(amount);
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // Custom modal function instead of alert/confirm
        const useModal = () => {
            const [isVisible, setIsVisible] = useState(false);
            const [message, setMessage] = useState('');
            const [isConfirm, setIsConfirm] = useState(false);
            const [resolvePromise, setResolvePromise] = useState(null);

            const show = (msg, confirm = false) => new Promise((resolve) => {
                setMessage(msg);
                setIsConfirm(confirm);
                setResolvePromise(() => resolve);
                setIsVisible(true);
            });

            const handleClose = (result) => {
                setIsVisible(false);
                if (resolvePromise) {
                    resolvePromise(result);
                }
            };

            const Modal = () => isVisible && (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999]">
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
                        <p className="font-medium text-gray-800 mb-6">{message}</p>
                        <div className={`flex ${isConfirm ? 'justify-between' : 'justify-center'} gap-3`}>
                            {isConfirm && (
                                <button onClick={() => handleClose(false)} className="flex-1 py-3 px-4 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200">
                                    取消
                                </button>
                            )}
                            <button onClick={() => handleClose(true)} className={`flex-1 py-3 px-4 rounded-lg font-bold text-white transition-colors ${isConfirm ? 'bg-rose-500 hover:bg-rose-600' : 'bg-teal-600 hover:bg-teal-700'}`}>
                                {isConfirm ? '確認' : '確定'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            return { Modal, show };
        };


        // --- Main App ---
        const App = () => {
            const { Modal, show } = useModal();
            
            // State
            const [view, setView] = useState('HOME'); // HOME, ADD, SETTLE, HISTORY, SETTINGS
            const [users, setUsers] = useState({ H: 'H 方', M: 'M 方' });
            const [transactions, setTransactions] = useState([]);
            const [baseRates, setBaseRates] = useState({ USD: 32.5, JPY: 0.21 }); // Default fallback rates
            const [rateLoading, setRateLoading] = useState(false);

            // Load data on mount
            useEffect(() => {
                const savedData = localStorage.getItem('hnm_split_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        setUsers(parsed.users || { H: 'H 方', M: 'M 方' });
                        setTransactions(parsed.transactions || []);
                        if(parsed.rates) setBaseRates(parsed.rates);
                    } catch (e) {
                        console.error("Failed to parse localStorage data:", e);
                        // Fallback to initial state on error
                    }
                }
                fetchRates();
            }, []);

            // Save data on change
            useEffect(() => {
                localStorage.setItem('hnm_split_data', JSON.stringify({ users, transactions, rates: baseRates }));
            }, [users, transactions, baseRates]);

            // Fetch current exchange rates (Mock API Call)
            const fetchRates = async () => {
                setRateLoading(true);
                try {
                    // Using an open API for rate fetching
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    if (res.ok) {
                        const data = await res.json();
                        if (data && data.rates) {
                            // Calculate TWD per foreign currency (1 / Rate)
                            setBaseRates({
                                USD: parseFloat((1 / data.rates.USD).toFixed(4)),
                                JPY: parseFloat((1 / data.rates.JPY).toFixed(4))
                            });
                            await show('匯率已成功更新！');
                        }
                    } else {
                        await show('無法更新匯率，將使用上次儲存的預設值。', false);
                    }
                } catch (e) {
                    console.error("Rate fetch failed:", e);
                    await show('無法連線到匯率服務，將使用上次儲存的預設值。', false);
                } finally {
                    setRateLoading(false);
                }
            };

            // Logic: Calculate Balance
            const balance = useMemo(() => {
                let hPaid = 0; // Total TWD H actually paid out
                let hShare = 0; // Total TWD H *should* have paid (fair share)
                
                transactions.forEach(tx => {
                    const amountTWD = tx.amount * tx.rate;
                    
                    // Who paid?
                    if (tx.payer === 'H') hPaid += amountTWD;
                    
                    // Calculate H's share (what H should have paid)
                    if (tx.type === 'SETTLE') {
                        // Settle up: This is a direct payment from Payer to the other person.
                        // H's share of the EXPENSE is 0. 
                        // If M pays H (payer='M'), H receives money, so H's share is the full amount to offset H's credit.
                        if (tx.payer === 'M') {
                             hShare += amountTWD; // When M pays H, H receives M's payment (credit offset)
                        } else {
                            // If H pays M (payer='H'), H is paying off M's credit. H's share is 0 in this transaction.
                        }
                    } else {
                        // Expense
                        if (tx.splitType === 'EQUAL') {
                            hShare += amountTWD / 2;
                        } else {
                            // Custom split: tx.customH is raw amount in original currency
                            hShare += Number(tx.customH || 0) * tx.rate;
                        }
                    }
                });

                // Positive = H Paid > H Share (H is creditor, M owes H)
                // Negative = H Paid < H Share (H is debtor, H owes M)
                return Math.round((hPaid - hShare) * 100) / 100; // Round to prevent float errors

            }, [transactions]);

            const addTransaction = (tx) => {
                setTransactions([tx, ...transactions]);
                setView('HOME');
            };

            const deleteTransaction = async (id) => {
                const confirmed = await show("確定要刪除這筆紀錄嗎？此動作無法復原。", true);
                if(confirmed) {
                    setTransactions(transactions.filter(t => t.id !== id));
                    show("紀錄已刪除。");
                }
            };

            // --- Views ---

            const HomeView = () => (
                <div className="pb-20 animate-fade-in">
                    {/* Header */}
                    <div className="bg-white p-6 rounded-b-3xl shadow-sm z-10 relative">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center space-x-2">
                                <div className="w-8 h-8 bg-teal-500 rounded flex items-center justify-center text-white font-bold text-sm shadow-md">HM</div>
                                <span className="font-bold text-gray-800 tracking-tight">HnM Split <span className="text-xs text-gray-400 font-normal ml-1">無賴帳本</span></span>
                            </div>
                            <button onClick={() => setView('SETTINGS')} className="text-gray-400 p-2 rounded-full hover:bg-gray-100 transition-colors"><Icons.Settings /></button>
                        </div>

                        {/* Balance Card */}
                        <div className="text-center py-4">
                            <p className="text-gray-500 text-sm font-medium mb-1">目前狀態 (TWD)</p>
                            {Math.abs(balance) < 1 ? (
                                <div className="text-teal-500 font-bold text-3xl py-2 flex items-center justify-center gap-2">
                                    <Icons.CheckCircle className="w-8 h-8"/> 帳目已清空
                                </div>
                            ) : (
                                <>
                                    <div className={`text-xl font-bold mb-2 ${balance > 0 ? 'text-teal-600' : 'text-rose-500'}`}>
                                        {balance > 0 ? users.M : users.H} 
                                        <span className="text-gray-500 text-base mx-1 font-normal">應付給</span> 
                                        {balance > 0 ? users.H : users.M}
                                    </div>
                                    <div className={`text-5xl font-black tracking-tighter ${balance > 0 ? 'text-teal-800' : 'text-rose-700'}`}>
                                        ${formatMoney(Math.abs(balance))}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Quick Actions */}
                        <div className="grid grid-cols-2 gap-4 mt-8">
                            <button 
                                onClick={() => setView('SETTLE')}
                                className="flex items-center justify-center gap-2 py-3 px-4 bg-teal-50 text-teal-700 rounded-xl font-bold hover:bg-teal-100 transition-colors">
                                <Icons.Coins className="w-5 h-5" />
                                結算還款
                            </button>
                            <button 
                                onClick={() => setView('HISTORY')}
                                className="flex items-center justify-center gap-2 py-3 px-4 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                                <Icons.History className="w-5 h-5" />
                                交易紀錄
                            </button>
                        </div>
                    </div>

                    {/* Recent Transactions */}
                    <div className="px-6 py-6">
                        <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">最近紀錄</h3>
                        <div className="space-y-3">
                            {transactions.length === 0 ? (
                                <div className="text-center text-gray-400 py-8 text-sm bg-white rounded-xl shadow-inner">還沒有紀錄，快去新增一筆吧！</div>
                            ) : (
                                transactions.slice(0, 5).map(tx => (
                                    <div key={tx.id} className="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-50">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-inner ${tx.type === 'SETTLE' ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>
                                                {tx.type === 'SETTLE' ? <Icons.Coins size={18}/> : <Icons.Split size={18}/>}
                                            </div>
                                            <div>
                                                <div className="font-bold text-gray-800">{tx.item}</div>
                                                <div className="text-xs text-gray-400">
                                                    {new Date(tx.date).toLocaleDateString()} • {tx.payer === 'H' ? users.H : users.M} 付款
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`font-bold ${tx.type === 'SETTLE' ? 'text-green-600' : 'text-gray-800'}`}>
                                                {formatMoney(tx.amount)} <span className="text-xs">{tx.currency}</span>
                                            </div>
                                            {tx.currency !== 'TWD' && (
                                                <div className="text-xs text-gray-400">≈ {formatMoney(tx.amount * tx.rate)} TWD</div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                    
                    {/* FAB */}
                    <button 
                        onClick={() => setView('ADD')}
                        className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl hover:bg-teal-700 hover:scale-105 transition-all duration-200 z-50">
                        <Icons.Plus size={32} />
                    </button>
                </div>
            );

            const AddView = () => {
                const [amount, setAmount] = useState('');
                const [item, setItem] = useState('');
                const [currency, setCurrency] = useState('TWD');
                const [payer, setPayer] = useState('H'); // Default H
                const [splitType, setSplitType] = useState('EQUAL');
                const [rate, setRate] = useState(1);
                const [customH, setCustomH] = useState('');
                const [customM, setCustomM] = useState('');

                const totalAmount = Number(amount) || 0;

                // Update rate when currency changes
                useEffect(() => {
                    if (currency === 'TWD') setRate(1);
                    else if (currency === 'USD') setRate(baseRates.USD);
                    else if (currency === 'JPY') setRate(baseRates.JPY);
                    // Ensure the rate is not NaN or 0 if it was updated by user before
                    if(rate === 0 || isNaN(rate)) setRate(1);
                }, [currency, baseRates]);

                // --- 新增的自動計算邏輯 ---
                // 處理 H 方金額變動
                const handleCustomHChange = (e) => {
                    const hValue = parseFloat(e.target.value);
                    setCustomH(e.target.value);
                    if (!isNaN(hValue) && hValue >= 0 && totalAmount > 0) {
                        // 計算 M 方應付金額 = 總金額 - H 方金額，並四捨五入到小數點後兩位
                        const mValue = Math.round((totalAmount - hValue) * 100) / 100;
                        setCustomM(mValue >= 0 ? mValue.toString() : '');
                    } else if (e.target.value === '') {
                        setCustomM(totalAmount > 0 ? totalAmount.toString() : '');
                    }
                };

                // 處理 M 方金額變動
                const handleCustomMChange = (e) => {
                    const mValue = parseFloat(e.target.value);
                    setCustomM(e.target.value);
                    if (!isNaN(mValue) && mValue >= 0 && totalAmount > 0) {
                        // 計算 H 方應付金額 = 總金額 - M 方金額，並四捨五入到小數點後兩位
                        const hValue = Math.round((totalAmount - mValue) * 100) / 100;
                        setCustomH(hValue >= 0 ? hValue.toString() : '');
                    } else if (e.target.value === '') {
                        setCustomH(totalAmount > 0 ? totalAmount.toString() : '');
                    }
                };
                
                // 處理金額欄位失去焦點時的四捨五入
                const handleBlur = (setter, value) => {
                    if (value !== '') {
                        const numericValue = parseFloat(value);
                        if (!isNaN(numericValue)) {
                            setter(numericValue.toFixed(2));
                        }
                    }
                };
                
                // 當金額改變時，重設自訂分攤金額或計算均分金額
                useEffect(() => {
                    if (splitType === 'EQUAL' && totalAmount > 0) {
                        // 均分時，自動設定為總金額的一半
                        const equalSplit = (totalAmount / 2).toFixed(2);
                        setCustomH(equalSplit);
                        setCustomM(equalSplit);
                    } else if (splitType === 'CUSTOM' && totalAmount > 0) {
                        // 如果 H 或 M 為空，則將總金額全部給對方
                        if (customH === '' && customM === '') {
                             setCustomH(totalAmount.toFixed(2));
                             setCustomM('');
                        } else if (customH !== '' && customM === '') {
                             const mValue = Math.round((totalAmount - Number(customH)) * 100) / 100;
                             setCustomM(mValue.toFixed(2));
                        } else if (customH === '' && customM !== '') {
                             const hValue = Math.round((totalAmount - Number(customM)) * 100) / 100;
                             setCustomH(hValue.toFixed(2));
                        }
                    }
                }, [amount, splitType]);
                // --- 結束自動計算邏輯 ---


                const handleSubmit = async () => {
                    if (!amount || !item) {
                        return await show('請輸入金額和項目');
                    }
                    if (totalAmount <= 0) {
                        return await show('金額必須大於零');
                    }
                    
                    const finalCustomH = Number(customH || 0);
                    const finalCustomM = Number(customM || 0);

                    if (splitType === 'CUSTOM') {
                        const totalCustom = finalCustomH + finalCustomM;
                        // Check if the total custom split matches the total amount (allowing for small float differences)
                        if (Math.abs(totalCustom - totalAmount) > 0.01) { 
                            return await show(`自訂分攤金額總和 (${formatMoney(totalCustom)}) 必須等於總金額 (${formatMoney(totalAmount)})`);
                        }
                    }

                    addTransaction({
                        id: generateId(),
                        date: new Date().toISOString(),
                        type: 'EXPENSE',
                        item,
                        amount: totalAmount,
                        currency,
                        rate: Number(rate),
                        payer,
                        splitType,
                        customH: splitType === 'CUSTOM' ? finalCustomH : null,
                        customM: splitType === 'CUSTOM' ? finalCustomM : null
                    });
                };

                return (
                    <div className="min-h-screen bg-white pb-20 animate-fade-in">
                         <div className="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-20 shadow-sm">
                            <button onClick={() => setView('HOME')} className="text-gray-500 p-1 rounded-full hover:bg-gray-100"><Icons.ArrowLeft/></button>
                            <h2 className="font-bold text-lg">新增支出</h2>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            {/* Amount & Currency */}
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-1 uppercase">金額與幣別</label>
                                <div className="flex gap-3">
                                    <div className="relative flex-1">
                                        <input type="number" inputMode="decimal" placeholder="0" value={amount} onChange={e => setAmount(e.target.value)} 
                                            className="w-full text-4xl font-bold text-gray-800 border-b-2 border-gray-200 focus:border-teal-500 outline-none py-2 bg-transparent placeholder-gray-300" autoFocus />
                                    </div>
                                    <select value={currency} onChange={e => setCurrency(e.target.value)} className="bg-gray-100 rounded-xl px-4 font-bold text-gray-700 border-none outline-none focus:ring-2 focus:ring-teal-500">
                                        <option value="TWD">TWD</option>
                                        <option value="USD">USD</option>
                                        <option value="JPY">JPY</option>
                                    </select>
                                </div>
                                {currency !== 'TWD' && (
                                    <div className="mt-3 bg-blue-50 p-3 rounded-lg flex items-center justify-between text-sm text-blue-800">
                                        <span className="flex items-center gap-1">匯率 (1 {currency} = ) <input type="number" value={rate} onChange={e => setRate(e.target.value)} className="w-16 border-b border-blue-300 bg-transparent text-center font-bold outline-none"/> TWD</span>
                                        <span className="font-bold opacity-80">≈ {amount ? formatMoney(totalAmount * rate) : 0} TWD</span>
                                    </div>
                                )}
                            </div>

                            {/* Item */}
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-1 uppercase">項目名稱</label>
                                <input type="text" placeholder="例如：晚餐、電影票" value={item} onChange={e => setItem(e.target.value)} 
                                    className="w-full text-lg text-gray-800 border-b border-gray-200 focus:border-teal-500 outline-none py-2" />
                            </div>

                            {/* Payer */}
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">誰付的錢？</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setPayer('H')} className={`py-3 rounded-xl font-medium transition-all ${payer === 'H' ? 'bg-teal-600 text-white shadow-lg shadow-teal-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{users.H}</button>
                                    <button onClick={() => setPayer('M')} className={`py-3 rounded-xl font-medium transition-all ${payer === 'M' ? 'bg-teal-600 text-white shadow-lg shadow-teal-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{users.M}</button>
                                </div>
                            </div>

                            {/* Split Type */}
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">如何分攤？</label>
                                <div className="bg-gray-100 p-1 rounded-xl flex mb-4">
                                    <button onClick={() => setSplitType('EQUAL')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${splitType === 'EQUAL' ? 'bg-white shadow text-teal-700' : 'text-gray-500 hover:bg-gray-200'}`}>均分 (50/50)</button>
                                    <button onClick={() => setSplitType('CUSTOM')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${splitType === 'CUSTOM' ? 'bg-white shadow text-teal-700' : 'text-gray-500 hover:bg-gray-200'}`}>指定金額</button>
                                </div>

                                {splitType === 'CUSTOM' && (
                                    <div className="grid grid-cols-2 gap-4 animate-fade-in">
                                        <div>
                                            <label className="text-xs text-gray-500 mb-1 block">{users.H} 應付 ({currency})</label>
                                            <input 
                                                type="number" 
                                                inputMode="decimal" 
                                                value={customH} 
                                                onChange={handleCustomHChange} 
                                                onBlur={() => handleBlur(setCustomH, customH)}
                                                className="w-full border-2 border-gray-200 rounded-xl p-3 mt-1 font-medium focus:border-teal-500 outline-none" 
                                                placeholder="0.00" 
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 mb-1 block">{users.M} 應付 ({currency})</label>
                                            <input 
                                                type="number" 
                                                inputMode="decimal" 
                                                value={customM} 
                                                onChange={handleCustomMChange} 
                                                onBlur={() => handleBlur(setCustomM, customM)}
                                                className="w-full border-2 border-gray-200 rounded-xl p-3 mt-1 font-medium focus:border-teal-500 outline-none" 
                                                placeholder="0.00" 
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>

                            <button onClick={handleSubmit} className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-black active:scale-[0.98] transition-all mt-4">
                                確認新增支出
                            </button>
                        </div>
                    </div>
                );
            };

            const SettleView = () => {
                // Ensure amount is positive for calculation
                const defaultAmount = Math.abs(balance);
                const [amount, setAmount] = useState(defaultAmount > 0 ? defaultAmount : 0);
                const [currency, setCurrency] = useState('TWD'); 
                const [payer, setPayer] = useState(balance > 0 ? 'M' : 'H'); // If H is owed (balance>0), M pays H.

                const [rate, setRate] = useState(1);

                 // Update rate
                 useEffect(() => {
                    if (currency === 'TWD') setRate(1);
                    else if (currency === 'USD') setRate(baseRates.USD);
                    else if (currency === 'JPY') setRate(baseRates.JPY);
                     if(rate === 0 || isNaN(rate)) setRate(1);
                }, [currency, baseRates]);

                const handleSettle = async () => {
                    if (Number(amount) <= 0) {
                        return await show('還款金額必須大於零');
                    }

                     addTransaction({
                        id: generateId(),
                        date: new Date().toISOString(),
                        type: 'SETTLE',
                        item: `還款 (${payer === 'H' ? users.H : users.M} -> ${payer === 'H' ? users.M : users.H})`,
                        amount: Number(amount),
                        currency,
                        rate: Number(rate),
                        payer,
                        splitType: 'SETTLE', // Special type
                        customH: 0, customM: 0
                    });
                };

                return (
                    <div className="min-h-screen bg-white animate-fade-in">
                        <div className="p-4 border-b flex items-center gap-4 bg-teal-50 shadow-sm">
                            <button onClick={() => setView('HOME')} className="text-teal-800 p-1 rounded-full hover:bg-teal-100"><Icons.ArrowLeft/></button>
                            <h2 className="font-bold text-lg text-teal-900">清算還款</h2>
                        </div>
                        <div className="p-6 text-center">
                            <div className="bg-teal-50 rounded-2xl p-6 mb-8 border border-teal-200 shadow-md">
                                <p className="text-teal-600 text-sm font-bold mb-2 uppercase tracking-wide">建議還款金額 (TWD)</p>
                                <h1 className="text-4xl font-black text-teal-900 mb-2">${formatMoney(defaultAmount)}</h1>
                                <p className="text-sm text-teal-700">應由 <b>{balance > 0 ? users.M : users.H}</b> 支付給 <b>{balance > 0 ? users.H : users.M}</b></p>
                            </div>

                            <div className="text-left space-y-6">
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 mb-1 uppercase">實際還款金額</label>
                                    <div className="flex gap-3">
                                        <input type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)} className="flex-1 text-3xl font-bold border-b-2 border-gray-200 py-2 outline-none focus:border-teal-500" />
                                        <select value={currency} onChange={e => setCurrency(e.target.value)} className="bg-gray-100 rounded-lg px-3 font-bold border-none outline-none">
                                            <option value="TWD">TWD</option>
                                            <option value="USD">USD</option>
                                            <option value="JPY">JPY</option>
                                        </select>
                                    </div>
                                     {currency !== 'TWD' && (
                                        <div className="mt-2 text-sm text-gray-500 flex items-center gap-2 bg-gray-50 p-2 rounded-lg">
                                            匯率: <input type="number" value={rate} onChange={e=>setRate(e.target.value)} className="w-16 border-b text-center font-bold bg-transparent"/>
                                            = {formatMoney(amount*rate)} TWD
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">誰進行還款？</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => setPayer('H')} className={`py-3 rounded-xl font-medium border-2 transition-all ${payer === 'H' ? 'border-teal-500 bg-teal-50 text-teal-700 shadow-md' : 'border-transparent bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{users.H}</button>
                                        <button onClick={() => setPayer('M')} className={`py-3 rounded-xl font-medium border-2 transition-all ${payer === 'M' ? 'border-teal-500 bg-teal-50 text-teal-700 shadow-md' : 'border-transparent bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{users.M}</button>
                                    </div>
                                </div>

                                <button onClick={handleSettle} className="w-full bg-teal-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-teal-700 active:scale-[0.98] transition-all">
                                    確認還款
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => (
                 <div className="min-h-screen bg-gray-50 animate-fade-in">
                    <div className="p-4 bg-white border-b flex items-center gap-4 sticky top-0 z-10 shadow-sm">
                        <button onClick={() => setView('HOME')} className="text-gray-500 p-1 rounded-full hover:bg-gray-100"><Icons.ArrowLeft/></button>
                        <h2 className="font-bold text-lg">交易紀錄</h2>
                    </div>
                    <div className="p-4 space-y-3">
                        {transactions.map(tx => (
                             <div key={tx.id} className="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-inner ${tx.type === 'SETTLE' ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>
                                        {tx.type === 'SETTLE' ? <Icons.Coins size={18}/> : <Icons.Split size={18}/>}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{tx.item}</div>
                                        <div className="text-xs text-gray-400">
                                            {new Date(tx.date).toLocaleDateString()} • {tx.payer === 'H' ? users.H : users.M} 付款
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right">
                                        <div className="font-bold text-gray-800">{formatMoney(tx.amount)} {tx.currency}</div>
                                        {tx.currency !== 'TWD' && <div className="text-xs text-gray-400">({formatMoney(tx.amount * tx.rate)} TWD)</div>}
                                    </div>
                                    <button onClick={() => deleteTransaction(tx.id)} className="text-gray-300 p-1 rounded-full hover:text-rose-500 hover:bg-rose-50 transition-colors">
                                        <Icons.Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        ))}
                        {transactions.length === 0 && <div className="text-center text-gray-400 mt-10 p-8 bg-white rounded-xl shadow-inner">尚無紀錄</div>}
                    </div>
                </div>
            );

            const SettingsView = () => (
                <div className="min-h-screen bg-white animate-fade-in">
                    <div className="p-4 border-b flex items-center gap-4 shadow-sm">
                        <button onClick={() => setView('HOME')} className="text-gray-500 p-1 rounded-full hover:bg-gray-100"><Icons.ArrowLeft/></button>
                        <h2 className="font-bold text-lg">設定</h2>
                    </div>
                    <div className="p-6 space-y-8">
                        <div>
                            <h3 className="text-sm font-bold text-gray-400 uppercase mb-4">使用者名稱</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">H 方代稱</label>
                                    <input type="text" value={users.H} onChange={e => setUsers({...users, H: e.target.value})} className="w-full border-b pb-2 outline-none focus:border-teal-500 font-medium text-lg" placeholder="H 方" />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">M 方代稱</label>
                                    <input type="text" value={users.M} onChange={e => setUsers({...users, M: e.target.value})} className="w-full border-b pb-2 outline-none focus:border-teal-500 font-medium text-lg" placeholder="M 方" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-end mb-4">
                                <h3 className="text-sm font-bold text-gray-400 uppercase">預設匯率 (Base: TWD)</h3>
                                <button onClick={fetchRates} disabled={rateLoading} className={`text-teal-600 text-xs font-bold flex items-center gap-1 p-2 rounded-lg ${rateLoading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-teal-50'}`}>
                                    <Icons.RefreshCw size={12} className={rateLoading ? 'animate-spin' : ''}/> 
                                    {rateLoading ? '更新中...' : '更新匯率'}
                                </button>
                            </div>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b pb-2">
                                    <span className="font-medium text-gray-700">USD</span>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-400">1 USD =</span>
                                        <input type="number" inputMode="decimal" value={baseRates.USD} onChange={e => setBaseRates({...baseRates, USD: parseFloat(e.target.value)})} className="w-20 text-right font-bold outline-none" />
                                        <span className="text-xs text-gray-400">TWD</span>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center border-b pb-2">
                                    <span className="font-medium text-gray-700">JPY</span>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-400">1 JPY =</span>
                                        <input type="number" inputMode="decimal" value={baseRates.JPY} onChange={e => setBaseRates({...baseRates, JPY: parseFloat(e.target.value)})} className="w-20 text-right font-bold outline-none" />
                                        <span className="text-xs text-gray-400">TWD</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <div className="pt-8 border-t">
                            <button onClick={() => { show('確定要清除所有資料嗎？此動作無法復原。', true).then(confirmed => {
                                if (confirmed) {
                                    localStorage.removeItem('hnm_split_data'); 
                                    window.location.reload(); 
                                }
                            }); }} className="w-full py-3 text-rose-500 font-medium bg-rose-50 rounded-xl hover:bg-rose-100 transition-colors">
                                清除所有資料
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="app-container font-sans text-gray-900">
                    <Modal />
                    {view === 'HOME' && <HomeView />}
                    {view === 'ADD' && <AddView />}
                    {view === 'SETTLE' && <SettleView />}
                    {view === 'HISTORY' && <HistoryView />}
                    {view === 'SETTINGS' && <SettingsView />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
Initial commit of the HnM_Spliter

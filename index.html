<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬ HnM Spliter</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',   // indigo-600
                        secondary: '#10b981', // emerald-500 (å„ªå‹¢/è¢«æ¬ éŒ¢)
                        danger: '#ef4444',    // red-500 (åŠ£å‹¢/æ¬ éŒ¢)
                        warning: '#f59e0b',   // amber-500
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen flex justify-center items-start">

    <div class="w-full max-w-lg space-y-6">
        
        <!-- æ¨™é¡Œèˆ‡é€£ç·šç‹€æ…‹ -->
        <div class="flex justify-between items-end px-1">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">ç„¡è³´å¸³æœ¬ <span class="text-2xl">ğŸ¤¡</span></h1>
            <div class="text-right">
                <div class="flex items-center justify-end space-x-1">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></div>
                    <span id="connection-status" class="text-xs font-medium text-gray-500">é€£ç·šä¸­...</span>
                </div>
                <div id="user-id" class="text-[10px] text-gray-400 font-mono mt-0.5">ID: ---</div>
            </div>
        </div>

        <!-- ç¸½æ¬ æ¬¾å¡ç‰‡ (æœ€é†’ç›®) -->
        <div id="balance-card" class="relative overflow-hidden bg-gradient-to-br from-gray-700 to-gray-900 rounded-2xl shadow-xl p-6 text-white transition-all duration-500">
            <div class="relative z-10">
                <p class="text-sm opacity-80 font-medium mb-1">ç›®å‰ç‹€æ…‹</p>
                <h2 id="balance-status-text" class="text-lg font-bold mb-2">è¼‰å…¥ä¸­...</h2>
                <div class="flex items-baseline space-x-2">
                    <span class="text-4xl font-extrabold tracking-tight" id="balance-amount">---</span>
                    <span class="text-sm font-medium opacity-75">TWD</span>
                </div>
                <p class="text-xs mt-4 opacity-60 border-t border-white/20 pt-2">
                    * æ‰€æœ‰å¤–å¹£äº¤æ˜“çš†å·²ä¾ç•¶ä¸‹åŒ¯ç‡æ›ç®—ç‚ºæ–°å°å¹£çµç®—
                </p>
            </div>
            <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl"></div>
        </div>

        <!-- åŒ¯ç‡è³‡è¨Šè·‘é¦¬ç‡ˆ -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 flex items-center justify-between text-sm">
            <span class="font-bold text-gray-600 mr-2">ä»Šæ—¥åŒ¯ç‡:</span>
            <div id="rates-display" class="flex-1 text-right text-gray-500 font-mono">
                è¼‰å…¥ä¸­...
            </div>
        </div>

        <!-- è¨­å®šå€å¡Š (æ”¶åˆå¼) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <button id="toggle-settings" class="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                <span class="font-bold text-gray-700">âš™ï¸ è¨­å®šæˆå“¡åç¨±</span>
                <svg id="settings-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="settings-panel" class="hidden p-4 space-y-4 border-t border-gray-200">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ä»£è™Ÿ H</label>
                        <input type="text" id="h-name-input" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none" placeholder="ä¾‹å¦‚: å°æ˜">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ä»£è™Ÿ M</label>
                        <input type="text" id="m-name-input" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none" placeholder="ä¾‹å¦‚: å°ç¾">
                    </div>
                </div>
                <button id="save-names-btn" class="w-full py-2 bg-gray-800 text-white text-sm font-bold rounded-lg hover:bg-gray-900 transition-colors">å„²å­˜åç¨±</button>
            </div>
        </div>

        <!-- æ–°å¢ç´€éŒ„è¡¨å–® -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">+</span>
                æ–°å¢ç´€éŒ„
            </h3>
            
            <form id="expense-form" class="space-y-4">
                <!-- 1. æ—¥æœŸèˆ‡å¹£åˆ¥ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å¹£åˆ¥</label>
                        <select id="currency" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                            <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                            <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                            <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                        </select>
                    </div>
                </div>

                <!-- 2. ç¸½é‡‘é¡ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç¸½é‡‘é¡</label>
                    <div class="relative">
                        <input type="number" id="totalAmount" step="0.01" min="0" required class="w-full p-3 pl-4 text-lg font-mono bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="0.00">
                        <span id="currency-label" class="absolute right-4 top-3.5 text-gray-400 text-sm font-bold">TWD</span>
                    </div>
                </div>

                <!-- 3. èª°ä»˜çš„ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">èª°å…ˆä»˜çš„éŒ¢ï¼Ÿ</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="payer" value="H" class="peer sr-only" checked>
                            <div class="p-2 text-center rounded-lg border border-gray-200 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-all">
                                <span id="payer-h-label">æˆ‘ (H)</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payer" value="M" class="peer sr-only">
                            <div class="p-2 text-center rounded-lg border border-gray-200 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition-all">
                                <span id="payer-m-label">å¤¥ä¼´ (M)</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 4. ç”¨é€” -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç”¨é€” / æè¿°</label>
                    <input type="text" id="description" required class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="ä¾‹å¦‚: æ™šé¤ã€è¶…å¸‚æ¡è³¼">
                </div>

                <!-- 5. åˆ†å¸³æ–¹å¼ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†å¸³æ–¹å¼</label>
                    <select id="splitType" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none mb-2">
                        <option value="equal">âš–ï¸ å¹³å‡åˆ†æ”¤ (ä¸€äººä¸€åŠ)</option>
                        <option value="custom">âœï¸ è‡ªè¨‚é‡‘é¡</option>
                    </select>
                    
                    <!-- è‡ªè¨‚é‡‘é¡è¼¸å…¥å€ -->
                    <div id="custom-split-area" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2">
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-sm text-gray-600 truncate" id="split-h-label">H æ‡‰ä»˜</label>
                            <input type="number" id="amountH" step="0.01" class="flex-1 p-1.5 border rounded text-right" placeholder="0">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-sm text-gray-600 truncate" id="split-m-label">M æ‡‰ä»˜</label>
                            <input type="number" id="amountM" step="0.01" class="flex-1 p-1.5 border rounded text-right" placeholder="0">
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transform active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    å„²å­˜ç´€éŒ„
                </button>
            </form>
        </div>

        <!-- æœ€è¿‘ç´€éŒ„ -->
        <div>
            <h3 class="text-lg font-bold text-gray-700 mb-3 px-1">æœ€è¿‘ 5 ç­†ç´€éŒ„</h3>
            <div id="records-list" class="space-y-3 pb-10">
                <!-- ç´€éŒ„é …ç›®æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                <div class="text-center text-gray-400 py-4 text-sm">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

    </div>

    <!-- æç¤ºæ¡† Modal -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 max-w-full mx-4 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-2">æç¤º</h3>
            <p id="modal-msg" class="text-sm text-gray-600 mb-6">è¨Šæ¯å…§å®¹</p>
            <button onclick="closeModal()" class="w-full py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, query, limit, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. è¨­å®šèˆ‡åˆå§‹åŒ– ---
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyCRHx0i02nojkN5-y5HxS3P3i1jA5SEy8E",
                authDomain: "hnm-spliter.firebaseapp.com",
                projectId: "hnm-spliter",
                storageBucket: "hnm-spliter.firebasestorage.app",
                messagingSenderId: "514297368344",
                appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d",
                measurementId: "G-4DY12810X8"
            };
        }

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å…±ç”¨è³‡æ–™å¤¾ ID
        const SHARED_LEDGER_ID = 'hnm_shared_ledger_v1';
        
        // ç‹€æ…‹è®Šæ•¸
        let currentUser = null;
        let exchangeRates = null;
        let partyNames = { H: 'æˆ‘ (H)', M: 'å¤¥ä¼´ (M)' };
        
        // DOM å…ƒç´ 
        const els = {
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('connection-status'),
            userId: document.getElementById('user-id'),
            balanceCard: document.getElementById('balance-card'),
            balanceText: document.getElementById('balance-status-text'),
            balanceAmount: document.getElementById('balance-amount'),
            ratesDisplay: document.getElementById('rates-display'),
            toggleSettings: document.getElementById('toggle-settings'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsIcon: document.getElementById('settings-icon'),
            hNameInput: document.getElementById('h-name-input'),
            mNameInput: document.getElementById('m-name-input'),
            saveNamesBtn: document.getElementById('save-names-btn'),
            form: document.getElementById('expense-form'),
            date: document.getElementById('recordDate'),
            currency: document.getElementById('currency'),
            currencyLabel: document.getElementById('currency-label'),
            totalAmount: document.getElementById('totalAmount'),
            desc: document.getElementById('description'),
            splitType: document.getElementById('splitType'),
            customSplitArea: document.getElementById('custom-split-area'),
            amountH: document.getElementById('amountH'),
            amountM: document.getElementById('amountM'),
            submitBtn: document.getElementById('submit-btn'),
            payerHLabel: document.getElementById('payer-h-label'),
            payerMLabel: document.getElementById('payer-m-label'),
            splitHLabel: document.getElementById('split-h-label'),
            splitMLabel: document.getElementById('split-m-label'),
            list: document.getElementById('records-list'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-msg')
        };

        // --- 2. è¼”åŠ©å‡½å¼ ---

        window.closeModal = () => {
            els.modal.classList.add('hidden');
            els.modal.classList.remove('flex');
        };

        const showModal = (title, msg) => {
            els.modalTitle.textContent = title;
            els.modalMsg.textContent = msg;
            els.modal.classList.remove('hidden');
            els.modal.classList.add('flex');
        };

        const updateStatus = (status) => {
            if (status === 'connected') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                els.statusText.textContent = 'å·²é€£ç·š';
                els.submitBtn.disabled = false;
                els.submitBtn.textContent = 'å„²å­˜ç´€éŒ„';
            } else if (status === 'error') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                els.statusText.textContent = 'é€£ç·šéŒ¯èª¤';
                els.submitBtn.disabled = true;
                els.submitBtn.textContent = 'ç„¡æ³•é€£ç·š';
            } else {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                els.statusText.textContent = 'é€£ç·šä¸­...';
                els.submitBtn.disabled = true;
            }
        };

        // --- 3. è³‡æ–™åº«è·¯å¾‘å®šç¾© (ä¿®æ­£å¾Œ) ---
        // é›†åˆ (Collection) å¿…é ˆæ˜¯ 1, 3, 5... ç‰‡æ®µ
        // æ–‡ä»¶ (Document) å¿…é ˆæ˜¯ 2, 4, 6... ç‰‡æ®µ
        
        const getExpensesRef = () => {
            if (typeof __app_id !== 'undefined') {
                // Path: artifacts/{appId}/public/data/hnm_expenses (5 segments - OK for Collection)
                return collection(db, `artifacts/${__app_id}/public/data/hnm_expenses`);
            }
            // Path: hnm_spliter_data/{ID}/expenses (3 segments - OK for Collection)
            return collection(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/expenses`);
        };

        const getBalanceRef = () => {
            if (typeof __app_id !== 'undefined') {
                // Path: artifacts/{appId}/public/data/hnm_shared/balance (6 segments - OK for Document)
                // Collection: .../hnm_shared (5 segments)
                return doc(db, `artifacts/${__app_id}/public/data/hnm_shared/balance`);
            }
            // Path: hnm_spliter_data/{ID}/shared/balance (4 segments - OK for Document)
            return doc(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/shared/balance`);
        };

        const getSettingsRef = () => {
            if (typeof __app_id !== 'undefined') {
                // Path: artifacts/{appId}/public/data/hnm_shared/settings (6 segments - OK for Document)
                return doc(db, `artifacts/${__app_id}/public/data/hnm_shared/settings`);
            }
            // Path: hnm_spliter_data/{ID}/shared/settings (4 segments - OK for Document)
            return doc(db, `hnm_spliter_data/${SHARED_LEDGER_ID}/shared/settings`);
        };

        // --- 4. åŒ¯ç‡ API ---
        const fetchRates = async () => {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                if (!res.ok) throw new Error('Rate API Error');
                const data = await res.json();
                exchangeRates = {
                    TWD: 1,
                    USD: 1 / data.rates.USD,
                    JPY: 1 / data.rates.JPY
                };
                
                els.ratesDisplay.innerHTML = `
                    <span class="mr-2">ğŸ‡ºğŸ‡¸ 1 USD â‰ˆ ${exchangeRates.USD.toFixed(2)}</span>
                    <span>ğŸ‡¯ğŸ‡µ 1 JPY â‰ˆ ${exchangeRates.JPY.toFixed(2)}</span>
                `;
            } catch (e) {
                console.error("åŒ¯ç‡ç²å–å¤±æ•—", e);
                els.ratesDisplay.textContent = "âš ï¸ åŒ¯ç‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                els.ratesDisplay.classList.add('text-red-500');
            }
        };

        // --- 5. é‚è¼¯èˆ‡äº’å‹• ---

        const updateNamesUI = () => {
            els.payerHLabel.textContent = partyNames.H;
            els.payerMLabel.textContent = partyNames.M;
            els.splitHLabel.textContent = `${partyNames.H} æ‡‰ä»˜`;
            els.splitMLabel.textContent = `${partyNames.M} æ‡‰ä»˜`;
            els.hNameInput.value = partyNames.H === 'æˆ‘ (H)' ? '' : partyNames.H;
            els.mNameInput.value = partyNames.M === 'å¤¥ä¼´ (M)' ? '' : partyNames.M;
        };

        const renderBalance = (balance) => {
            const val = Math.abs(balance);
            els.balanceAmount.textContent = val.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            els.balanceCard.className = "relative overflow-hidden rounded-2xl shadow-xl p-6 text-white transition-all duration-500 bg-gradient-to-br";
            
            if (balance > 5) { // M æ¬  H
                els.balanceCard.classList.add('from-emerald-600', 'to-teal-800');
                els.balanceText.textContent = `ğŸ‰ ${partyNames.M} æ¬  ${partyNames.H}`;
            } else if (balance < -5) { // H æ¬  M
                els.balanceCard.classList.add('from-rose-600', 'to-red-800');
                els.balanceText.textContent = `ğŸ’¸ ${partyNames.H} æ¬  ${partyNames.M}`;
            } else {
                els.balanceCard.classList.add('from-gray-600', 'to-gray-800');
                els.balanceText.textContent = "âš–ï¸ ç›®å‰å…©æ¸…";
            }
        };

        const renderList = (docs) => {
            if (docs.length === 0) {
                els.list.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»è¨˜ä¸€ç­†å§ï¼</div>';
                return;
            }
            
            els.list.innerHTML = docs.map(doc => {
                const data = doc.data();
                const date = new Date(data.date).toLocaleDateString();
                const isPayerH = data.payer === 'H';
                const payerName = isPayerH ? partyNames.H : partyNames.M;
                
                let detailText = '';
                if (data.splitType === 'equal') {
                    detailText = `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">å‡åˆ†</span>`;
                } else {
                    detailText = `<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">è‡ªè¨‚</span>`;
                }

                let rateTag = '';
                if (data.currency !== 'TWD') {
                    rateTag = `<span class="text-[10px] text-gray-400 ml-1">(åŒ¯ç‡ ${data.rate.toFixed(2)})</span>`;
                }

                return `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="flex flex-col items-center justify-center w-10 h-10 rounded-full ${isPayerH ? 'bg-indigo-100 text-indigo-600' : 'bg-orange-100 text-orange-600'} font-bold text-sm">
                            ${data.payer}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${data.description}</div>
                            <div class="text-xs text-gray-500 mt-0.5">${date} Â· ${payerName} å…ˆä»˜ ${rateTag}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-800">${data.originalAmount.toLocaleString()} <span class="text-xs font-normal">${data.currency}</span></div>
                        <div class="mt-1">${detailText}</div>
                    </div>
                </div>
                `;
            }).join('');
        };

        const autoCalculate = (source) => {
            if (els.splitType.value !== 'custom') return;
            const total = parseFloat(els.totalAmount.value);
            if (isNaN(total)) return;

            if (source === 'H') {
                const valH = parseFloat(els.amountH.value) || 0;
                els.amountM.value = (total - valH).toFixed(2);
            } else { 
                const valM = parseFloat(els.amountM.value) || 0;
                els.amountH.value = (total - valM).toFixed(2);
            }
        };

        // --- 6. äº‹ä»¶ç›£è½ ---

        els.toggleSettings.addEventListener('click', () => {
            els.settingsPanel.classList.toggle('hidden');
            els.settingsIcon.classList.toggle('rotate-180');
        });

        els.saveNamesBtn.addEventListener('click', async () => {
            const newH = els.hNameInput.value.trim() || 'æˆ‘ (H)';
            const newM = els.mNameInput.value.trim() || 'å¤¥ä¼´ (M)';
            try {
                await setDoc(getSettingsRef(), { H: newH, M: newM }, { merge: true });
                els.settingsPanel.classList.add('hidden');
                els.settingsIcon.classList.remove('rotate-180');
                showModal('æˆåŠŸ', 'åç¨±å·²æ›´æ–°ï¼');
            } catch (e) {
                console.error(e);
                showModal('éŒ¯èª¤', 'åç¨±å„²å­˜å¤±æ•—: ' + e.message);
            }
        });

        els.currency.addEventListener('change', (e) => {
            els.currencyLabel.textContent = e.target.value;
        });

        els.splitType.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                els.customSplitArea.classList.remove('hidden');
                const total = parseFloat(els.totalAmount.value) || 0;
                els.amountH.value = (total / 2).toFixed(2);
                els.amountM.value = (total / 2).toFixed(2);
            } else {
                els.customSplitArea.classList.add('hidden');
            }
        });

        els.totalAmount.addEventListener('input', () => autoCalculate('Total'));
        els.amountH.addEventListener('input', () => autoCalculate('H'));
        els.amountM.addEventListener('input', () => autoCalculate('M'));

        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showModal('éŒ¯èª¤', 'å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•å„²å­˜ã€‚');
                return;
            }

            const date = els.date.value;
            const currency = els.currency.value;
            const totalOriginal = parseFloat(els.totalAmount.value);
            const payer = document.querySelector('input[name="payer"]:checked').value;
            const desc = els.desc.value.trim();
            const splitType = els.splitType.value;

            if (!date || isNaN(totalOriginal) || !desc) {
                showModal('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
                return;
            }

            let rate = 1;
            if (currency !== 'TWD') {
                if (!exchangeRates) {
                    showModal('éŒ¯èª¤', 'åŒ¯ç‡å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™æˆ–ä½¿ç”¨ TWD');
                    return;
                }
                rate = exchangeRates[currency];
            }

            const totalTWD = totalOriginal * rate;
            let netChangeForM = 0;
            let amountMTWD = 0;
            let amountHTWD = 0;

            if (splitType === 'equal') {
                amountMTWD = totalTWD / 2;
                amountHTWD = totalTWD / 2;
            } else {
                const valH = parseFloat(els.amountH.value) || 0;
                const valM = parseFloat(els.amountM.value) || 0;
                if (Math.abs((valH + valM) - totalOriginal) > 0.1) {
                    showModal('éŒ¯èª¤', 'åˆ†å¸³é‡‘é¡ç¸½å’Œä¸ç­‰æ–¼ç¸½é‡‘é¡');
                    return;
                }
                amountMTWD = valM * rate;
                amountHTWD = valH * rate;
            }

            if (payer === 'H') {
                netChangeForM = amountMTWD;
            } else {
                netChangeForM = -amountHTWD;
            }

            els.submitBtn.disabled = true;
            els.submitBtn.textContent = 'å„²å­˜ä¸­...';

            try {
                await addDoc(getExpensesRef(), {
                    date,
                    description: desc,
                    currency,
                    originalAmount: totalOriginal,
                    rate, 
                    totalTWD,
                    payer,
                    splitType,
                    netChangeForM,
                    createdAt: serverTimestamp()
                });

                const balanceRef = getBalanceRef();
                const balanceSnap = await getDoc(balanceRef);
                let currentBalance = 0;
                if (balanceSnap.exists()) {
                    currentBalance = balanceSnap.data().amount || 0;
                }
                const newBalance = currentBalance + netChangeForM;
                
                await setDoc(balanceRef, { 
                    amount: newBalance,
                    lastUpdated: serverTimestamp()
                });

                els.form.reset();
                els.date.valueAsDate = new Date();
                els.currencyLabel.textContent = 'TWD';
                els.customSplitArea.classList.add('hidden');
                els.submitBtn.disabled = false;
                els.submitBtn.textContent = 'å„²å­˜ç´€éŒ„';
                showModal('æˆåŠŸ', 'ç´€éŒ„å·²å„²å­˜ï¼');

            } catch (e) {
                console.error(e);
                showModal('éŒ¯èª¤', 'å„²å­˜å¤±æ•—: ' + e.message);
                els.submitBtn.disabled = false;
                els.submitBtn.textContent = 'å„²å­˜ç´€éŒ„';
            }
        });

        // --- 7. å•Ÿå‹•ç¨‹åº ---

        els.date.valueAsDate = new Date();
        updateStatus('loading');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                els.userId.textContent = `ID: ${user.uid.slice(0, 6)}...`;
                updateStatus('connected');
                
                onSnapshot(getBalanceRef(), (doc) => {
                    if (doc.exists()) renderBalance(doc.data().amount || 0);
                    else renderBalance(0);
                });
                
                onSnapshot(getSettingsRef(), (doc) => {
                    if (doc.exists()) {
                        partyNames = doc.data();
                        updateNamesUI();
                        // å¦‚æœé¤˜é¡å·²é¡¯ç¤ºï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°åå­—
                        if (els.balanceAmount.textContent !== '---') {
                            const balStr = els.balanceAmount.textContent.replace(/,/g, '');
                            // æˆ‘å€‘éœ€è¦çŸ¥é“åŸå§‹æ­£è² è™Ÿä¾†åˆ¤æ–·æ–¹å‘ï¼Œä½†é€™è£¡åªæœ‰çµ•å°å€¼
                            // ç°¡å–®åšæ³•ï¼šæˆ‘å€‘æ ¹æ“šç•¶å‰ UI æ–‡å­—åæ¨ï¼Œæˆ–è€…ç›´æ¥é‡è®€ä¸€æ¬¡ balance
                            // æœ€å¥½çš„æ–¹å¼æ˜¯ getBalanceRef ç›£è½å™¨æœƒå†æ¬¡è§¸ç™¼å—ï¼Ÿä¸æœƒï¼Œå› ç‚º doc æ²’è®Šã€‚
                            // æ‰€ä»¥é€™è£¡æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡
                            getDoc(getBalanceRef()).then(snap => {
                                if(snap.exists()) renderBalance(snap.data().amount || 0);
                            });
                        }
                    }
                });

                onSnapshot(query(getExpensesRef(), limit(10)), (snapshot) => {
                    const docs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().createdAt?.toMillis() || 0;
                        const timeB = b.data().createdAt?.toMillis() || 0;
                        return timeB - timeA; // é™åº
                    });
                    renderList(docs.slice(0, 5));
                });

            } else {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    signInWithCustomToken(auth, token).catch(e => {
                        console.error("Custom Token ç™»å…¥å¤±æ•—", e);
                        updateStatus('error');
                        signInAnonymously(auth).catch(err => console.error("åŒ¿åå¾Œå‚™å¤±æ•—", err));
                    });
                } else {
                    signInAnonymously(auth).catch(e => {
                        console.error("åŒ¿åç™»å…¥å¤±æ•—", e);
                        updateStatus('error');
                    });
                }
            }
        });

        fetchRates();

    </script>
</body>
</html>

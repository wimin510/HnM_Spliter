<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .user-id-display {
            word-break: break-all;
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-6 text-center">
            ç„¡è³´å¸³æœ¬ (HnM Splitter)
        </h1>
        
        <!-- é¡¯ç¤ºç”¨æˆ¶ ID å’Œé€£ç·šç‹€æ…‹ -->
        <div id="status-card" class="card bg-white p-4 rounded-xl mb-6 border-l-4 border-indigo-500">
            <p class="text-sm font-semibold text-gray-700">é€£ç·šç‹€æ…‹: <span id="auth-status" class="text-yellow-600">é€£ç·šä¸­...</span></p>
            <p class="text-sm font-semibold text-gray-700 mt-1 user-id-display">ç”¨æˆ¶ID: <span id="current-user-id" class="text-gray-500 font-mono text-xs">ç­‰å¾…é©—è­‰...</span></p>
            <p class="text-xs text-indigo-500 mt-2">æ­¤IDç”¨æ–¼å…±äº«è³‡æ–™ï¼Œè«‹è¨˜ä½æˆ–å‘ŠçŸ¥æ‚¨çš„å¤¥ä¼´ã€‚</p>
        </div>

        <!-- æ–°å¢è²»ç”¨è¡¨å–® -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢ä¸€ç­†è²»ç”¨</h2>
            <form id="expense-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="description" placeholder="è²»ç”¨èªªæ˜ (ä¾‹å¦‚: æ™šé¤å¤–é€)" required
                       class="col-span-1 md:col-span-3 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <input type="number" id="amount" placeholder="é‡‘é¡ (TWD)" required min="0.01" step="0.01"
                       class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <select id="paid-by" required
                        class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="" disabled selected>èª°æ”¯ä»˜çš„ï¼Ÿ</option>
                    <option value="user">æˆ‘ (ç•¶å‰ç”¨æˆ¶)</option>
                    <option value="partner">å¤¥ä¼´</option>
                </select>

                <select id="split-type" required
                        class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="equal">å‡æ”¤</option>
                    <option value="user_pays">æˆ‘è² æ“”</option>
                    <option value="partner_pays">å¤¥ä¼´è² æ“”</option>
                </select>
                
                <button type="submit" id="submit-button"
                        class="col-span-1 md:col-span-3 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold shadow-md disabled:bg-indigo-300">
                    æ–°å¢è²»ç”¨
                </button>
            </form>
        </div>

        <!-- è²»ç”¨åˆ—è¡¨èˆ‡ç¸½çµ -->
        <div class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">è²»ç”¨æ˜ç´°èˆ‡çµç®—</h2>

            <!-- ç¸½çµå€å¡Š -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm font-medium text-indigo-600">ç¸½æ”¯å‡º</p>
                    <p id="total-spent" class="text-2xl font-bold text-indigo-800 mt-1">0.00 TWD</p>
                </div>
                <div id="settlement-summary" class="p-4 rounded-lg text-center transition-colors">
                    <p class="text-sm font-medium text-gray-600" id="settlement-label">çµç®—çµæœ</p>
                    <p id="settlement-amount" class="text-2xl font-bold mt-1 text-gray-800">0.00 TWD</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èªªæ˜</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¯ä»˜è€…</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æˆ‘è² æ“”</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤¥ä¼´è² æ“”</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list" class="bg-white divide-y divide-gray-200">
                        <!-- è²»ç”¨è³‡æ–™å°‡æœƒè¢« JavaScript æ¸²æŸ“åœ¨é€™è£¡ -->
                        <tr>
                            <td colspan="6" class="p-4 text-center text-gray-500 italic" id="loading-message">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- éŒ¯èª¤/æˆåŠŸè¨Šæ¯å½ˆçª— -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-3">è¨Šæ¯</h3>
            <p id="modal-content" class="text-gray-700 mb-4"></p>
            <button id="modal-close" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
        </div>
    </div>

    <!-- Main Application Logic (All in one module script) -->
    <script type="module">
        // åŒ¯å…¥ Firebase æ¨¡çµ„
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================================
        // ğŸ“Œ [å¤–éƒ¨é€£ç·šé…ç½®]ï¼šé€™æ˜¯æ‚¨æä¾›çš„ hnm-splitter å°ˆæ¡ˆé…ç½®ã€‚
        // ğŸš¨ è­¦ç¤º: é€™æ˜¯ä¸€å€‹å…¬é–‹çš„é…ç½®ï¼Œè«‹ç¢ºä¿æ‚¨çš„ Firestore å®‰å…¨è¦å‰‡å·²è¨­å®šï¼Œ
        // åƒ…å…è¨±å·²é©—è­‰çš„ä½¿ç”¨è€…è®€å¯«è³‡æ–™ï¼Œå› ç‚ºå¤–éƒ¨ç’°å¢ƒä¸€å¾‹ä½¿ç”¨åŒ¿åç™»å…¥ (signInAnonymously)
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCRHx0I02nojkn5-y5HXS3P3i1jA5SEy8E",
            authDomain: "hnm-splitter.firebaseapp.com", 
            projectId: "hnm-splitter", 
            storageBucket: "hnm-splitter.appspot.com",
            messagingSenderId: "514297368344",
            appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d"
            // measurementId: "G-4DY12810X8" (åˆ†æ IDï¼Œåœ¨æ­¤æ‡‰ç”¨ç¨‹å¼ä¸­ä¸éœ€è¦)
        };
        // =========================================================================================

        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let auth = null;
        let userId = 'loading';
        let authReady = false;
        let isCanvasEnvironment = false; // æ——æ¨™ï¼Œåˆ¤æ–·æ˜¯å¦ç‚º Canvas ç’°å¢ƒ

        // å…¨åŸŸ helper å‡½å¼ï¼šé¡¯ç¤ºè‡ªè¨‚è¨Šæ¯è¦–çª— (å–ä»£ alert/confirm)
        function showMessage(title, content) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            modal.classList.remove('hidden');

            document.getElementById('modal-close').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // å‡½å¼ï¼šè¨ˆç®—ä¸¦æ›´æ–°çµç®—ç¸½çµ
        function updateSettlement(expenses) {
            let userPaidTotal = 0;
            let partnerPaidTotal = 0;
            let userOwed = 0;
            let partnerOwed = 0;

            expenses.forEach(exp => {
                if (exp.paidBy === 'user') {
                    userPaidTotal += exp.amount;
                } else if (exp.paidBy === 'partner') {
                    partnerPaidTotal += exp.amount;
                }

                if (exp.splitType === 'equal') {
                    const half = exp.amount / 2;
                    userOwed += half;
                    partnerOwed += half;
                } else if (exp.splitType === 'user_pays') {
                    userOwed += exp.amount;
                } else if (exp.splitType === 'partner_pays') {
                    partnerOwed += exp.amount;
                }
            });

            const totalSpent = userPaidTotal + partnerPaidTotal;
            document.getElementById('total-spent').textContent = `${totalSpent.toFixed(2)} TWD`;

            // è¨ˆç®—æ·¨é¤˜é¡ï¼š (æˆ‘æ”¯ä»˜çš„) - (æˆ‘æ‡‰è² æ“”çš„)
            const netBalance = userPaidTotal - userOwed; // æ­£å€¼ï¼šæˆ‘å¤šä»˜äº† (å¤¥ä¼´æ¬ æˆ‘)ï¼›è² å€¼ï¼šæˆ‘å°‘ä»˜äº† (æˆ‘æ¬ å¤¥ä¼´)

            const summaryEl = document.getElementById('settlement-summary');
            const labelEl = document.getElementById('settlement-label');
            const amountEl = document.getElementById('settlement-amount');

            // ç§»é™¤èˆŠçš„é¡è‰²é¡åˆ¥
            summaryEl.className = summaryEl.className.replace(/bg-\w+-100|border-\w+-600|bg-gray-100/g, '').trim();
            amountEl.classList.remove('text-green-800', 'text-red-800', 'text-gray-800');
            amountEl.classList.add('text-2xl', 'font-bold', 'mt-1'); // ç¢ºä¿åŸºç¤æ¨£å¼å­˜åœ¨

            if (netBalance > 0.01) {
                labelEl.textContent = 'å¤¥ä¼´æ‡‰ä»˜æˆ‘ (å¤šä»˜äº†)';
                amountEl.textContent = `${Math.abs(netBalance).toFixed(2)} TWD`;
                summaryEl.classList.add('bg-green-100', 'border-l-4', 'border-green-600');
                amountEl.classList.add('text-green-800');
            } else if (netBalance < -0.01) {
                labelEl.textContent = 'æˆ‘æ‡‰ä»˜å¤¥ä¼´ (å°‘ä»˜äº†)';
                amountEl.textContent = `${Math.abs(netBalance).toFixed(2)} TWD`;
                summaryEl.classList.add('bg-red-100', 'border-l-4', 'border-red-600');
                amountEl.classList.add('text-red-800');
            } else {
                labelEl.textContent = 'çµç®—çµæœ';
                amountEl.textContent = 'å·²çµæ¸… (0.00 TWD)';
                summaryEl.classList.add('bg-gray-100', 'border-l-4', 'border-gray-300'); // ä¿æŒæ¨£å¼ä¸€è‡´
                amountEl.classList.add('text-gray-800');
            }
        }

        // å‡½å¼ï¼šåˆªé™¤è²»ç”¨
        async function deleteExpense(docId) {
            if (!authReady || !db) {
                showMessage("éŒ¯èª¤", "è³‡æ–™åº«é€£ç·šé›¢ç·šæˆ–å°šæœªæº–å‚™å¥½ã€‚");
                return;
            }
            try {
                // æ ¹æ“šç’°å¢ƒåˆ‡æ› collection path
                const appId = isCanvasEnvironment ? __app_id : EXTERNAL_FIREBASE_CONFIG.projectId;
                const docRef = doc(db, 
                    `artifacts/${appId}/public/data/expenses`, docId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("åˆªé™¤è²»ç”¨å¤±æ•—: ", error);
                showMessage("éŒ¯èª¤", "åˆªé™¤è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚");
            }
        }


        // å‡½å¼ï¼šæ¸²æŸ“è²»ç”¨åˆ—è¡¨
        function renderExpenseList(expenses) {
            const listEl = document.getElementById('expense-list');
            listEl.innerHTML = '';

            if (expenses.length === 0) {
                listEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">ç›®å‰æ²’æœ‰è²»ç”¨è¨˜éŒ„ã€‚</td></tr>`;
                return;
            }

            expenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                let userSplit = 0;
                let partnerSplit = 0;

                if (exp.splitType === 'equal') {
                    userSplit = exp.amount / 2;
                    partnerSplit = exp.amount / 2;
                } else if (exp.splitType === 'user_pays') {
                    userSplit = exp.amount;
                } else if (exp.splitType === 'partner_pays') {
                    partnerSplit = exp.amount;
                }
                
                tr.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${exp.description}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${exp.amount.toFixed(2)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                        ${exp.paidBy === 'user' ? 'æˆ‘' : 'å¤¥ä¼´'}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-700">
                        ${userSplit.toFixed(2)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-700">
                        ${partnerSplit.toFixed(2)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 transition duration-150 delete-btn" 
                                data-id="${exp.id}">
                            åˆªé™¤
                        </button>
                    </td>
                `;
                listEl.appendChild(tr);
            });

            listEl.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    deleteExpense(docId);
                });
            });
        }

        // å‡½å¼ï¼šè¨‚é–±ä¸¦å³æ™‚è¼‰å…¥è³‡æ–™
        function loadData() {
            if (!authReady || userId === 'loading' || !db) {
                document.getElementById('loading-message').textContent = 'ç­‰å¾…èº«ä»½é©—è­‰å®Œæˆ...';
                return;
            }

            document.getElementById('loading-message').classList.add('hidden');
            const authStatusEl = document.getElementById('auth-status');
            authStatusEl.textContent = 'é€£ç·šæˆåŠŸ (å³æ™‚)';
            authStatusEl.classList.remove('text-yellow-600', 'text-red-600', 'text-orange-500', 'text-indigo-600');
            authStatusEl.classList.add('text-green-600');
            
            // æ ¹æ“šç’°å¢ƒè¨­å®š Collection Path
            const appId = isCanvasEnvironment ? __app_id : EXTERNAL_FIREBASE_CONFIG.projectId;
            const collectionPath = `artifacts/${appId}/public/data/expenses`;
            
            const unsubscribe = onSnapshot(
                collection(db, collectionPath),
                (snapshot) => {
                    const expenses = [];
                    snapshot.forEach(doc => {
                        expenses.push({ id: doc.id, ...doc.data() });
                    });
                    
                    expenses.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); 
                    
                    renderExpenseList(expenses);
                    updateSettlement(expenses);
                },
                (error) => {
                    console.error("Firestore å³æ™‚ç›£è½å¤±æ•— (éŒ¯èª¤å¯èƒ½ä¾†è‡ªæ¬Šé™): ", error);
                    authStatusEl.textContent = 'é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥æ§åˆ¶å°)';
                    authStatusEl.classList.remove('text-green-600');
                    authStatusEl.classList.add('text-red-600');
                    showMessage("é€£ç·šéŒ¯èª¤", "è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å° (Console) äº†è§£è©³ç´°éŒ¯èª¤ã€‚");
                }
            );

            return unsubscribe;
        }

        // å‡½å¼ï¼šæ–°å¢è²»ç”¨
        async function addExpense(e) {
            e.preventDefault();

            if (!authReady || !db) {
                showMessage("éŒ¯èª¤", "è³‡æ–™åº«é€£ç·šé›¢ç·šæˆ–å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
                return;
            }

            const form = e.target;
            const description = form.description.value.trim();
            const amount = parseFloat(form.amount.value);
            const paidBy = form['paid-by'].value;
            const splitType = form['split-type'].value;

            if (description === "" || isNaN(amount) || amount <= 0 || paidBy === "") {
                showMessage("è¼¸å…¥éŒ¯èª¤", "è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ã€‚");
                return;
            }

            const newExpense = {
                description,
                amount,
                paidBy,
                splitType,
                createdAt: Date.now(),
                createdBy: userId, 
            };

            try {
                // æ ¹æ“šç’°å¢ƒè¨­å®š Collection Path
                const appId = isCanvasEnvironment ? __app_id : EXTERNAL_FIREBASE_CONFIG.projectId;
                const collectionPath = `artifacts/${appId}/public/data/expenses`;
                await addDoc(collection(db, collectionPath), newExpense);

                form.reset();
                form['paid-by'].value = "";
            } catch (error) {
                console.error("æ–°å¢è²»ç”¨å¤±æ•—: ", error);
                showMessage("éŒ¯èª¤", "æ–°å¢è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚");
            }
        }

        // å‡½å¼ï¼šæª¢æŸ¥å¤–éƒ¨é…ç½®æ˜¯å¦å·²å¡«å¯«
        function isExternalConfigValid() {
            // æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦å·²å¾é ç•™å­—ä¸²æ›¿æ›ç‚ºå¯¦éš›å€¼
            return EXTERNAL_FIREBASE_CONFIG.apiKey.length > 10 &&
                   EXTERNAL_FIREBASE_CONFIG.appId.length > 10;
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼çš„ä¸»å‡½å¼
        function initApp() {
            const authStatusEl = document.getElementById('auth-status');
            const currentUserIdEl = document.getElementById('current-user-id');
            const submitButton = document.getElementById('submit-button');
            const loadingMessageEl = document.getElementById('loading-message');
            
            // æª¢æŸ¥ Canvas ç’°å¢ƒè®Šæ•¸æ˜¯å¦å­˜åœ¨
            const hasCanvasEnvironment = typeof window.__firebase_config !== 'undefined' && typeof window.__app_id !== 'undefined';
            isCanvasEnvironment = hasCanvasEnvironment; // è¨­å®šç’°å¢ƒæ——æ¨™

            let configToUse;
            let initialAuthToken = null;
            let displayMode = '';
            
            if (isCanvasEnvironment) {
                // æ¨¡å¼ 1: Canvas ç’°å¢ƒ
                try {
                    configToUse = JSON.parse(__firebase_config);
                    initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    displayMode = 'Canvas ç’°å¢ƒ (å®‰å…¨èªè­‰)';
                    authStatusEl.classList.add('text-yellow-600');
                } catch (e) {
                    // å¦‚æœè§£æå¤±æ•—ï¼Œå‰‡è¦–ç‚ºå¤–éƒ¨ç’°å¢ƒ
                    isCanvasEnvironment = false; 
                    console.error("è§£æ Canvas é…ç½®å¤±æ•—:", e);
                }
            }
            
            if (!isCanvasEnvironment) {
                // æ¨¡å¼ 2: å¤–éƒ¨ç’°å¢ƒ (ä¾‹å¦‚ GitHub Pages)
                if (!isExternalConfigValid()) {
                    // å¦‚æœé…ç½®ä»æ˜¯é ç•™ä½ç½®ï¼Œå‰‡é€²å…¥é›¢ç·šæ¨¡å¼
                    authStatusEl.textContent = 'å¤–éƒ¨æ¨¡å¼ (Firestore é›¢ç·š)';
                    authStatusEl.classList.remove('text-yellow-600', 'text-indigo-600');
                    authStatusEl.classList.add('text-orange-500');
                    currentUserIdEl.textContent = 'N/A (è«‹åœ¨ Canvas ä¸­é è¦½æˆ–æª¢æŸ¥å¤–éƒ¨é…ç½®)';
                    loadingMessageEl.textContent = 'è³‡æ–™åº«åŠŸèƒ½å·²ç¦ç”¨ï¼Œè«‹æª¢æŸ¥å¤–éƒ¨é…ç½®æ˜¯å¦å®Œæ•´å¡«å¯«ã€‚';
                    submitButton.disabled = true;
                    submitButton.textContent = 'æ–°å¢è²»ç”¨ (é›¢ç·š)';
                    
                    // é¡¯ç¤ºè­¦å‘Š modal
                    setTimeout(() => {
                        if (document.getElementById('message-modal').classList.contains('hidden')) {
                            showMessage(
                                "é€£ç·šè­¦å‘Š - å¤–éƒ¨ç’°å¢ƒ",
                                "æ‚¨æ­£åœ¨ Canvas å¤–éƒ¨åŸ·è¡Œã€‚è«‹ç¢ºèªç¨‹å¼ç¢¼é ‚éƒ¨ **EXTERNAL_FIREBASE_CONFIG** å·²å¡«å¯«æ­£ç¢ºçš„ API Key å’Œ App IDã€‚"
                            );
                        }
                    }, 500);
                    return;
                } else {
                    // å¦‚æœé…ç½®å·²å¡«å¯«ï¼Œä½¿ç”¨å¤–éƒ¨é…ç½®
                    configToUse = EXTERNAL_FIREBASE_CONFIG;
                    displayMode = 'å¤–éƒ¨ç’°å¢ƒ (åŒ¿åé€£ç·š)';
                    authStatusEl.classList.add('text-indigo-600');
                    authStatusEl.classList.remove('text-yellow-600');
                }
            }


            // é–‹å§‹åˆå§‹åŒ– Firebase
            try {
                setLogLevel('debug'); 
                const app = initializeApp(configToUse);
                auth = getAuth(app);
                db = getFirestore(app);
                
                authStatusEl.textContent = displayMode;


                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authReady = true;
                        currentUserIdEl.textContent = userId;
                        loadData(); // ç™»å…¥æˆåŠŸå¾Œæ‰é–‹å§‹è¼‰å…¥è³‡æ–™

                    } else {
                        // è™•ç†ç™»å…¥é‚è¼¯ (æ ¹æ“šç’°å¢ƒæ±ºå®š)
                        if (isCanvasEnvironment && initialAuthToken) {
                            // Canvas: å˜—è©¦ä½¿ç”¨ Custom Token ç™»å…¥
                            signInWithCustomToken(auth, initialAuthToken)
                                .catch(error => {
                                    console.error("Custom Token ç™»å…¥å¤±æ•—, è½‰ç‚ºåŒ¿åç™»å…¥:", error);
                                    signInAnonymously(auth).catch(anonError => {
                                        console.error("åŒ¿åç™»å…¥ä¹Ÿå¤±æ•—:", anonError);
                                        authStatusEl.textContent = 'é€£ç·šå¤±æ•— (ç™»å…¥)';
                                        authStatusEl.classList.add('text-red-600');
                                    });
                                });
                        } else {
                            // å¤–éƒ¨ç’°å¢ƒ (æˆ– Canvas ä½†æ²’æœ‰ Token): åŒ¿åç™»å…¥
                             signInAnonymously(auth).catch(error => {
                                console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                                authStatusEl.textContent = 'é€£ç·šå¤±æ•— (åŒ¿åç™»å…¥)';
                                authStatusEl.classList.add('text-red-600');
                            });
                        }
                    }
                });

                document.getElementById('expense-form').addEventListener('submit', addExpense);

            } catch (error) {
                console.error("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:", error);
                authStatusEl.textContent = 'åˆå§‹åŒ–éŒ¯èª¤';
                authStatusEl.classList.remove('text-yellow-600', 'text-indigo-600');
                authStatusEl.classList.add('text-red-600');
                showMessage("åš´é‡éŒ¯èª¤", "æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯ã€‚");
            }
        }

        window.onload = initApp;

    </script>

</body>
</html>

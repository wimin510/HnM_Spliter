<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 匿名登入與狀態顯示</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'success': '#10b981',
                        'danger': '#ef4444',
                        'warning': '#f59e0b',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800 border-b pb-3">
            Firebase 匿名登入狀態
        </h1>

        <!-- 連線狀態卡片 -->
        <div id="status-card" class="p-4 rounded-xl shadow-lg transition-all duration-300 bg-gray-100 border border-gray-200">
            <h2 class="text-lg font-semibold mb-2 text-gray-700">連線/登入狀態</h2>
            <div class="flex items-center space-x-3">
                <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-400 animate-pulse"></div>
                <p id="connection-status" class="text-gray-600 font-medium">初始化中...</p>
            </div>
            
            <p id="user-id-display" class="text-sm font-mono text-gray-500 mt-3 break-all">
                使用者 ID: 尚未登入
            </p>
        </div>

        <!-- 功能區塊 (模擬應用程式內容) -->
        <div class="p-4 border-t border-gray-200 pt-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">應用程式內容 (匿名可用)</h2>
            <p class="text-gray-600">
                您已成功建立一個可以跨裝置使用的應用程式基底。匿名登入讓每個使用者擁有獨立的 ID 來儲存資料。
            </p>
        </div>
    </div>

    <!-- 模組化錯誤提示框 (用於取代 alert()) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-full m-4">
            <h3 class="text-xl font-bold text-danger mb-3">錯誤通知</h3>
            <p id="modal-message" class="text-gray-700 text-sm"></p>
            <div class="mt-4 text-right">
                <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition">
                    確定
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        // 導入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- 替換為您自己的 Firebase 配置資訊 ---
        // 注意：為了在 GitHub Pages 上運行，您必須在這裡手動填寫您的配置
        const firebaseConfig = {
            // 已替換為您提供的配置
            apiKey: "AIzaSyCRHx0i02nojkN5-y5HxS3P3i1jA5SEy8E", 
            authDomain: "hnm-spliter.firebaseapp.com",
            projectId: "hnm-spliter",
            storageBucket: "hnm-spliter.firebasestorage.app",
            messagingSenderId: "514297368344",
            appId: "1:514297368344:web:a9ee0cb370cddc1b6e986d",
            measurementId: "G-4DY12810X8"
        };
        // ------------------------------------

        // --- DOM 元素 ---
        const connectionStatusElement = document.getElementById('connection-status');
        const statusIndicator = document.getElementById('status-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const statusCard = document.getElementById('status-card');

        // --- 輔助函式 ---

        // 顯示模組化提示框
        const showModal = (message) => {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        };

        // 更新連線狀態顯示
        const setConnectionStatus = (status, message = '', userId = null) => {
            let bgColorClass = 'bg-gray-400';
            let textColorClass = 'text-gray-600';
            let statusText = message || '未知狀態';
            
            // 重置樣式
            statusIndicator.classList.remove('bg-gray-400', 'bg-success', 'bg-danger', 'bg-warning', 'animate-pulse');
            statusCard.classList.remove('bg-gray-100', 'bg-green-50', 'bg-red-50', 'border-gray-200', 'border-success', 'border-danger');

            switch (status) {
                case 'connecting':
                    statusText = '連線中...';
                    bgColorClass = 'bg-warning';
                    textColorClass = 'text-warning';
                    statusIndicator.classList.add('animate-pulse');
                    statusCard.classList.add('bg-gray-100', 'border-warning');
                    break;
                case 'connected':
                    statusText = '已成功登入 (匿名)';
                    bgColorClass = 'bg-success';
                    textColorClass = 'text-success';
                    statusCard.classList.add('bg-green-50', 'border-success');
                    break;
                case 'error':
                    statusText = message || '連線或登入失敗';
                    bgColorClass = 'bg-danger';
                    textColorClass = 'text-danger';
                    statusCard.classList.add('bg-red-50', 'border-danger');
                    break;
                default:
                    statusText = '初始化中...';
            }

            // 更新 UI
            statusIndicator.classList.add(bgColorClass);
            connectionStatusElement.textContent = statusText;
            connectionStatusElement.classList.remove('text-gray-600', 'text-success', 'text-danger', 'text-warning');
            connectionStatusElement.classList.add(textColorClass);
            
            if (userId) {
                userIdDisplay.innerHTML = `使用者 ID: <span class="font-bold text-gray-700">${userId}</span>`;
            } else {
                userIdDisplay.textContent = '使用者 ID: 尚未登入';
            }
        };


        // --- 主要初始化邏輯 ---
        
        const initFirebase = async () => {
            // 檢查配置是否完整 (這裡僅檢查 API Key, 實際應用中應檢查所有必要字段)
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                const msg = '錯誤：請將程式碼中的 "firebaseConfig" 替換為您自己的 Firebase 專案配置資訊。';
                console.error(msg);
                setConnectionStatus('error', '配置錯誤 (YOUR_API_KEY 未替換)');
                showModal(msg);
                return;
            }

            try {
                // 1. 初始化 Firebase 應用程式
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                setConnectionStatus('connecting'); 

                // 2. 設置身份驗證狀態監聽器
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // 登入成功
                        setConnectionStatus('connected', `已成功登入 (匿名)`, user.uid);
                        console.log("Firebase 匿名登入成功. User ID:", user.uid);
                    } else {
                        // 登出或初始狀態
                        // 如果是第一次載入，嘗試登入
                        if (auth.currentUser === null) {
                             attemptAnonymousSignIn(auth);
                        } else {
                            // 登出狀態
                            setConnectionStatus('error', '已登出或會話過期');
                            console.warn("Firebase 登出或會話過期.");
                        }
                    }
                });

            } catch (error) {
                // 初始化失敗
                const msg = `Firebase 初始化失敗: ${error.message}`;
                console.error(msg, error);
                setConnectionStatus('error', '初始化錯誤');
                showModal(msg);
            }
        };

        // 嘗試匿名登入
        const attemptAnonymousSignIn = async (auth) => {
            setConnectionStatus('connecting', '嘗試匿名登入...');
            try {
                // 執行匿名登入
                await signInAnonymously(auth);
                // onAuthStateChanged 會捕捉成功狀態，無需在此處再次呼叫 setConnectionStatus('connected')
            } catch (error) {
                // 匿名登入失敗
                const msg = `匿名登入失敗！請確認 Firebase 專案中已啟用 "匿名" 登入方式。錯誤代碼: ${error.code}`;
                console.error(msg, error);
                setConnectionStatus('error', '匿名登入失敗');
                showModal(msg);
            }
        };

        // 啟動應用程式
        window.onload = initFirebase;
        
    </script>
</body>
</html>

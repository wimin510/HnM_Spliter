<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡è³´å¸³æœ¬ (HnM Spliter)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div id="app" class="max-w-xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">ç„¡è³´å¸³æœ¬ ğŸ“</h1>
        <p class="text-center text-sm text-gray-500 font-mono" id="user-info"></p>
        
        <!-- æ¬ æ¬¾ç‹€æ…‹é¡¯ç¤º -->
        <div id="balance-card" class="p-6 rounded-xl shadow-lg transition-all duration-300">
            <h2 class="text-lg font-semibold mb-2 text-white" id="balance-status-text">è¼‰å…¥ä¸­...</h2>
            <p class="text-4xl font-extrabold text-white" id="balance-amount">--</p>
        </div>

        <!-- åç¨±è¨­å®šå€å¡Š -->
        <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
            <button id="toggle-settings" class="w-full flex justify-between items-center text-left text-lg font-semibold text-gray-800 focus:outline-none py-1">
                <span>åç¨±è¨­å®š</span>
                <svg id="settings-chevron" class="w-5 h-5 transition-transform duration-300 transform" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="settings-content" class="mt-4 space-y-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="h-name-input" class="block text-sm font-medium text-gray-700">æˆ‘çš„åç¨± (H)</label>
                        <input type="text" id="h-name-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., John">
                    </div>
                    <div>
                        <label for="m-name-input" class="block text-sm font-medium text-gray-700">å¤¥ä¼´åç¨± (M)</label>
                        <input type="text" id="m-name-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., Mary">
                    </div>
                </div>
                <button id="save-names-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-secondary hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out">
                    å„²å­˜åç¨±è¨­å®š
                </button>
            </div>
        </div>
        
        <!-- è¨˜éŒ„è¡¨å–® -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æ–°å¢ç´€éŒ„</h2>
            <form id="expense-form" class="space-y-4">
                
                <!-- å¹£åˆ¥é¸æ“‡ -->
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700">å¹£åˆ¥</label>
                    <select id="currency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="TWD">æ–°å°å¹£ (TWD)</option>
                        <option value="JPY">æ—¥å¹£ (JPY)</option>
                        <option value="USD">ç¾å…ƒ (USD)</option>
                    </select>
                </div>

                <!-- ç¸½é‡‘é¡ & æ—¥æœŸ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="totalAmount" class="block text-sm font-medium text-gray-700">ç¸½é‡‘é¡</label>
                        <input type="number" id="totalAmount" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                    <div>
                        <label for="recordDate" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                </div>

                <!-- ä»˜æ¬¾äºº -->
                <div>
                    <label for="payer" class="block text-sm font-medium text-gray-700">ä»˜æ¬¾äºº</label>
                    <select id="payer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="H">æˆ‘ (Me)</option>
                        <option value="M">å¤¥ä¼´ (Partner)</option>
                    </select>
                </div>

                <!-- æè¿° -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">æè¿° (e.g., æ™šé¤)</label>
                    <input type="text" id="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="e.g., æ™šé¤">
                </div>

                <!-- åˆ†å¸³æ–¹å¼ -->
                <div>
                    <label for="splitType" class="block text-sm font-medium text-gray-700">åˆ†å¸³æ–¹å¼</label>
                    <select id="splitType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="equal">å‡åˆ† (Equal)</option>
                        <option value="custom">è‡ªè¨‚é‡‘é¡ (Custom)</option>
                    </select>
                </div>

                <!-- è‡ªè¨‚é‡‘é¡åˆ†é… (Custom Split) -->
                <div id="custom-split-fields" class="grid grid-cols-2 gap-4 hidden">
                    <div>
                        <label for="amountH" class="block text-sm font-medium text-gray-700">æˆ‘ (Me) æ‡‰ä»˜é‡‘é¡</label>
                        <input type="number" id="amountH" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                    <div>
                        <label for="amountM" class="block text-sm font-medium text-gray-700">å¤¥ä¼´ (Partner) æ‡‰ä»˜é‡‘é¡</label>
                        <input type="number" id="amountM" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2" placeholder="0">
                    </div>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    å„²å­˜ç´€éŒ„
                </button>
            </form>
            <div id="error-message" class="text-danger text-sm mt-3 hidden p-2 bg-red-50 rounded-md"></div>
        </div>

        <!-- æœ€è¿‘äº”ç­†ç´€éŒ„ -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">æœ€è¿‘äº”ç­†ç´€éŒ„</h2>
            <ul id="recent-records" class="space-y-3">
                <li class="text-gray-500 text-center py-4" id="loading-records">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
    </div>

    <!-- æ¨¡çµ„åŒ–éŒ¯èª¤æç¤ºæ¡† -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900">éŒ¯èª¤æˆ–æç¤º</h3>
            <div class="mt-2">
                <p id="modal-message" class="text-sm text-gray-500"></p>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="px-4 py-2 bg-primary text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            limit,
            orderBy,
            serverTimestamp,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- å…¨åŸŸè®Šæ•¸è¨­å®šèˆ‡ Firebase åˆå§‹åŒ– ---
        const USER_PARTY = 'H'; // å‡è¨­ç•¶å‰ä½¿ç”¨è€…æ˜¯ H
        const PARTNER_PARTY = 'M';
        let PARTY_NAMES = {
            'H': 'æˆ‘ (Me)', // é è¨­åç¨±
            'M': 'å¤¥ä¼´ (Partner)', // é è¨­åç¨±
        };

        let app, db, auth, userId = null;
        let isAuthReady = false;

        const totalAmountInput = document.getElementById('totalAmount');
        const amountHInput = document.getElementById('amountH');
        const amountMInput = document.getElementById('amountM');
        const splitTypeSelect = document.getElementById('splitType');
        const customSplitFields = document.getElementById('custom-split-fields');
        const expenseForm = document.getElementById('expense-form');
        const recentRecordsList = document.getElementById('recent-records');
        const balanceCard = document.getElementById('balance-card');
        const balanceStatusText = document.getElementById('balance-status-text');
        const balanceAmountElement = document.getElementById('balance-amount');
        const userInfoElement = document.getElementById('user-info');
        const errorMessageElement = document.getElementById('error-message');
        
        // åç¨±è¨­å®š DOM
        const hNameInput = document.getElementById('h-name-input');
        const mNameInput = document.getElementById('m-name-input');
        const saveNamesBtn = document.getElementById('save-names-btn');
        const toggleSettingsBtn = document.getElementById('toggle-settings');
        const settingsContent = document.getElementById('settings-content');
        const settingsChevron = document.getElementById('settings-chevron');
        const payerSelect = document.getElementById('payer');
        
        // è¨­ç½®é è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();


        // é¡¯ç¤ºæ¨¡çµ„åŒ–æç¤ºæ¡†
        const showModal = (message) => {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        };

        // è™•ç† Firebase éŒ¯èª¤
        const handleFirebaseError = (error, action = 'æ“ä½œ') => {
            console.error(`Firebase éŒ¯èª¤ [${action}]:`, error);
            const msg = `[${action}å¤±æ•—] è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚`;
            showModal(msg);
        };

        // åˆå§‹åŒ– Firebase
        try {
            // å¾å…¨åŸŸè®Šæ•¸ç²å–é…ç½®
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'hnm-spliter-default';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error('Firebase é…ç½®ç¼ºå¤±ï¼ç„¡æ³•åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ã€‚');
                showModal('æ‡‰ç”¨ç¨‹å¼é…ç½®ç¼ºå¤±ï¼Œç„¡æ³•é€£æ¥è‡³è³‡æ–™åº«ã€‚');
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoElement.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // èº«ä»½é©—è­‰å®Œæˆå¾Œï¼Œå•Ÿå‹•è³‡æ–™ç›£è½
                        setupDataListeners();
                    } else {
                        // å¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œå˜—è©¦ä½¿ç”¨è‡ªå®šç¾© token æˆ–åŒ¿åç™»å…¥
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        
                        if (customToken) {
                            signInWithCustomToken(auth, customToken).catch(err => {
                                handleFirebaseError(err, 'è‡ªå®šç¾©ç™»å…¥');
                                signInAnonymously(auth).catch(err => handleFirebaseError(err, 'åŒ¿åç™»å…¥'));
                            });
                        } else {
                            signInAnonymously(auth).catch(err => handleFirebaseError(err, 'åŒ¿åç™»å…¥'));
                        }
                    }
                });
            }

        } catch (error) {
            handleFirebaseError(error, 'åˆå§‹åŒ–');
        }

        // --- è³‡æ–™åº«è·¯å¾‘ ---
        const getExpensesCollectionRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'hnm-spliter-default';
            return collection(db, `artifacts/${appId}/public/data/expenses`);
        };

        const getBalanceDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'hnm-spliter-default';
            return doc(db, `artifacts/${appId}/public/data/balances/hnm-balance`);
        };
        
        // æ–°å¢ï¼šè¨­å®šæ–‡ä»¶è·¯å¾‘ (å„²å­˜ H/M åç¨±)
        const getSettingsDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'hnm-spliter-default';
            return doc(db, `artifacts/${appId}/public/data/settings/party-names`);
        };


        // --- è³‡æ–™åº«æ“ä½œèˆ‡ç›£è½ ---

        // è¨­ç½®å³æ™‚è³‡æ–™ç›£è½å™¨
        const setupDataListeners = () => {
            if (!isAuthReady || !db) return;

            // 1. ç›£è½åç¨±è¨­å®š
            setupNamesListener();

            // 2. ç›£è½æœ€è¿‘äº”ç­†ç´€éŒ„
            const qRecords = query(getExpensesCollectionRef(), orderBy("recordTimestamp", "desc"), limit(5));
            onSnapshot(qRecords, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                // ç´€éŒ„æ¸²æŸ“ä¾è³´æ–¼ PARTY_NAMESï¼Œç•¶åç¨±æ›´æ–°æ™‚æœƒè‡ªå‹•è§¸ç™¼é‡ç¹ª
                renderRecentRecords(records); 
            }, (error) => handleFirebaseError(error, 'ç›£è½ç´€éŒ„'));

            // 3. ç›£è½ç¸½æ¬ æ¬¾ç‹€æ…‹
            onSnapshot(getBalanceDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const balanceData = docSnapshot.data();
                    const balance = balanceData.balance || 0;
                    const currency = balanceData.currency || 'TWD';
                    // æ¬ æ¬¾æ¸²æŸ“ä¾è³´æ–¼ PARTY_NAMESï¼Œç•¶åç¨±æ›´æ–°æ™‚æœƒè‡ªå‹•è§¸ç™¼é‡ç¹ª
                    renderBalance(balance, currency);
                } else {
                    renderBalance(0, 'TWD');
                }
            }, (error) => handleFirebaseError(error, 'ç›£è½æ¬ æ¬¾'));
        };

        // ç›£è½åç¨±è¨­å®š
        const setupNamesListener = () => {
            onSnapshot(getSettingsDocRef(), (docSnapshot) => {
                let changed = false;
                if (docSnapshot.exists()) {
                    const names = docSnapshot.data();
                    if (names.HName && PARTY_NAMES['H'] !== names.HName) {
                        PARTY_NAMES['H'] = names.HName;
                        changed = true;
                    }
                    if (names.MName && PARTY_NAMES['M'] !== names.MName) {
                        PARTY_NAMES['M'] = names.MName;
                        changed = true;
                    }
                }
                // åªæœ‰åœ¨åç¨±å¯¦éš›æ”¹è®Šæ™‚æ‰æ›´æ–° UI
                if (changed) {
                    updatePartyNamesUI();
                } else {
                    // åˆå§‹åŒ–æ™‚ï¼Œå¦‚æœ Firebase æ²’æœ‰è¨­å®šï¼Œå‰‡ç”¨é è¨­å€¼å¡«å……è¼¸å…¥æ¡†
                    hNameInput.value = PARTY_NAMES['H'];
                    mNameInput.value = PARTY_NAMES['M'];
                    updatePartyNamesUI(); // ç¢ºä¿åˆå§‹æ¸²æŸ“æ­£ç¢º
                }
                
            }, (error) => console.error('ç›£è½åç¨±è¨­å®šå¤±æ•—:', error));
        };

        // --- UI æ¸²æŸ“åŠŸèƒ½ ---
        
        // æ›´æ–°æ‰€æœ‰ä½¿ç”¨ H/M åç¨±çš„ UI å…ƒç´ 
        const updatePartyNamesUI = () => {
            // 1. æ›´æ–°åç¨±è¨­å®šè¼¸å…¥æ¡† (å¦‚æœä¸æ˜¯ç•¶å‰ç·¨è¼¯ç‹€æ…‹)
            if (document.activeElement !== hNameInput) hNameInput.value = PARTY_NAMES['H'];
            if (document.activeElement !== mNameInput) mNameInput.value = PARTY_NAMES['M'];

            // 2. æ›´æ–°ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®
            if (payerSelect.options[0]) payerSelect.options[0].textContent = PARTY_NAMES['H'];
            if (payerSelect.options[1]) payerSelect.options[1].textContent = PARTY_NAMES['M'];
            
            // 3. æ›´æ–°è‡ªè¨‚é‡‘é¡çš„æ¨™ç±¤
            document.querySelector('label[for="amountH"]').textContent = `${PARTY_NAMES['H']} æ‡‰ä»˜é‡‘é¡`;
            document.querySelector('label[for="amountM"]').textContent = `${PARTY_NAMES['M']} æ‡‰ä»˜é‡‘é¡`;
        };


        // æ¸²æŸ“æ¬ æ¬¾ç‹€æ…‹
        const renderBalance = (balance, currency) => {
            const isOwed = balance > 0;
            const isDebt = balance < 0;
            const absBalance = Math.abs(balance).toFixed(2);
            const currencySymbol = getCurrencySymbol(currency);
            
            balanceCard.classList.remove('bg-secondary', 'bg-danger', 'bg-gray-400');

            if (isOwed) {
                // M æ¬  H (æˆ‘è¢«æ¬ éŒ¢)
                balanceCard.classList.add('bg-secondary'); // ç¶ è‰²ï¼šå„ªå‹¢
                balanceStatusText.textContent = `${PARTY_NAMES['M']} æ¬  ${PARTY_NAMES['H']} (æˆ‘æ–¹å„ªå‹¢)`;
            } else if (isDebt) {
                // H æ¬  M (æˆ‘æ¬ åˆ¥äººéŒ¢)
                balanceCard.classList.add('bg-danger'); // ç´…è‰²ï¼šåŠ£å‹¢
                balanceStatusText.textContent = `${PARTY_NAMES['H']} æ¬  ${PARTY_NAMES['M']} (æˆ‘æ–¹åŠ£å‹¢)`;
            } else {
                // çµæ¸…
                balanceCard.classList.add('bg-gray-400');
                balanceStatusText.textContent = `ç›®å‰å·²çµæ¸…`;
            }

            balanceAmountElement.textContent = `${currencySymbol} ${absBalance}`;
        };

        // æ¸²æŸ“æœ€è¿‘ç´€éŒ„
        const renderRecentRecords = (records) => {
            recentRecordsList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            if (records.length === 0) {
                recentRecordsList.innerHTML = '<li class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</li>';
                return;
            }

            records.forEach(record => {
                const currencySymbol = getCurrencySymbol(record.currency);
                
                // æ±ºå®šé¡¯ç¤ºçš„é‡‘é¡é¡è‰²å’Œæ ¼å¼
                let amountText = '';
                let amountClass = 'text-gray-800';
                
                if (record.splitType === 'equal') {
                    const splitAmount = (record.totalAmount / 2).toFixed(2);
                    amountText = `ç¸½é¡: ${currencySymbol} ${record.totalAmount.toFixed(2)} | å‡åˆ†: ${currencySymbol} ${splitAmount}`;
                } else {
                    const H_Paid = record.amountH || 0;
                    const M_Paid = record.amountM || 0;
                    // ä½¿ç”¨ç•¶å‰ PARTY_NAMES
                    amountText = `${PARTY_NAMES['H']}æ‡‰ä»˜: ${currencySymbol} ${H_Paid.toFixed(2)}, ${PARTY_NAMES['M']}æ‡‰ä»˜: ${currencySymbol} ${M_Paid.toFixed(2)}`;
                }

                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150';
                listItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm font-semibold">${record.description}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date(record.recordDate).toLocaleDateString()} / ä»˜æ¬¾äºº: ${PARTY_NAMES[record.payer]}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="text-sm font-medium ${amountClass}">${amountText}</p>
                        <p class="text-xs text-gray-400 mt-1">${record.splitType === 'equal' ? 'å‡åˆ†' : 'è‡ªè¨‚'}</p>
                    </div>
                `;
                recentRecordsList.appendChild(listItem);
            });
        };

        // ç²å–è²¨å¹£ç¬¦è™Ÿ
        const getCurrencySymbol = (currency) => {
            switch (currency) {
                case 'TWD': return 'NT$';
                case 'JPY': return 'Â¥';
                case 'USD': return '$';
                default: return '';
            }
        };

        // --- è¡¨å–®åŠè¨­å®šé‚è¼¯ ---

        // åç¨±è¨­å®šå„²å­˜
        saveNamesBtn.addEventListener('click', async () => {
            const HName = hNameInput.value.trim();
            const MName = mNameInput.value.trim();

            if (!HName || !MName) {
                showModal('è«‹è¼¸å…¥é›™æ–¹çš„åç¨±ã€‚');
                return;
            }
            if (!isAuthReady) {
                 showModal('è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            try {
                // ä½¿ç”¨ setDoc å„²å­˜è¨­å®š
                await setDoc(getSettingsDocRef(), {
                    HName: HName,
                    MName: MName,
                    lastUpdated: serverTimestamp(),
                }, { merge: true });
                
                // ç«‹å³æ›´æ–°å‰ç«¯çš„ PARTY_NAMES (onSnapshot æœƒåœ¨èƒŒæ™¯è™•ç†ï¼Œä½†é€™å¯ä»¥ç«‹å³åæ‡‰)
                PARTY_NAMES['H'] = HName;
                PARTY_NAMES['M'] = MName;
                updatePartyNamesUI();
                
                showModal('åç¨±å·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥ï¼');
                
                // éš±è—è¨­å®šå€å¡Š
                settingsContent.classList.add('hidden');
                settingsChevron.classList.remove('rotate-180');
                
            } catch (error) {
                handleFirebaseError(error, 'å„²å­˜åç¨±');
            }
        });

        // å±•é–‹/æ”¶åˆè¨­å®šå€å¡Š
        toggleSettingsBtn.addEventListener('click', () => {
            settingsContent.classList.toggle('hidden');
            settingsChevron.classList.toggle('rotate-180');
        });


        // å‡åˆ†/è‡ªè¨‚ åˆ‡æ›é‚è¼¯
        splitTypeSelect.addEventListener('change', () => {
            if (splitTypeSelect.value === 'custom') {
                customSplitFields.classList.remove('hidden');
                // é è¨­å°‡ç¸½é‡‘é¡è¨­å®šç‚ºHçš„æ‡‰ä»˜é‡‘é¡ï¼ŒMç‚º0 (ä½¿ç”¨è€…éœ€è¦ä¿®æ”¹)
                // è§¸ç™¼ä¸€æ¬¡è‡ªè¨‚é‡‘é¡è¨ˆç®—ï¼Œç¢ºä¿è¼¸å…¥æ¡†å€¼æ­£ç¢º
                updateCustomSplit(totalAmountInput); 
            } else {
                customSplitFields.classList.add('hidden');
                amountHInput.value = '';
                amountMInput.value = '';
            }
        });

        // è‡ªè¨‚é‡‘é¡è‡ªå‹•è¨ˆç®—é‚è¼¯
        totalAmountInput.addEventListener('input', () => updateCustomSplit(totalAmountInput));
        amountHInput.addEventListener('input', () => updateCustomSplit(amountHInput));
        amountMInput.addEventListener('input', () => updateCustomSplit(amountMInput));

        function updateCustomSplit(changedInput) {
            if (splitTypeSelect.value !== 'custom') return;

            const total = parseFloat(totalAmountInput.value) || 0;
            
            if (changedInput === amountHInput && total >= 0) {
                const amountH = parseFloat(amountHInput.value) || 0;
                const remaining = total - amountH;
                amountMInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            } else if (changedInput === amountMInput && total >= 0) {
                const amountM = parseFloat(amountMInput.value) || 0;
                const remaining = total - amountM;
                amountHInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            } else if (changedInput === totalAmountInput) {
                 // ç•¶ç¸½é‡‘é¡æ”¹è®Šï¼Œä¿æŒ H é‡‘é¡ä¸è®Šï¼ŒM é‡‘é¡è®Šå‹•
                 const amountH = parseFloat(amountHInput.value) || 0;
                 const remaining = total - amountH;
                 amountMInput.value = remaining >= 0 ? remaining.toFixed(2) : 0.00;
            }
        }
        
        // æäº¤è¡¨å–®è™•ç† (ä¸è®Š)
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageElement.classList.add('hidden');
            errorMessageElement.textContent = '';

            if (!isAuthReady) {
                showModal('è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            const totalAmount = parseFloat(totalAmountInput.value);
            const currency = document.getElementById('currency').value;
            const payer = document.getElementById('payer').value;
            const description = document.getElementById('description').value.trim();
            const splitType = splitTypeSelect.value;
            const recordDateString = document.getElementById('recordDate').value;
            const recordDate = recordDateString ? new Date(recordDateString).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];

            let amountH = 0;
            let amountM = 0;
            
            if (isNaN(totalAmount) || totalAmount <= 0 || !description) {
                errorMessageElement.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆç¸½é‡‘é¡å’Œæè¿°ã€‚';
                errorMessageElement.classList.remove('hidden');
                return;
            }

            if (splitType === 'equal') {
                amountH = totalAmount / 2;
                amountM = totalAmount / 2;
            } else {
                amountH = parseFloat(amountHInput.value) || 0;
                amountM = parseFloat(amountMInput.value) || 0;
                
                if ((amountH + amountM).toFixed(2) !== totalAmount.toFixed(2)) {
                    errorMessageElement.textContent = 'è‡ªè¨‚é‡‘é¡ç¸½å’Œèˆ‡ç¸½é‡‘é¡ä¸ç¬¦ï¼è«‹æª¢æŸ¥ã€‚';
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
            }

            // æ·¨å€Ÿè²¸å®šç¾©ï¼šM æ‡‰ä»˜çµ¦ H çš„é‡‘é¡ (æ­£æ•¸ç‚º M æ¬  H, è² æ•¸ç‚º H æ¬  M)
            let netDebtChange = 0;

            if (payer === 'H') {
                // H ä»˜æ¬¾ TotalAmountã€‚H æ‡‰ä»˜ amountH, M æ‡‰ä»˜ amountMã€‚
                // H å¢Šä»˜äº† M çš„ amountM
                netDebtChange = amountM; 
            } else { // payer === 'M'
                // M ä»˜æ¬¾ TotalAmountã€‚H æ‡‰ä»˜ amountH, M æ‡‰ä»˜ amountMã€‚
                // M å¢Šä»˜äº† H çš„ amountH
                netDebtChange = -amountH; 
            }

            const newExpense = {
                totalAmount: totalAmount,
                currency: currency,
                payer: payer, // H æˆ– M
                description: description,
                splitType: splitType,
                amountH: amountH, // H æ‡‰ä»˜é‡‘é¡
                amountM: amountM, // M æ‡‰ä»˜é‡‘é¡
                netDebtChange: netDebtChange, // å°ç¸½å¹³è¡¡çš„å½±éŸ¿ (M æ¬  H çš„é‡‘é¡è®ŠåŒ–)
                recordDate: recordDate, // YYYY-MM-DD string
                recordTimestamp: serverTimestamp(), // ç”¨æ–¼æ’åº
                recordedBy: userId,
            };

            try {
                // 1. å¯«å…¥æ–°ç´€éŒ„
                await addDoc(getExpensesCollectionRef(), newExpense);
                
                // 2. æ›´æ–°ç¸½æ¬ æ¬¾ (åŸå­æ“ä½œ)
                const balanceDocRef = getBalanceDocRef();
                const balanceSnapshot = await getDocs(query(collection(db, `artifacts/${appId}/public/data/balances`)));
                let currentBalance = 0;

                if (!balanceSnapshot.empty) {
                    const doc = balanceSnapshot.docs[0];
                    currentBalance = doc.data().balance || 0;
                }
                
                const newBalance = currentBalance + netDebtChange;

                await setDoc(balanceDocRef, {
                    balance: newBalance,
                    currency: currency,
                    lastUpdated: serverTimestamp(),
                }, { merge: true });

                // é‡è¨­è¡¨å–®
                expenseForm.reset();
                document.getElementById('recordDate').valueAsDate = new Date();
                splitTypeSelect.value = 'equal';
                customSplitFields.classList.add('hidden');
                totalAmountInput.focus();

            } catch (error) {
                handleFirebaseError(error, 'å„²å­˜ç´€éŒ„');
            }
        });
        
        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œé è¨­åŸ·è¡Œä¸€æ¬¡è‡ªè¨‚é‡‘é¡æ›´æ–°ï¼ˆä»¥é˜²ç¸½é‡‘é¡æœ‰å€¼ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            updateCustomSplit(totalAmountInput);
        });

    </script>
</body>
</html>

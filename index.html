import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  query, 
  onSnapshot, 
  addDoc, 
  setDoc, 
  doc,
  deleteDoc,
  Timestamp,
  setLogLevel
} from 'firebase/firestore';

// 確保全域變數存在，以便在 Canvas 環境中運行
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// 定義 Firestore 資料結構的 TypeScript 介面，以提供更好的類型檢查
/**
 * @typedef {object} Expense
 * @property {string} id
 * @property {string} description
 * @property {number} amount
 * @property {string} paidBy
 * @property {string} sharedWith
 * @property {number} timestamp
 */

/**
 * @typedef {object} UserShare
 * @property {string} userId
 * @property {string} name
 */

// 預設的費用分攤選項
const SHARING_OPTIONS = [
  { id: 'all', name: '均攤' },
  { id: 'me', name: '僅限自己' },
  // 可以在這裡添加更多選項
];

// 預設的付款人選項
const PAID_BY_OPTIONS = [
  { id: 'me', name: '我' },
  // 可以在這裡添加其他家庭成員/用戶
];

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [expenses, setExpenses] = useState([]);

  const [newExpense, setNewExpense] = useState({
    description: '',
    amount: '',
    paidBy: PAID_BY_OPTIONS[0].id,
    sharedWith: SHARING_OPTIONS[0].id,
  });

  // 1. Firebase 初始化和認證
  useEffect(() => {
    if (!firebaseConfig) {
      setError("Firebase 設定未提供。請在 Canvas 環境中執行。");
      setLoading(false);
      return;
    }

    try {
      // 設置 Firestore 日誌級別為 Debug 以協助除錯 (建議在開發時開啟)
      // setLogLevel('debug'); 
      
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);
      
      setDb(firestore);
      setAuth(authInstance);

      // 設置身份驗證狀態變化的監聽器
      const unsubscribe = onAuthStateChanged(authInstance, (user) => {
        if (user) {
          // 用戶已登入 (無論是使用 Custom Token 還是匿名登入)
          setUserId(user.uid);
        } else {
          // 用戶已登出
          setUserId(null);
        }
        setIsAuthReady(true);
        setLoading(false);
      });

      // 處理初始登入 (使用 Custom Token 或匿名登入)
      const handleSignIn = async () => {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(authInstance, initialAuthToken);
          } else {
            await signInAnonymously(authInstance);
          }
        } catch (e) {
          console.error("Firebase 登入失敗:", e);
          setError("登入失敗。請檢查 Firebase 專案設定。");
        }
      };

      handleSignIn();

      // 清理函數：在元件卸載時取消監聽
      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase 初始化失敗:", e);
      setError(`初始化失敗: ${e.message}`);
      setLoading(false);
    }
  }, []); // 只運行一次

  // 2. 資料庫連線和即時資料監聽 (onSnapshot)
  useEffect(() => {
    // 只有在 Firebase 服務和用戶 ID 都準備好後才開始監聽
    if (!db || !isAuthReady || !userId) {
      return;
    }

    // Firestore 路徑： /artifacts/{appId}/public/data/expenses
    // 這是公共資料路徑，所有用戶共享相同的費用清單
    const expensesCollectionPath = `artifacts/${appId}/public/data/expenses`;
    const q = query(collection(db, expensesCollectionPath));

    // 使用 onSnapshot 實現即時更新
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedExpenses = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      // 按照時間戳記降序排序，最新的費用排在最前面
      fetchedExpenses.sort((a, b) => b.timestamp - a.timestamp);
      setExpenses(fetchedExpenses);
    }, (e) => {
      console.error("Firestore 連線或監聽失敗:", e);
      // 發生錯誤時，可能是因為規則不允許讀取。
      // 但我們已要求使用者設置了開放規則，所以通常是連線問題。
      setError(`資料讀取失敗: ${e.message}. 請檢查您的 Firestore 安全規則。`);
    });

    // 清理函數：在 db, isAuthReady 或 userId 變化時取消監聽
    return () => unsubscribe();
  }, [db, isAuthReady, userId]);

  // 處理表單輸入變化
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewExpense(prev => ({
      ...prev,
      [name]: name === 'amount' ? parseFloat(value) || 0 : value,
    }));
  };

  // 將新費用添加到 Firestore
  const addExpense = useCallback(async () => {
    if (!db || !userId) {
      alert("資料庫未準備好或用戶未登入。");
      return;
    }

    if (newExpense.description.trim() === '' || newExpense.amount <= 0) {
      alert("請輸入有效的費用說明和金額。");
      return;
    }

    try {
      const dataToSave = {
        description: newExpense.description.trim(),
        amount: newExpense.amount,
        paidBy: newExpense.paidBy,
        sharedWith: newExpense.sharedWith,
        timestamp: Date.now(), // 使用 JavaScript 時間戳記 (毫秒)
        userId: userId, // 記錄創建此費用的用戶 ID
        userName: `User ${userId.slice(0, 4)}`, // 簡短的用戶名稱用於顯示
      };

      const expensesCollectionPath = `artifacts/${appId}/public/data/expenses`;
      await addDoc(collection(db, expensesCollectionPath), dataToSave);

      // 清除表單
      setNewExpense({
        description: '',
        amount: '',
        paidBy: PAID_BY_OPTIONS[0].id,
        sharedWith: SHARING_OPTIONS[0].id,
      });

    } catch (e) {
      console.error("新增費用失敗:", e);
      setError(`新增費用失敗: ${e.message}`);
    }
  }, [db, userId, newExpense, appId]);

  // 刪除費用
  const deleteExpense = useCallback(async (expenseId) => {
    if (!db) return;

    // 替換原生 confirm()
    if (!window.confirm('確定要刪除這筆費用嗎？')) {
      return;
    }

    try {
      const expenseDocPath = `artifacts/${appId}/public/data/expenses/${expenseId}`;
      await deleteDoc(doc(db, expenseDocPath));
    } catch (e) {
      console.error("刪除費用失敗:", e);
      setError(`刪除費用失敗: ${e.message}`);
    }
  }, [db, appId]);


  // 3. 核心計算邏輯
  const { totalExpenditure, userOwes, userPaid } = useMemo(() => {
    let totalExpenditure = 0;
    let userOwes = 0; // 用戶應負擔的金額
    let userPaid = 0; // 用戶已支付的金額

    expenses.forEach(expense => {
      totalExpenditure += expense.amount;

      // 計算用戶已支付
      if (expense.paidBy === 'me') {
        userPaid += expense.amount;
      }

      // 簡化計算：只處理 'all' 和 'me' 的分攤邏輯
      let shareFactor = 0;
      if (expense.sharedWith === 'all') {
        // 假設 'all' 分攤給 2 人 (用戶自己 + 另一個假設的用戶)
        shareFactor = 1 / 2;
      } else if (expense.sharedWith === 'me') {
        shareFactor = 1; // 僅自己負擔
      }
      
      userOwes += expense.amount * shareFactor;
    });

    // 淨結算：如果為正，表示用戶應收款；如果為負，表示用戶應付款
    const netBalance = userPaid - userOwes;

    return {
      totalExpenditure,
      userOwes,
      userPaid,
      netBalance
    };
  }, [expenses]);


  // 處理載入和錯誤狀態的 UI
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
        <div className="text-xl font-semibold">載入中... 正在建立 Firebase 連線...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-red-400 p-8">
        <div className="text-2xl font-bold mb-4">連線錯誤</div>
        <pre className="bg-gray-800 p-4 rounded-lg text-sm whitespace-pre-wrap max-w-lg">{error}</pre>
        <p className="mt-4 text-gray-400">請檢查瀏覽器控制台中的詳細錯誤訊息，並確認 Firebase 規則已正確發佈。</p>
      </div>
    );
  }

  // 格式化金額
  const formatCurrency = (amount) => {
    return `${amount.toFixed(2)} TWD`;
  };

  const netBalance = userPaid - userOwes;

  const statusText = isAuthReady && userId 
    ? "連線狀態：Firestore 已連線"
    : "連線狀態：初始化錯誤或登入中";
  
  const statusColor = isAuthReady && userId ? "text-green-400" : "text-yellow-400";


  return (
    <div className="min-h-screen bg-gray-900 text-white font-sans p-4 sm:p-8">
      
      {/* 標題與狀態 */}
      <header className="max-w-4xl mx-auto mb-8 text-center">
        <h1 className="text-4xl sm:text-5xl font-extrabold text-indigo-400 tracking-tight">家庭收支分攤計算器 (HnM Splitter)</h1>
        <p className={`mt-4 text-sm font-medium ${statusColor}`}>
          {statusText} | 用戶 ID: {userId || 'N/A'}
        </p>
        <p className="text-xs text-gray-500 mt-1">
          此 ID 用於共享資料，請記住或告知您的夥伴。
        </p>
      </header>

      {/* 新增費用區塊 */}
      <section className="max-w-2xl mx-auto p-6 bg-gray-800 rounded-xl shadow-2xl mb-10">
        <h2 className="text-2xl font-bold mb-6 text-indigo-300">新增一筆費用</h2>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          
          {/* 費用說明 */}
          <div className="col-span-1 sm:col-span-2">
            <label htmlFor="description" className="block text-sm font-medium text-gray-400 mb-1">費用說明 (例如: 晚餐外送)</label>
            <input
              type="text"
              id="description"
              name="description"
              value={newExpense.description}
              onChange={handleInputChange}
              placeholder="輸入費用說明"
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white"
            />
          </div>

          {/* 金額 */}
          <div>
            <label htmlFor="amount" className="block text-sm font-medium text-gray-400 mb-1">金額 (TWD)</label>
            <input
              type="number"
              id="amount"
              name="amount"
              value={newExpense.amount}
              onChange={handleInputChange}
              placeholder="0.00"
              min="0.01"
              step="0.01"
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white"
            />
          </div>
          
          {/* 付款人 */}
          <div>
            <label htmlFor="paidBy" className="block text-sm font-medium text-gray-400 mb-1">付款人</label>
            <select
              id="paidBy"
              name="paidBy"
              value={newExpense.paidBy}
              onChange={handleInputChange}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white appearance-none"
            >
              {PAID_BY_OPTIONS.map(option => (
                <option key={option.id} value={option.id}>{option.name}</option>
              ))}
            </select>
          </div>
          
          {/* 分攤對象 */}
          <div>
            <label htmlFor="sharedWith" className="block text-sm font-medium text-gray-400 mb-1">分攤對象</label>
            <select
              id="sharedWith"
              name="sharedWith"
              value={newExpense.sharedWith}
              onChange={handleInputChange}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white appearance-none"
            >
              {SHARING_OPTIONS.map(option => (
                <option key={option.id} value={option.id}>{option.name}</option>
              ))}
            </select>
          </div>
          
          {/* 送出按鈕 */}
          <div className="col-span-1 sm:col-span-2 flex justify-end mt-2">
            <button
              onClick={addExpense}
              className="w-full sm:w-auto px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-200"
              disabled={newExpense.description.trim() === '' || newExpense.amount <= 0}
            >
              新增費用
            </button>
          </div>
        </div>
      </section>

      {/* 結算結果區塊 */}
      <section className="max-w-4xl mx-auto mb-10 p-6 bg-gray-800 rounded-xl shadow-2xl">
        <h2 className="text-2xl font-bold mb-6 text-indigo-300">費用明細與結算</h2>

        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
          <div className="p-4 bg-gray-700 rounded-lg shadow-inner">
            <p className="text-sm text-gray-400">總支出</p>
            <p className="text-2xl font-bold text-yellow-300 mt-1">{formatCurrency(totalExpenditure)}</p>
          </div>
          <div className="p-4 bg-gray-700 rounded-lg shadow-inner">
            <p className="text-sm text-gray-400">我的份額 (應付)</p>
            <p className="text-2xl font-bold text-red-400 mt-1">{formatCurrency(userOwes)}</p>
          </div>
          <div className={`p-4 rounded-lg shadow-inner ${netBalance >= 0 ? 'bg-green-800/50' : 'bg-red-800/50'}`}>
            <p className="text-sm text-gray-300">結算結果</p>
            <p className="text-2xl font-bold mt-1">
              {netBalance >= 0 ? 
                <span className="text-green-400">應收 {formatCurrency(netBalance)}</span> : 
                <span className="text-red-400">應付 {formatCurrency(Math.abs(netBalance))}</span>
              }
            </p>
          </div>
        </div>
      </section>

      {/* 費用清單 */}
      <section className="max-w-4xl mx-auto p-6 bg-gray-800 rounded-xl shadow-2xl">
        <h3 className="text-xl font-bold mb-4 text-indigo-300">費用清單 ({expenses.length} 筆)</h3>
        
        {expenses.length === 0 ? (
          <p className="text-gray-400 text-center py-8">目前沒有費用記錄。</p>
        ) : (
          <div className="space-y-3">
            {expenses.map((expense) => (
              <div 
                key={expense.id} 
                className="flex justify-between items-center p-4 bg-gray-700 rounded-lg shadow-md transition duration-150 hover:bg-gray-600"
              >
                <div className="flex-1 min-w-0">
                  <p className="text-lg font-semibold text-white truncate">{expense.description}</p>
                  <div className="text-sm text-gray-400 space-x-3">
                    <span className="font-mono">{formatCurrency(expense.amount)}</span>
                    <span className="text-xs">| 由 <span className="text-indigo-300 font-medium">{PAID_BY_OPTIONS.find(o => o.id === expense.paidBy)?.name || '未知'}</span> 支付</span>
                    <span className="text-xs">| 分攤給 <span className="text-indigo-300 font-medium">{SHARING_OPTIONS.find(o => o.id === expense.sharedWith)?.name || '未知'}</span></span>
                  </div>
                </div>
                
                <button
                  onClick={() => deleteExpense(expense.id)}
                  className="ml-4 p-2 text-red-400 hover:text-red-500 rounded-full transition duration-150"
                  title="刪除費用"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clipRule="evenodd" />
                  </svg>
                </button>
              </div>
            ))}
          </div>
        )}
      </section>
      
      {/* 底部浮動按鈕 - 替換原生 alert */}
      <div id="custom-alert-container"></div>
    </div>
  );
};

export default App;
